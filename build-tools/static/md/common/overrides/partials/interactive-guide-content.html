<body class="bg-slate-100 text-slate-800">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-800 text-slate-300 p-6 hidden lg:flex flex-col">
            <h1 class="text-2xl font-bold text-white mb-8">Formal Ledger Guide</h1>
            <nav class="flex flex-col space-y-2">
                <a href="#overview" class="sidebar-link active rounded-lg py-2 px-4">
                    <span class="mr-2">üöÄ</span> Overview
                </a>
                <a href="#getting-started" class="sidebar-link rounded-lg py-2 px-4">
                    <span class="mr-2">üõ†Ô∏è</span> Getting Started
                </a>
                <a href="#environments" class="sidebar-link rounded-lg py-2 px-4">
                    <span class="mr-2">üñ•Ô∏è</span> Dev Environments
                </a>
                <a href="#building" class="sidebar-link rounded-lg py-2 px-4">
                    <span class="mr-2">üèóÔ∏è</span> Building Artifacts
                </a>
                <a href="#ide-setup" class="sidebar-link rounded-lg py-2 px-4">
                    <span class="mr-2">üí°</span> IDE Setup
                </a>
                <a href="#contributing" class="sidebar-link rounded-lg py-2 px-4">
                    <span class="mr-2">ü§ù</span> Contributing
                </a>
            </nav>
            <div class="mt-auto text-xs text-slate-500">
                <p>Interactive guide generated from project documentation.</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 sm:p-6 lg:p-10 overflow-y-auto">

            <!-- Mobile Header -->
            <div class="lg:hidden mb-6">
                <select id="mobile-nav" class="w-full p-3 rounded-lg bg-white border border-slate-300 shadow-sm">
                    <option value="overview">Overview</option>
                    <option value="getting-started">Getting Started</option>
                    <option value="environments">Dev Environments</option>
                    <option value="building">Building Artifacts</option>
                    <option value="ide-setup">IDE Setup</option>
                    <option value="contributing">Contributing</option>
                </select>
            </div>

            <!-- Overview Section -->
            <section id="overview" class="content-section active">
                <h2 class="text-4xl font-bold mb-4">Formal Ledger Specifications</h2>
                <p class="text-lg text-slate-600 mb-8">This repository contains the formal ledger specifications for the Cardano blockchain, written in Agda. This guide provides an interactive way to explore the project's setup, build process, and contribution guidelines.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="font-bold text-xl mb-3">Published Artifacts</h3>
                        <p class="text-slate-600 mb-4">The following official artifacts are generated by our CI pipeline. Note that building PDFs locally is deprecated.</p>
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="border-b">
                                    <th class="py-2">Artifact</th>
                                    <th class="py-2">Link</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b">
                                    <td class="py-2">Full PDF Spec</td>
                                    <td><a href="https://IntersectMBO.github.io/formal-ledger-specifications/cardano-ledger.pdf" target="_blank" class="text-amber-600 hover:underline">cardano-ledger.pdf</a></td>
                                </tr>
                                <tr class="border-b">
                                    <td class="py-2">Conway PDF</td>
                                    <td><a href="https://IntersectMBO.github.io/formal-ledger-specifications/conway-ledger.pdf" target="_blank" class="text-amber-600 hover:underline">conway-ledger.pdf</a></td>
                                </tr>
                                <tr>
                                    <td class="py-2">HTML Source</td>
                                    <td><a href="https://IntersectMBO.github.io/formal-ledger-specifications/html/index.html" target="_blank" class="text-amber-600 hover:underline">Browseable HTML</a></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow">
                        <h3 class="font-bold text-xl mb-3">Core Dependencies</h3>
                        <p class="text-slate-600 mb-4">The project relies on several key Agda libraries, managed by Nix to ensure reproducibility. This chart shows the relative complexity (lines of code) of each dependency.</p>
                        <div class="chart-container h-48 max-h-48">
                            <canvas id="depsChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Getting Started Section -->
            <section id="getting-started" class="content-section">
                <h2 class="text-3xl font-bold mb-4">Getting Started</h2>
                <p class="text-slate-600 mb-6">To begin, you need Nix installed with Flakes enabled. Then, clone the repository and enter the directory.</p>
                <div class="code-block-wrapper">
                    <button class="copy-button" title="Copy to clipboard">üìã Copy</button>
                    <div class="code-block"><pre><code>git clone https://github.com/IntersectMBO/formal-ledger-specifications.git
cd formal-ledger-specifications</code></pre></div>
                </div>
                <h3 class="text-2xl font-bold mt-8 mb-4">First Steps</h3>
                 <p class="text-slate-600 mb-6">The simplest way to start is to enter the development shell, which provides all necessary tools. From there, you can use your favorite editor.</p>
                 <div class="code-block-wrapper">
                    <button class="copy-button" title="Copy to clipboard">üìã Copy</button>
                    <div class="code-block"><pre><code># 1. Enter the default development environment
nix develop

# 2. Work on Agda files in your preferred editor (e.g., Emacs or VS Code)
emacs src/Ledger.agda

# 3. In Emacs, type-check with C-c C-l</code></pre></div>
                </div>
            </section>

            <!-- Environments Section -->
            <section id="environments" class="content-section">
                <h2 class="text-3xl font-bold mb-4">Development Environments</h2>
                <p class="text-slate-600 mb-6">We provide several Nix shells tailored for different tasks. Use `nix develop` to enter them.</p>

                <div class="mb-4 border-b border-slate-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button class="tab-button active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-tab-target="shell-default">Default Shell</button>
                        <button class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700" data-tab-target="shell-docs">Docs Shell</button>
                        <button class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700" data-tab-target="shell-ci">CI Shell</button>
                    </nav>
                </div>

                <div id="shell-default" class="tab-content active">
                    <h3 class="font-bold text-lg mb-2">Default Shell (for Agda Development)</h3>
                    <p class="mb-4">The primary environment for everyday Agda development.</p>
                    <div class="code-block-wrapper mb-4">
                        <button class="copy-button" title="Copy to clipboard">üìã Copy</button>
                        <div class="code-block"><pre><code>nix develop</code></pre></div>
                    </div>
                    <h4 class="font-semibold mb-2">Available Tools:</h4>
                    <ul class="list-disc list-inside bg-slate-200/50 p-4 rounded-lg">
                        <li>`agda`: The Agda compiler with all project libraries.</li>
                        <li>`fls-shake`: Custom Shake-based build system.</li>
                        <li>`python311`: For scripting.</li>
                        <li>`hpack`: Haskell package helper.</li>
                        <li>`coreutils`: Basic shell utilities.</li>
                    </ul>
                </div>
                <div id="shell-docs" class="tab-content hidden">
                    <h3 class="font-bold text-lg mb-2">Documentation Shell</h3>
                    <p class="mb-4">A comprehensive environment for working on the `mkdocs` documentation website.</p>
                    <div class="code-block-wrapper mb-4">
                        <button class="copy-button" title="Copy to clipboard">üìã Copy</button>
                        <div class="code-block"><pre><code>nix develop .#docs</code></pre></div>
                    </div>
                    <h4 class="font-semibold mb-2">Includes Default Shell tools, plus:</h4>
                    <ul class="list-disc list-inside bg-slate-200/50 p-4 rounded-lg">
                        <li>`pandoc`: Document converter.</li>
                        <li>`latex`: A full TeX Live distribution.</li>
                        <li>`mkdocs`: Static site generator with Python dependencies.</li>
                        <li>`mdbook`, `cargo`: For the mdBook ecosystem.</li>
                    </ul>
                </div>
                <div id="shell-ci" class="tab-content hidden">
                    <h3 class="font-bold text-lg mb-2">CI Shell</h3>
                    <p class="mb-4">A minimal environment for automated builds and testing.</p>
                    <div class="code-block-wrapper mb-4">
                        <button class="copy-button" title="Copy to clipboard">üìã Copy</button>
                        <div class="code-block"><pre><code>nix develop .#ci</code></pre></div>
                    </div>
                    <h4 class="font-semibold mb-2">Available Tools:</h4>
                     <ul class="list-disc list-inside bg-slate-200/50 p-4 rounded-lg">
                        <li>`fls-shake`: The core build system.</li>
                        <li>Runtime dependencies for building artifacts.</li>
                    </ul>
                </div>
            </section>

            <!-- Building Section -->
            <section id="building" class="content-section">
                <h2 class="text-3xl font-bold mb-4">Building Artifacts</h2>
                <p class="text-slate-600 mb-6">The recommended way to build is with `nix build`. Alternatively, for more granular control, use `fls-shake` inside a development shell.</p>

                <div class="mb-4 border-b border-slate-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button class="tab-button active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-tab-target="build-flakes">Using Nix Flakes</button>
                        <button class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700" data-tab-target="build-shake">Using fls-shake</button>
                    </nav>
                </div>

                <div id="build-flakes" class="tab-content active">
                    <p class="mb-4">Use these commands from the project root. Outputs will be in the `result/` symlink.</p>
                    <div class="code-block-wrapper">
                        <button class="copy-button" title="Copy to clipboard">üìã Copy</button>
                        <div class="code-block"><pre><code># Type-check the Agda specification (default package)
nix build .#formal-ledger

# Generate Haskell source code for conformance testing
nix build .#hs-src

# Generate browseable HTML documentation
nix build .#html

# Build the mkdocs site
nix build .#mkdocs</code></pre></div>
                    </div>
                </div>

                <div id="build-shake" class="tab-content hidden">
                    <p class="mb-4">First, enter a dev shell (`nix develop`), then run these commands.</p>
                    <div class="code-block-wrapper">
                        <button class="copy-button" title="Copy to clipboard">üìã Copy</button>
                        <div class="code-block"><pre><code># Build HTML docs
fls-shake html

# Build Haskell source
fls-shake hs

# See all available targets
fls-shake --help</code></pre></div>
                    </div>
                     <div class="mt-4 p-4 bg-amber-100 border-l-4 border-amber-500 text-amber-700 rounded-r-lg">
                        <p><span class="font-bold">Note:</span> Building PDFs with `fls-shake` is deprecated and may not work.</p>
                    </div>
                </div>
            </section>

            <!-- IDE Setup Section -->
            <section id="ide-setup" class="content-section">
                <h2 class="text-3xl font-bold mb-4">IDE Integration</h2>
                <p class="text-slate-600 mb-6">For the best experience, configure your editor to use the project's specific Agda version. First, create a stable symlink to it:</p>
                <div class="code-block-wrapper mb-8">
                    <button class="copy-button" title="Copy to clipboard">üìã Copy</button>
                    <div class="code-block"><pre><code>nix-build -A agdaWithPackages -o ~/ledger-agda</code></pre></div>
                </div>

                <div class="mb-4 border-b border-slate-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button class="tab-button active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-tab-target="ide-emacs">Emacs</button>
                        <button class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-slate-700" data-tab-target="ide-vscode">VS Code</button>
                    </nav>
                </div>

                <div id="ide-emacs" class="tab-content active">
                    <h3 class="font-bold text-lg mb-2">Emacs Setup</h3>
                    <p class="mb-4">For a setup that allows switching between system Agda and the project's Agda, add this to your `init.el` file.</p>
                    <div class="code-block-wrapper">
                        <button class="copy-button" title="Copy to clipboard">üìã Copy</button>
                        <div class="code-block"><pre><code>;; Defines a function to switch between Agda versions.
(setq my/agda-versions `(("System Agda"  "2.6.4" "agda")  ; Adjust version as needed
                         ("Ledger Agda"  "2.7.0.1" "~/ledger-agda/bin/agda")))
(setq my/selected-agda (caar my/agda-versions))

(defun my/switch-agda (name version path)
  (interactive
   (cond ((> (length my/agda-versions) 2)
          (assoc (completing-read "Agda: " my/agda-versions '(lambda (x) 't) 't) my/agda-versions))
         ((= (length my/agda-versions) 2)
          (car (seq-filter '(lambda (x) (not (string= my/selected-agda (car x)))) my/agda-versions)))
         (t (error "my/agda-versions needs at least two elements!"))))
  (message "Selecting %s, version %s" name version)
  (setq my/selected-agda   name
        agda2-version      version
        agda2-program-name path)
  (agda2-restart))

;; Bind the switch function to C-c C-x C-t in agda2-mode
(with-eval-after-load 'agda2-mode
  (define-key agda2-mode-map (kbd "C-c C-x C-t") 'my/switch-agda))</code></pre></div>
                    </div>
                </div>

                <div id="ide-vscode" class="tab-content hidden">
                    <h3 class="font-bold text-lg mb-2">Visual Studio Code Setup</h3>
                    <ol class="list-decimal list-inside space-y-4">
                        <li>Install the official <strong>Agda Language Server</strong> extension from the marketplace.</li>
                        <li>
                            Open your `settings.json` (`Ctrl+Shift+P` > "Preferences: Open User Settings (JSON)") and add the path to the symlink.
                            <div class="code-block-wrapper mt-2">
                                <button class="copy-button" title="Copy to clipboard">üìã Copy</button>
                                <div class="code-block"><pre><code>{
  "agdaMode.connection.paths": [
    "~/ledger-agda/bin/agda", // Add this line
    "agda"
  ]
}</code></pre></div>
                            </div>
                            <p class="text-sm text-slate-600 mt-2">Note: You may need to use the full path instead of `~`, e.g., `/home/user/ledger-agda/bin/agda`.</p>
                        </li>
                        <li>Use `Ctrl+C Ctrl+R` to switch between configured Agda versions.</li>
                    </ol>
                </div>
            </section>

            <!-- Contributing Section -->
            <section id="contributing" class="content-section">
                <h2 class="text-3xl font-bold mb-4">Contributing Guidelines</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="font-semibold text-lg mb-2">Style Guide</h3>
                        <p>We follow the <a href="https://github.com/agda/agda-stdlib/blob/master/notes/style-guide.md" target="_blank" class="text-amber-600 hover:underline">Agda standard library style guide</a> where reasonable. Since some code is rendered into PDFs, PDF formatting takes priority.</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-2">CI/CD Workflow</h3>
                        <p>Our CI pipeline in `.github/workflows/` automates artifact builds. It uses caching to speed up jobs and creates `<branch-name>-artifacts` branches to store build outputs. The CI uses a special `legacy-latex-artifacts` branch to publish PDFs, as local PDF building is deprecated.</p>
                    </div>
                     <div>
                        <h3 class="font-semibold text-lg mb-2">Working on Agda Libraries</h3>
                        <p>To work on a dependency simultaneously with this project:</p>
                        <ol class="list-decimal list-inside mt-2 space-y-1">
                            <li>Remove the library from `formal-ledger.agda-lib`.</li>
                            <li>Add its local path to the `include:` section of that file.</li>
                            <li>When done, push changes and run `niv update <dependency>` to pin the new version.</li>
                        </ol>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-2">Getting Help</h3>
                        <p>If you encounter problems, please check the `TROUBLESHOOTING.md` file first. If you're still stuck, please <a href="https://github.com/IntersectMBO/formal-ledger-specifications/issues/new/choose" target="_blank" class="text-amber-600 hover:underline">open a New Issue</a>.</p>
                    </div>
                </div>
            </section>

        </main>
    </div>
</body>
