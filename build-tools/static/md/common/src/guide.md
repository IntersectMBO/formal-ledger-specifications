# Interactive Project Guide

This guide provides an interactive way to explore the project's setup, build process, and contribution guidelines.

## Overview

-   #### Published Artifacts

    The following official artifacts are generated by our CI pipeline. Note that building PDFs locally is deprecated.

    | Artifact | Link |
    |---|---|
    | Full PDF Spec | [cardano-ledger.pdf](https://IntersectMBO.github.io/formal-ledger-specifications/cardano-ledger.pdf) |
    | Conway PDF | [conway-ledger.pdf](https://IntersectMBO.github.io/formal-ledger-specifications/conway-ledger.pdf) |
    | HTML Source | [Browseable HTML](https://IntersectMBO.github.io/formal-ledger-specifications/html/index.html) |

-   #### Core Dependencies

    The project relies on several key Agda libraries, managed by Nix. This chart shows the relative complexity of each dependency.

    <div class="chart-container" style="position: relative; height:200px; width:100%; max-width:500px; margin: auto;">
        <canvas id="depsChart"></canvas>
    </div>

## Getting Started

To begin, you need Nix installed with Flakes enabled. Then, clone the repository and enter the directory.

```bash
git clone https://github.com/IntersectMBO/formal-ledger-specifications.git
cd formal-ledger-specifications
```

### First Steps

The simplest way to start is to enter the development shell, which provides all necessary tools. From there, you can use your favorite editor.

1.  Enter the default development environment.

    ```
    nix develop
    ```

2.  Work on Agda files in your preferred editor, e.g., 

    ```
    emacs src/Ledger.agda
    ```

3. In Emacs, type-check with `C-c` `C-l`.


## Development Environments

We provide several Nix shells tailored for different tasks. Use `nix develop` to enter them.

=== "Default Shell"

    The primary environment for everyday Agda development.

    ```bash
    nix develop
    ```

    **Available Tools:**

    * `agda`: The Agda compiler with all project libraries.
    * `fls-shake`: Custom Shake-based build system.
    * `python311`: For scripting.
    * `hpack`: Haskell package helper.
    * `coreutils`: Basic shell utilities.

=== "Docs Shell"

    A comprehensive environment for working on the `mkdocs` documentation website.

    ```bash
    nix develop .#docs
    ```

    **Includes Default Shell tools, plus:**

    * `pandoc`: Document converter.
    * `latex`: A full TeX Live distribution.
    * `mkdocs`: Static site generator with Python dependencies.
    * `mdbook`, `cargo`: For the mdBook ecosystem.

=== "CI Shell"

    A minimal environment for automated builds and testing.

    ```bash
    nix develop .#ci
    ```

    **Available Tools:**

    * `fls-shake`: The core build system.
    * Runtime dependencies for building artifacts.


##  Building Artifacts

The recommended way to build is with nix build. Alternatively, for more granular control, use fls-shake inside a development shell.

=== "Using Nix Flakes"

    Use these commands from the project root. Outputs will be in the `result/` symlink.

    ```bash
    # Type-check the Agda specification (default package)
    nix build .#formal-ledger

    # Generate Haskell source code for conformance testing
    nix build .#hs-src

    # Generate browseable HTML documentation
    nix build .#html

    # Build the mkdocs site
    nix build .#mkdocs
    ```

=== "Using fls-shake"

    First, enter a dev shell (`nix develop`), then run these commands.

    ```bash
    # Build HTML docs
    fls-shake html

    # Build Haskell source
    fls-shake hs

    # See all available targets
    fls-shake --help
    ```
    **Note:** Building PDFs with `fls-shake` is deprecated and may not work.

## IDE Integration

For the best experience, configure your editor to use the project's specific Agda version. First, create a stable symlink to it:

```
nix-build -A agdaWithPackages -o ~/ledger-agda
```

=== "Emacs"

    For a setup that allows switching between system Agda and the project's Agda, add this to your `init.el` file.

    ```elisp
    ;; Defines a function to switch between Agda versions.
    (setq my/agda-versions `(("System Agda"  "2.6.4" "agda")  ; Adjust version as needed
                             ("Ledger Agda"  "2.7.0.1" "~/ledger-agda/bin/agda")))
    (setq my/selected-agda (caar my/agda-versions))

    (defun my/switch-agda (name version path)
      (interactive
       (cond ((> (length my/agda-versions) 2)
              (assoc (completing-read "Agda: " my/agda-versions '(lambda (x) 't) 't) my/agda-versions))
             ((= (length my/agda-versions) 2)
              (car (seq-filter '(lambda (x) (not (string= my/selected-agda (car x)))) my/agda-versions)))
             (t (error "my/agda-versions needs to have at least two elements!"))))
      (message "Selecting %s, version %s" name version)
      (setq my/selected-agda   name
            agda2-version      version
            agda2-program-name path)
      (agda2-restart))

    ;; Bind the switch function to C-c C-x C-t in agda2-mode
    (with-eval-after-load 'agda2-mode
      (define-key agda2-mode-map (kbd "C-c C-x C-t") 'my/switch-agda))
    ```

=== "VS Code"

    1.  Install the official **Agda Language Server** extension.

    2.  Open your `settings.json` and add the path to the symlink.
        ```json
        {
          "agdaMode.connection.paths": [
            "~/ledger-agda/bin/agda", // Add this line
            "agda"
          ]
        }
        ```
        **Note**. You may need to use the full path instead of `~`.

    3.  Use `Ctrl+C Ctrl+R` to switch between configured Agda versions.


## Contributing Guidelines

See also our [Contributing Guide][].

+  **Style Guide**

     We follow the [Agda standard library style guide][] as much as reasonable. Since
     some of our code is rendered into PDF, the formatting of the PDF takes priority
     over code formatting, so deviations are expected.

+  **Getting Help**

     If you encounter problems, please check the [Troubleshooting Guide][].
     If your issue is not listed, please [submit a new issue][] in this repository.



[Agda standard library style guide]: https://github.com/agda/agda-stdlib/blob/master/notes/style-guide.md
[submit a new issue]: https://github.com/IntersectMBO/formal-ledger-specifications/issues/new/choose
[Contributing Guide]: https://github.com/IntersectMBO/formal-ledger-specifications/blob/master/CONTRIBUTING.md
[Troubleshooting Guide]: https://github.com/IntersectMBO/formal-ledger-specifications/blob/master/TROUBLESHOOTING.md
