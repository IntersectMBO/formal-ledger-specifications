<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Ledger.Conway.Fees</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css"><link rel="stylesheet" href="Agda.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js"></script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js"></script><script src="AgdaKaTeX.js" defer=""></script></head><body><pre class="Agda">

<a id="3" class="Symbol">{-#</a> <a id="7" class="Keyword">OPTIONS</a> <a id="15" class="Pragma">--safe</a> <a id="22" class="Symbol">#-}</a>

<a id="27" class="Keyword">open</a> <a id="32" class="Keyword">import</a> <a id="39" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a> <a id="54" class="Keyword">hiding</a> <a id="61" class="Symbol">(</a><a id="62" href="Data.Nat.Base.html#7285" class="Function Operator">_%_</a><a id="65" class="Symbol">;</a> <a id="67" href="Agda.Builtin.Nat.html#539" class="Primitive Operator">_*_</a><a id="70" class="Symbol">;</a> <a id="72" href="Class.HasOrder.Core.html#995" class="Function">≤-trans</a><a id="79" class="Symbol">;</a> <a id="81" href="Ledger.Prelude.html#2304" class="Function Operator">∣_∣</a><a id="84" class="Symbol">)</a>
<a id="86" class="Keyword">open</a> <a id="91" class="Keyword">import</a> <a id="98" href="Ledger.Conway.Abstract.html" class="Module">Ledger.Conway.Abstract</a>
<a id="121" class="Keyword">open</a> <a id="126" class="Keyword">import</a> <a id="133" href="Ledger.Conway.Transaction.html" class="Module">Ledger.Conway.Transaction</a>

<a id="160" class="Keyword">module</a> <a id="167" href="Ledger.Conway.Fees.html" class="Module">Ledger.Conway.Fees</a>
  <a id="188" class="Symbol">(</a><a id="189" href="Ledger.Conway.Fees.html#189" class="Bound">txs</a> <a id="193" class="Symbol">:</a> <a id="195" class="Symbol">_)</a> <a id="198" class="Symbol">(</a><a id="199" class="Keyword">open</a> <a id="204" href="Ledger.Conway.Transaction.html#872" class="Module">TransactionStructure</a> <a id="225" href="Ledger.Conway.Fees.html#189" class="Bound">txs</a><a id="228" class="Symbol">)</a>
  <a id="232" class="Keyword">where</a>

<a id="239" class="Keyword">open</a> <a id="244" class="Keyword">import</a> <a id="251" href="Data.Rational.html" class="Module">Data.Rational</a> <a id="265" class="Keyword">using</a> <a id="271" class="Symbol">(</a><a id="272" href="Data.Rational.Base.html#4325" class="Function">0ℚ</a><a id="274" class="Symbol">;</a> <a id="276" href="Data.Rational.Base.html#1342" class="Record">ℚ</a><a id="277" class="Symbol">;</a> <a id="279" href="Data.Rational.Base.html#1960" class="Function">mkℚ+</a><a id="283" class="Symbol">;</a> <a id="285" href="Data.Rational.Base.html#6315" class="Function Operator">_*_</a><a id="288" class="Symbol">;</a> <a id="290" href="Data.Rational.Base.html#7116" class="Function">floor</a><a id="295" class="Symbol">)</a>
<a id="297" class="Keyword">open</a> <a id="302" class="Keyword">import</a> <a id="309" href="Data.Rational.Literals.html" class="Module">Data.Rational.Literals</a> <a id="332" class="Keyword">using</a> <a id="338" class="Symbol">(</a><a id="339" href="Data.Rational.Literals.html#740" class="Function">number</a><a id="345" class="Symbol">)</a>
<a id="347" class="Keyword">open</a> <a id="352" class="Keyword">import</a> <a id="359" href="Ledger.Conway.Types.Numeric.html" class="Module">Ledger.Conway.Types.Numeric</a>
<a id="387" class="Keyword">open</a> <a id="392" class="Keyword">import</a> <a id="399" href="Data.Nat.Induction.html" class="Module">Data.Nat.Induction</a> <a id="418" class="Keyword">using</a> <a id="424" class="Symbol">(</a><a id="425" href="Data.Nat.Induction.html#1604" class="Function">&lt;′-wellFounded</a><a id="439" class="Symbol">)</a>
<a id="441" class="Keyword">open</a> <a id="446" class="Keyword">import</a> <a id="453" href="Data.Nat.Properties.html" class="Module">Data.Nat.Properties</a> <a id="473" class="Keyword">using</a> <a id="479" class="Symbol">(</a><a id="480" href="Data.Nat.Properties.html#65066" class="Function">&lt;⇒&lt;′</a><a id="484" class="Symbol">;</a> <a id="486" href="Data.Nat.Properties.html#9553" class="Function">≰⇒&gt;</a><a id="489" class="Symbol">;</a> <a id="491" href="Data.Nat.Properties.html#47496" class="Function">∸-monoʳ-≤</a><a id="500" class="Symbol">;</a> <a id="502" href="Data.Nat.Properties.html#19842" class="Function">+-monoʳ-≤</a><a id="511" class="Symbol">;</a> <a id="513" href="Data.Nat.Properties.html#8707" class="Function">n≤1+n</a><a id="518" class="Symbol">;</a> <a id="520" href="Data.Nat.Properties.html#51744" class="Function">m+[n∸m]≡n</a><a id="529" class="Symbol">;</a> <a id="531" href="Data.Nat.Properties.html#5699" class="Function">≤-reflexive</a><a id="542" class="Symbol">;</a> <a id="544" href="Data.Nat.Properties.html#5988" class="Function">≤-trans</a><a id="551" class="Symbol">)</a>
<a id="553" class="Keyword">open</a> <a id="558" class="Keyword">import</a> <a id="565" href="Data.Integer.html" class="Module">Data.Integer</a> <a id="578" class="Keyword">using</a> <a id="584" class="Symbol">(</a><a id="585" href="Data.Integer.Base.html#1715" class="Function Operator">∣_∣</a><a id="588" class="Symbol">)</a>
<a id="590" class="Keyword">open</a> <a id="595" class="Keyword">import</a> <a id="602" href="Induction.WellFounded.html" class="Module">Induction.WellFounded</a> <a id="624" class="Keyword">using</a> <a id="630" class="Symbol">(</a><a id="631" href="Induction.WellFounded.html#1356" class="Datatype">Acc</a><a id="634" class="Symbol">;</a> <a id="636" href="Induction.WellFounded.html#1418" class="InductiveConstructor">acc</a><a id="639" class="Symbol">)</a>
<a id="641" class="Keyword">open</a> <a id="646" class="Keyword">import</a> <a id="653" href="Agda.Builtin.FromNat.html" class="Module">Agda.Builtin.FromNat</a> <a id="674" class="Keyword">using</a> <a id="680" class="Symbol">(</a><a id="681" href="Agda.Builtin.FromNat.html#196" class="Record">Number</a><a id="687" class="Symbol">)</a>

<a id="690" class="Keyword">open</a> <a id="695" href="Agda.Builtin.FromNat.html#196" class="Module">Number</a> <a id="702" href="Data.Rational.Literals.html#740" class="Function">number</a> <a id="709" class="Keyword">renaming</a> <a id="718" class="Symbol">(</a><a id="719" href="Agda.Builtin.FromNat.html#281" class="Field">fromNat</a> <a id="727" class="Symbol">to</a> <a id="730" class="Field">fromℕ</a><a id="735" class="Symbol">)</a>



<a id="scriptsCost"></a><a id="740" href="Ledger.Conway.Fees.html#740" class="Function">scriptsCost</a> <a id="752" class="Symbol">:</a> <a id="754" class="Symbol">(</a><a id="755" href="Ledger.Conway.Fees.html#755" class="Bound">pp</a> <a id="758" class="Symbol">:</a> <a id="760" href="Ledger.Conway.PParams.html#1694" class="Record">PParams</a><a id="767" class="Symbol">)</a> <a id="769" class="Symbol">→</a> <a id="771" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="773" class="Symbol">→</a> <a id="775" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="780" href="Ledger.Conway.Fees.html#740" class="Function">scriptsCost</a> <a id="792" href="Ledger.Conway.Fees.html#792" class="Bound">pp</a> <a id="795" href="Ledger.Conway.Fees.html#795" class="Bound">scriptSize</a>
  <a id="808" class="Symbol">=</a> <a id="810" href="Ledger.Conway.Fees.html#1124" class="Function">scriptsCostAux</a> <a id="825" href="Data.Rational.Base.html#4325" class="Function">0ℚ</a> <a id="828" href="Ledger.Conway.Fees.html#929" class="Function">minFeeRefScriptCoinsPerByte</a> <a id="856" href="Ledger.Conway.Fees.html#795" class="Bound">scriptSize</a>


                  <a id="887" class="Symbol">(</a><a id="888" href="Data.Nat.Induction.html#1604" class="Function">&lt;′-wellFounded</a> <a id="903" href="Ledger.Conway.Fees.html#795" class="Bound">scriptSize</a><a id="913" class="Symbol">)</a>


  <a id="919" class="Keyword">where</a>
    <a id="929" href="Ledger.Conway.Fees.html#929" class="Function">minFeeRefScriptCoinsPerByte</a> <a id="957" class="Symbol">=</a> <a id="959" href="Ledger.Conway.PParams.html#2522" class="Field">PParams.minFeeRefScriptCoinsPerByte</a> <a id="995" href="Ledger.Conway.Fees.html#792" class="Bound">pp</a>
    <a id="1002" href="Ledger.Conway.Fees.html#1002" class="Function">refScriptCostMultiplier</a> <a id="1026" class="Symbol">=</a> <a id="1028" href="Ledger.Conway.PParams.html#2691" class="Field">PParams.refScriptCostMultiplier</a> <a id="1060" href="Ledger.Conway.Fees.html#792" class="Bound">pp</a>
    <a id="1067" href="Ledger.Conway.Fees.html#1067" class="Function">refScriptCostStride</a> <a id="1087" class="Symbol">=</a> <a id="1089" href="Ledger.Conway.PParams.html#2648" class="Field">PParams.refScriptCostStride</a> <a id="1117" href="Ledger.Conway.Fees.html#792" class="Bound">pp</a>
    <a id="1124" href="Ledger.Conway.Fees.html#1124" class="Function">scriptsCostAux</a> <a id="1139" class="Symbol">:</a> <a id="1141" href="Data.Rational.Base.html#1342" class="Record">ℚ</a>        <a id="1150" class="Comment">-- accumulator</a>
                   <a id="1184" class="Symbol">→</a> <a id="1186" href="Data.Rational.Base.html#1342" class="Record">ℚ</a>        <a id="1195" class="Comment">-- current tier price</a>
                   <a id="1236" class="Symbol">→</a> <a id="1238" class="Symbol">(</a><a id="1239" href="Ledger.Conway.Fees.html#1239" class="Bound">n</a> <a id="1241" class="Symbol">:</a> <a id="1243" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="1244" class="Symbol">)</a>  <a id="1247" class="Comment">-- remaining script size</a>


                   <a id="1293" class="Symbol">→</a> <a id="1295" href="Induction.WellFounded.html#1356" class="Datatype">Acc</a> <a id="1299" href="Data.Nat.Base.html#7870" class="Function Operator">_&lt;′_</a> <a id="1304" href="Ledger.Conway.Fees.html#1239" class="Bound">n</a>



                   <a id="1328" class="Symbol">→</a> <a id="1330" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
    <a id="1339" href="Ledger.Conway.Fees.html#1124" class="Function">scriptsCostAux</a> <a id="1354" href="Ledger.Conway.Fees.html#1354" class="Bound">acl</a> <a id="1358" href="Ledger.Conway.Fees.html#1358" class="Bound">curTierPrice</a> <a id="1371" href="Ledger.Conway.Fees.html#1371" class="Bound">n</a>



       <a id="1383" class="Symbol">(</a><a id="1384" href="Induction.WellFounded.html#1418" class="InductiveConstructor">acc</a> <a id="1388" href="Ledger.Conway.Fees.html#1388" class="Bound">rs</a><a id="1390" class="Symbol">)</a>



       <a id="1402" class="Symbol">=</a> <a id="1404" href="Function.Base.html#4042" class="Function Operator">case</a>  <a id="1410" href="Ledger.Conway.Fees.html#1371" class="Bound">n</a> <a id="1412" href="Class.HasOrder.Core.html#1011" class="Function Operator">≤?</a> <a id="1415" href="Ledger.Conway.Types.Numeric.html#230" class="Function">fromℕ⁺</a> <a id="1422" href="Ledger.Conway.Fees.html#1067" class="Function">refScriptCostStride</a> <a id="1442" href="Function.Base.html#4042" class="Function Operator">of</a>


                <a id="1463" class="Symbol">λ</a> <a id="1465" class="Keyword">where</a>



                <a id="1490" class="Symbol">(</a><a id="1491" href="Relation.Nullary.Decidable.Core.html#1994" class="InductiveConstructor">yes</a> <a id="1495" class="Symbol">_)</a>  <a id="1499" class="Symbol">→</a> <a id="1501" href="Data.Integer.Base.html#1715" class="Function Operator">∣</a> <a id="1503" href="Data.Rational.Base.html#7116" class="Function">floor</a> <a id="1509" class="Symbol">(</a><a id="1510" href="Ledger.Conway.Fees.html#1354" class="Bound">acl</a> <a id="1514" href="Class.HasAdd.Core.html#162" class="Field Operator">+</a> <a id="1516" class="Symbol">(</a><a id="1517" href="Ledger.Conway.Fees.html#730" class="Function">fromℕ</a> <a id="1523" href="Ledger.Conway.Fees.html#1371" class="Bound">n</a> <a id="1525" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="1527" href="Ledger.Conway.Fees.html#1358" class="Bound">curTierPrice</a><a id="1539" class="Symbol">))</a> <a id="1542" href="Data.Integer.Base.html#1715" class="Function Operator">∣</a>
                <a id="1560" class="Symbol">(</a><a id="1561" href="Relation.Nullary.Decidable.Core.html#2031" class="InductiveConstructor">no</a>  <a id="1565" href="Ledger.Conway.Fees.html#1565" class="Bound">p</a><a id="1566" class="Symbol">)</a>  <a id="1569" class="Symbol">→</a> <a id="1571" href="Ledger.Conway.Fees.html#1124" class="Function">scriptsCostAux</a>
                             <a id="1615" class="Symbol">(</a><a id="1616" href="Ledger.Conway.Fees.html#1354" class="Bound">acl</a> <a id="1620" href="Class.HasAdd.Core.html#162" class="Field Operator">+</a> <a id="1622" class="Symbol">(</a><a id="1623" href="Ledger.Conway.Fees.html#730" class="Function">fromℕ</a> <a id="1629" class="Symbol">(</a><a id="1630" href="Ledger.Conway.Types.Numeric.html#230" class="Function">fromℕ⁺</a> <a id="1637" href="Ledger.Conway.Fees.html#1067" class="Function">refScriptCostStride</a><a id="1656" class="Symbol">)</a> <a id="1658" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="1660" href="Ledger.Conway.Fees.html#1358" class="Bound">curTierPrice</a><a id="1672" class="Symbol">))</a>
                             <a id="1704" class="Symbol">(</a><a id="1705" href="Ledger.Conway.Fees.html#1002" class="Function">refScriptCostMultiplier</a> <a id="1729" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="1731" href="Ledger.Conway.Fees.html#1358" class="Bound">curTierPrice</a><a id="1743" class="Symbol">)</a>
                             <a id="1774" class="Symbol">(</a><a id="1775" href="Ledger.Conway.Fees.html#1371" class="Bound">n</a> <a id="1777" href="Interface.HasSubtract.html#209" class="Field Operator">-</a> <a id="1779" href="Ledger.Conway.Types.Numeric.html#230" class="Function">fromℕ⁺</a> <a id="1786" href="Ledger.Conway.Fees.html#1067" class="Function">refScriptCostStride</a><a id="1805" class="Symbol">)</a>



                             <a id="1839" class="Symbol">(</a><a id="1840" href="Ledger.Conway.Fees.html#1388" class="Bound">rs</a> <a id="1843" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="1845" href="Data.Nat.Properties.html#65066" class="Function">&lt;⇒&lt;′</a> <a id="1850" class="Symbol">(</a><a id="1851" href="Ledger.Conway.Fees.html#1937" class="Function">suc∸≤</a> <a id="1857" class="Symbol">(</a><a id="1858" href="Data.Nat.Properties.html#5988" class="Function">≤-trans</a> <a id="1866" class="Symbol">(</a><a id="1867" href="Data.Nat.Base.html#1919" class="InductiveConstructor">s&lt;s</a> <a id="1871" href="Data.Nat.Base.html#1720" class="InductiveConstructor">z≤n</a><a id="1874" class="Symbol">)</a> <a id="1876" class="Symbol">(</a><a id="1877" href="Data.Nat.Properties.html#9553" class="Function">≰⇒&gt;</a> <a id="1881" href="Ledger.Conway.Fees.html#1565" class="Bound">p</a><a id="1882" class="Symbol">))</a> <a id="1885" class="Symbol">(</a><a id="1886" href="Ledger.Conway.Types.Numeric.html#283" class="Function">ℕ⁺-&gt;0</a> <a id="1892" href="Ledger.Conway.Fees.html#1067" class="Function">refScriptCostStride</a><a id="1911" class="Symbol">)))</a>


      <a id="1923" class="Keyword">where</a>
        <a id="1937" href="Ledger.Conway.Fees.html#1937" class="Function">suc∸≤</a> <a id="1943" class="Symbol">:</a> <a id="1945" class="Symbol">∀</a> <a id="1947" class="Symbol">{</a><a id="1948" href="Ledger.Conway.Fees.html#1948" class="Bound">n</a> <a id="1950" href="Ledger.Conway.Fees.html#1950" class="Bound">m</a> <a id="1952" class="Symbol">:</a> <a id="1954" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="1955" class="Symbol">}</a> <a id="1957" class="Symbol">→</a> <a id="1959" href="Ledger.Conway.Fees.html#1948" class="Bound">n</a> <a id="1961" href="Class.HasOrder.Core.html#843" class="Function Operator">&gt;</a> <a id="1963" class="Number">0</a> <a id="1965" class="Symbol">→</a> <a id="1967" href="Ledger.Conway.Fees.html#1950" class="Bound">m</a> <a id="1969" href="Class.HasOrder.Core.html#843" class="Function Operator">&gt;</a> <a id="1971" class="Number">0</a> <a id="1973" class="Symbol">→</a> <a id="1975" href="Ledger.Conway.Fees.html#1948" class="Bound">n</a> <a id="1977" href="Data.Nat.Base.html#4462" class="Primitive Operator">∸</a> <a id="1979" href="Ledger.Conway.Fees.html#1950" class="Bound">m</a> <a id="1981" href="Class.HasOrder.Core.html#641" class="Field Operator">&lt;</a> <a id="1983" href="Ledger.Conway.Fees.html#1948" class="Bound">n</a>
        <a id="1993" href="Ledger.Conway.Fees.html#1937" class="Function">suc∸≤</a> <a id="1999" class="Symbol">{</a><a id="2000" href="Ledger.Conway.Fees.html#2000" class="Bound">n</a><a id="2001" class="Symbol">}</a> <a id="2003" class="Symbol">{.</a><a id="2005" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="2009" href="Ledger.Conway.Fees.html#2009" class="Bound">m</a><a id="2010" class="Symbol">}</a> <a id="2012" href="Ledger.Conway.Fees.html#2012" class="Bound">p</a> <a id="2014" class="Symbol">(</a><a id="2015" href="Data.Nat.Base.html#1762" class="InductiveConstructor">s≤s</a> <a id="2019" href="Ledger.Conway.Fees.html#2019" class="Bound">q</a><a id="2020" class="Symbol">)</a> <a id="2022" class="Symbol">=</a> <a id="2024" href="Data.Nat.Properties.html#5988" class="Function">≤-trans</a> <a id="2032" class="Symbol">(</a><a id="2033" href="Data.Nat.Properties.html#19842" class="Function">+-monoʳ-≤</a> <a id="2043" class="Number">1</a> <a id="2045" class="Symbol">(</a><a id="2046" href="Data.Nat.Properties.html#47496" class="Function">∸-monoʳ-≤</a> <a id="2056" href="Ledger.Conway.Fees.html#2000" class="Bound">n</a> <a id="2058" class="Symbol">(</a><a id="2059" href="Data.Nat.Base.html#1919" class="InductiveConstructor">s&lt;s</a> <a id="2063" href="Ledger.Conway.Fees.html#2019" class="Bound">q</a><a id="2064" class="Symbol">)))</a>
                                               <a id="2115" class="Symbol">(</a><a id="2116" href="Data.Nat.Properties.html#5699" class="Function">≤-reflexive</a> <a id="2128" class="Symbol">(</a><a id="2129" href="Data.Nat.Properties.html#51744" class="Function">m+[n∸m]≡n</a> <a id="2139" href="Ledger.Conway.Fees.html#2012" class="Bound">p</a><a id="2140" class="Symbol">))</a>

</pre></body></html>