<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Ledger.Conway.Fees</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css"><link rel="stylesheet" href="Agda.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js"></script><script src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js"></script><script src="AgdaKaTeX.js" defer=""></script></head><body><pre class="Agda">
<a id="2" class="Symbol">{-#</a> <a id="6" class="Keyword">OPTIONS</a> <a id="14" class="Pragma">--safe</a> <a id="21" class="Symbol">#-}</a>

<a id="26" class="Keyword">open</a> <a id="31" class="Keyword">import</a> <a id="38" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a> <a id="53" class="Keyword">hiding</a> <a id="60" class="Symbol">(</a><a id="61" href="Data.Nat.Base.html#7285" class="Function Operator">_%_</a><a id="64" class="Symbol">;</a> <a id="66" href="Agda.Builtin.Nat.html#539" class="Primitive Operator">_*_</a><a id="69" class="Symbol">;</a> <a id="71" href="Class.HasOrder.Core.html#995" class="Function">≤-trans</a><a id="78" class="Symbol">;</a> <a id="80" href="Ledger.Prelude.html#2543" class="Function Operator">∣_∣</a><a id="83" class="Symbol">)</a>
<a id="85" class="Keyword">open</a> <a id="90" class="Keyword">import</a> <a id="97" href="Ledger.Conway.Abstract.html" class="Module">Ledger.Conway.Abstract</a>
<a id="120" class="Keyword">open</a> <a id="125" class="Keyword">import</a> <a id="132" href="Ledger.Conway.Transaction.html" class="Module">Ledger.Conway.Transaction</a>

<a id="159" class="Keyword">module</a> <a id="166" href="Ledger.Conway.Fees.html" class="Module">Ledger.Conway.Fees</a>
  <a id="187" class="Symbol">(</a><a id="188" href="Ledger.Conway.Fees.html#188" class="Bound">txs</a> <a id="192" class="Symbol">:</a> <a id="194" class="Symbol">_)</a> <a id="197" class="Symbol">(</a><a id="198" class="Keyword">open</a> <a id="203" href="Ledger.Conway.Transaction.html#910" class="Module">TransactionStructure</a> <a id="224" href="Ledger.Conway.Fees.html#188" class="Bound">txs</a><a id="227" class="Symbol">)</a>
  <a id="231" class="Keyword">where</a>

<a id="238" class="Keyword">open</a> <a id="243" class="Keyword">import</a> <a id="250" href="Data.Rational.html" class="Module">Data.Rational</a> <a id="264" class="Keyword">using</a> <a id="270" class="Symbol">(</a><a id="271" href="Data.Rational.Base.html#4325" class="Function">0ℚ</a><a id="273" class="Symbol">;</a> <a id="275" href="Data.Rational.Base.html#1342" class="Record">ℚ</a><a id="276" class="Symbol">;</a> <a id="278" href="Data.Rational.Base.html#1960" class="Function">mkℚ+</a><a id="282" class="Symbol">;</a> <a id="284" href="Data.Rational.Base.html#6315" class="Function Operator">_*_</a><a id="287" class="Symbol">;</a> <a id="289" href="Data.Rational.Base.html#7116" class="Function">floor</a><a id="294" class="Symbol">)</a>
<a id="296" class="Keyword">open</a> <a id="301" class="Keyword">import</a> <a id="308" href="Data.Rational.Literals.html" class="Module">Data.Rational.Literals</a> <a id="331" class="Keyword">using</a> <a id="337" class="Symbol">(</a><a id="338" href="Data.Rational.Literals.html#740" class="Function">number</a><a id="344" class="Symbol">)</a>
<a id="346" class="Keyword">open</a> <a id="351" class="Keyword">import</a> <a id="358" href="Data.Nat.Induction.html" class="Module">Data.Nat.Induction</a> <a id="377" class="Keyword">using</a> <a id="383" class="Symbol">(</a><a id="384" href="Data.Nat.Induction.html#1604" class="Function">&lt;′-wellFounded</a><a id="398" class="Symbol">)</a>
<a id="400" class="Keyword">open</a> <a id="405" class="Keyword">import</a> <a id="412" href="Data.Nat.Properties.html" class="Module">Data.Nat.Properties</a> <a id="432" class="Keyword">using</a> <a id="438" class="Symbol">(</a><a id="439" href="Data.Nat.Properties.html#65066" class="Function">&lt;⇒&lt;′</a><a id="443" class="Symbol">;</a> <a id="445" href="Data.Nat.Properties.html#9553" class="Function">≰⇒&gt;</a><a id="448" class="Symbol">;</a> <a id="450" href="Data.Nat.Properties.html#47496" class="Function">∸-monoʳ-≤</a><a id="459" class="Symbol">;</a> <a id="461" href="Data.Nat.Properties.html#19842" class="Function">+-monoʳ-≤</a><a id="470" class="Symbol">;</a> <a id="472" href="Data.Nat.Properties.html#8707" class="Function">n≤1+n</a><a id="477" class="Symbol">;</a> <a id="479" href="Data.Nat.Properties.html#51744" class="Function">m+[n∸m]≡n</a><a id="488" class="Symbol">;</a> <a id="490" href="Data.Nat.Properties.html#5699" class="Function">≤-reflexive</a><a id="501" class="Symbol">;</a> <a id="503" href="Data.Nat.Properties.html#5988" class="Function">≤-trans</a><a id="510" class="Symbol">)</a>
<a id="512" class="Keyword">open</a> <a id="517" class="Keyword">import</a> <a id="524" href="Data.Integer.html" class="Module">Data.Integer</a> <a id="537" class="Keyword">using</a> <a id="543" class="Symbol">(</a><a id="544" href="Data.Integer.Base.html#1715" class="Function Operator">∣_∣</a><a id="547" class="Symbol">)</a>
<a id="549" class="Keyword">open</a> <a id="554" class="Keyword">import</a> <a id="561" href="Induction.WellFounded.html" class="Module">Induction.WellFounded</a> <a id="583" class="Keyword">using</a> <a id="589" class="Symbol">(</a><a id="590" href="Induction.WellFounded.html#1356" class="Datatype">Acc</a><a id="593" class="Symbol">;</a> <a id="595" href="Induction.WellFounded.html#1418" class="InductiveConstructor">acc</a><a id="598" class="Symbol">)</a>
<a id="600" class="Keyword">open</a> <a id="605" class="Keyword">import</a> <a id="612" href="Agda.Builtin.FromNat.html" class="Module">Agda.Builtin.FromNat</a> <a id="633" class="Keyword">using</a> <a id="639" class="Symbol">(</a><a id="640" href="Agda.Builtin.FromNat.html#196" class="Record">Number</a><a id="646" class="Symbol">)</a>

<a id="649" class="Keyword">open</a> <a id="654" href="Agda.Builtin.FromNat.html#196" class="Module">Number</a> <a id="661" href="Data.Rational.Literals.html#740" class="Function">number</a> <a id="668" class="Keyword">renaming</a> <a id="677" class="Symbol">(</a><a id="678" href="Agda.Builtin.FromNat.html#281" class="Field">fromNat</a> <a id="686" class="Symbol">to</a> <a id="689" class="Field">fromℕ</a><a id="694" class="Symbol">)</a>


<a id="scriptsCost"></a><a id="698" href="Ledger.Conway.Fees.html#698" class="Function">scriptsCost</a> <a id="710" class="Symbol">:</a> <a id="712" class="Symbol">(</a><a id="713" href="Ledger.Conway.Fees.html#713" class="Bound">pp</a> <a id="716" class="Symbol">:</a> <a id="718" href="Ledger.Conway.PParams.html#1717" class="Record">PParams</a><a id="725" class="Symbol">)</a> <a id="727" class="Symbol">→</a> <a id="729" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="731" class="Symbol">→</a> <a id="733" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="738" href="Ledger.Conway.Fees.html#698" class="Function">scriptsCost</a> <a id="750" href="Ledger.Conway.Fees.html#750" class="Bound">pp</a> <a id="753" href="Ledger.Conway.Fees.html#753" class="Bound">scriptSize</a>


  <a id="768" class="Keyword">with</a> <a id="773" class="Symbol">(</a><a id="774" href="Ledger.Conway.PParams.html#2671" class="Field">PParams.refScriptCostStride</a> <a id="802" href="Ledger.Conway.Fees.html#750" class="Bound">pp</a><a id="804" class="Symbol">)</a>
<a id="806" class="Symbol">...</a> <a id="810" class="Symbol">|</a> <a id="812" class="Number">0</a> <a id="814" class="Symbol">=</a> <a id="816" class="Number">0</a>  <a id="819" class="Comment">-- This case should never occur; refScriptCostStride should always be &gt; 0.</a>
<a id="894" class="Symbol">...</a> <a id="898" class="Symbol">|</a> <a id="900" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="904" href="Ledger.Conway.Fees.html#904" class="Bound">m</a>


  <a id="910" class="Symbol">=</a> <a id="912" href="Ledger.Conway.Fees.html#1114" class="Function">scriptsCostAux</a> <a id="927" href="Data.Rational.Base.html#4325" class="Function">0ℚ</a> <a id="930" href="Ledger.Conway.PParams.html#2545" class="Function">minFeeRefScriptCoinsPerByte</a> <a id="958" class="Bound">scriptSize</a>


                  <a id="989" class="Symbol">(</a><a id="990" href="Data.Nat.Induction.html#1604" class="Function">&lt;′-wellFounded</a> <a id="1005" class="Bound">scriptSize</a><a id="1015" class="Symbol">)</a>


  <a id="1021" class="Keyword">where</a>
    <a id="1031" class="Keyword">open</a> <a id="1036" href="Ledger.Conway.PParams.html#1717" class="Module">PParams</a> <a id="1044" class="Bound">pp</a> <a id="1047" class="Keyword">hiding</a> <a id="1054" class="Symbol">(</a><a id="1055" href="Ledger.Conway.PParams.html#2671" class="Field">refScriptCostStride</a><a id="1074" class="Symbol">)</a>
    <a id="1080" href="Ledger.Conway.Fees.html#1080" class="Function">refScriptCostStride</a> <a id="1100" class="Symbol">=</a> <a id="1102" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="1106" href="Ledger.Conway.Fees.html#904" class="Bound">m</a>


    <a id="1114" href="Ledger.Conway.Fees.html#1114" class="Function">scriptsCostAux</a> <a id="1129" class="Symbol">:</a> <a id="1131" href="Data.Rational.Base.html#1342" class="Record">ℚ</a>        <a id="1140" class="Comment">-- accumulator</a>
                   <a id="1174" class="Symbol">→</a> <a id="1176" href="Data.Rational.Base.html#1342" class="Record">ℚ</a>        <a id="1185" class="Comment">-- current tier price</a>
                   <a id="1226" class="Symbol">→</a> <a id="1228" class="Symbol">(</a><a id="1229" href="Ledger.Conway.Fees.html#1229" class="Bound">n</a> <a id="1231" class="Symbol">:</a> <a id="1233" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="1234" class="Symbol">)</a>  <a id="1237" class="Comment">-- remaining script size</a>


                   <a id="1283" class="Symbol">→</a> <a id="1285" href="Induction.WellFounded.html#1356" class="Datatype">Acc</a> <a id="1289" href="Data.Nat.Base.html#7870" class="Function Operator">_&lt;′_</a> <a id="1294" href="Ledger.Conway.Fees.html#1229" class="Bound">n</a>


                   <a id="1317" class="Symbol">→</a> <a id="1319" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
    <a id="1328" href="Ledger.Conway.Fees.html#1114" class="Function">scriptsCostAux</a> <a id="1343" href="Ledger.Conway.Fees.html#1343" class="Bound">acl</a> <a id="1347" href="Ledger.Conway.Fees.html#1347" class="Bound">curTierPrice</a> <a id="1360" href="Ledger.Conway.Fees.html#1360" class="Bound">n</a>


      <a id="1370" class="Symbol">(</a><a id="1371" href="Induction.WellFounded.html#1418" class="InductiveConstructor">acc</a> <a id="1375" href="Ledger.Conway.Fees.html#1375" class="Bound">rs</a><a id="1377" class="Symbol">)</a>


        <a id="1389" class="Symbol">=</a> <a id="1391" href="Function.Base.html#4042" class="Function Operator">case</a>  <a id="1397" href="Ledger.Conway.Fees.html#1360" class="Bound">n</a> <a id="1399" href="Class.HasOrder.Core.html#1011" class="Function Operator">≤?</a> <a id="1402" href="Ledger.Conway.Fees.html#1080" class="Function">refScriptCostStride</a> <a id="1422" href="Function.Base.html#4042" class="Function Operator">of</a>


                <a id="1443" class="Symbol">λ</a> <a id="1445" class="Keyword">where</a>


                <a id="1469" class="Symbol">(</a><a id="1470" href="Relation.Nullary.Decidable.Core.html#1994" class="InductiveConstructor">yes</a> <a id="1474" class="Symbol">_)</a>  <a id="1478" class="Symbol">→</a> <a id="1480" href="Data.Integer.Base.html#1715" class="Function Operator">∣</a> <a id="1482" href="Data.Rational.Base.html#7116" class="Function">floor</a> <a id="1488" class="Symbol">(</a><a id="1489" href="Ledger.Conway.Fees.html#1343" class="Bound">acl</a> <a id="1493" href="Class.HasAdd.Core.html#162" class="Field Operator">+</a> <a id="1495" class="Symbol">(</a><a id="1496" href="Ledger.Conway.Fees.html#689" class="Function">fromℕ</a> <a id="1502" href="Ledger.Conway.Fees.html#1360" class="Bound">n</a> <a id="1504" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="1506" href="Ledger.Conway.Fees.html#1347" class="Bound">curTierPrice</a><a id="1518" class="Symbol">))</a> <a id="1521" href="Data.Integer.Base.html#1715" class="Function Operator">∣</a>
                <a id="1539" class="Symbol">(</a><a id="1540" href="Relation.Nullary.Decidable.Core.html#2031" class="InductiveConstructor">no</a>  <a id="1544" href="Ledger.Conway.Fees.html#1544" class="Bound">p</a><a id="1545" class="Symbol">)</a>  <a id="1548" class="Symbol">→</a> <a id="1550" href="Ledger.Conway.Fees.html#1114" class="Function">scriptsCostAux</a> <a id="1565" class="Symbol">(</a><a id="1566" href="Ledger.Conway.Fees.html#1343" class="Bound">acl</a> <a id="1570" href="Class.HasAdd.Core.html#162" class="Field Operator">+</a> <a id="1572" class="Symbol">(</a><a id="1573" href="Ledger.Conway.Fees.html#689" class="Function">fromℕ</a> <a id="1579" href="Ledger.Conway.Fees.html#1080" class="Function">refScriptCostStride</a> <a id="1599" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="1601" href="Ledger.Conway.Fees.html#1347" class="Bound">curTierPrice</a><a id="1613" class="Symbol">))</a>
                                          <a id="1658" class="Symbol">(</a><a id="1659" href="Ledger.Conway.PParams.html#2713" class="Function">refScriptCostMultiplier</a> <a id="1683" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="1685" href="Ledger.Conway.Fees.html#1347" class="Bound">curTierPrice</a><a id="1697" class="Symbol">)</a>
                                          <a id="1741" class="Symbol">(</a><a id="1742" href="Ledger.Conway.Fees.html#1360" class="Bound">n</a> <a id="1744" href="Interface.HasSubtract.html#209" class="Field Operator">-</a> <a id="1746" href="Ledger.Conway.Fees.html#1080" class="Function">refScriptCostStride</a><a id="1765" class="Symbol">)</a>


                                          <a id="1811" class="Symbol">(</a><a id="1812" href="Ledger.Conway.Fees.html#1375" class="Bound">rs</a> <a id="1815" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="1817" href="Data.Nat.Properties.html#65066" class="Function">&lt;⇒&lt;′</a> <a id="1822" class="Symbol">(</a><a id="1823" href="Ledger.Conway.Fees.html#1891" class="Function">suc∸≤</a> <a id="1829" class="Symbol">(</a><a id="1830" href="Data.Nat.Properties.html#5988" class="Function">≤-trans</a> <a id="1838" class="Symbol">(</a><a id="1839" href="Data.Nat.Base.html#1919" class="InductiveConstructor">s&lt;s</a> <a id="1843" href="Data.Nat.Base.html#1720" class="InductiveConstructor">z≤n</a><a id="1846" class="Symbol">)</a> <a id="1848" class="Symbol">(</a><a id="1849" href="Data.Nat.Properties.html#9553" class="Function">≰⇒&gt;</a> <a id="1853" href="Ledger.Conway.Fees.html#1544" class="Bound">p</a><a id="1854" class="Symbol">))</a> <a id="1857" class="Symbol">(</a><a id="1858" href="Data.Nat.Base.html#1762" class="InductiveConstructor">s≤s</a> <a id="1862" href="Data.Nat.Base.html#1720" class="InductiveConstructor">z≤n</a><a id="1865" class="Symbol">)))</a>


      <a id="1877" class="Keyword">where</a>
        <a id="1891" href="Ledger.Conway.Fees.html#1891" class="Function">suc∸≤</a> <a id="1897" class="Symbol">:</a> <a id="1899" class="Symbol">∀</a> <a id="1901" class="Symbol">{</a><a id="1902" href="Ledger.Conway.Fees.html#1902" class="Bound">n</a> <a id="1904" href="Ledger.Conway.Fees.html#1904" class="Bound">m</a> <a id="1906" class="Symbol">:</a> <a id="1908" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="1909" class="Symbol">}</a> <a id="1911" class="Symbol">→</a> <a id="1913" href="Ledger.Conway.Fees.html#1902" class="Bound">n</a> <a id="1915" href="Class.HasOrder.Core.html#843" class="Function Operator">&gt;</a> <a id="1917" class="Number">0</a> <a id="1919" class="Symbol">→</a> <a id="1921" href="Ledger.Conway.Fees.html#1904" class="Bound">m</a> <a id="1923" href="Class.HasOrder.Core.html#843" class="Function Operator">&gt;</a> <a id="1925" class="Number">0</a> <a id="1927" class="Symbol">→</a> <a id="1929" href="Ledger.Conway.Fees.html#1902" class="Bound">n</a> <a id="1931" href="Data.Nat.Base.html#4462" class="Primitive Operator">∸</a> <a id="1933" href="Ledger.Conway.Fees.html#1904" class="Bound">m</a> <a id="1935" href="Class.HasOrder.Core.html#641" class="Field Operator">&lt;</a> <a id="1937" href="Ledger.Conway.Fees.html#1902" class="Bound">n</a>
        <a id="1947" href="Ledger.Conway.Fees.html#1891" class="Function">suc∸≤</a> <a id="1953" class="Symbol">{</a><a id="1954" href="Ledger.Conway.Fees.html#1954" class="Bound">n</a><a id="1955" class="Symbol">}</a> <a id="1957" class="Symbol">{.</a><a id="1959" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="1963" href="Ledger.Conway.Fees.html#1963" class="Bound">m</a><a id="1964" class="Symbol">}</a> <a id="1966" href="Ledger.Conway.Fees.html#1966" class="Bound">p</a> <a id="1968" class="Symbol">(</a><a id="1969" href="Data.Nat.Base.html#1762" class="InductiveConstructor">s≤s</a> <a id="1973" href="Ledger.Conway.Fees.html#1973" class="Bound">q</a><a id="1974" class="Symbol">)</a> <a id="1976" class="Symbol">=</a> <a id="1978" href="Data.Nat.Properties.html#5988" class="Function">≤-trans</a> <a id="1986" class="Symbol">(</a><a id="1987" href="Data.Nat.Properties.html#19842" class="Function">+-monoʳ-≤</a> <a id="1997" class="Number">1</a> <a id="1999" class="Symbol">(</a><a id="2000" href="Data.Nat.Properties.html#47496" class="Function">∸-monoʳ-≤</a> <a id="2010" href="Ledger.Conway.Fees.html#1954" class="Bound">n</a> <a id="2012" class="Symbol">(</a><a id="2013" href="Data.Nat.Base.html#1919" class="InductiveConstructor">s&lt;s</a> <a id="2017" href="Ledger.Conway.Fees.html#1973" class="Bound">q</a><a id="2018" class="Symbol">)))</a>
                                               <a id="2069" class="Symbol">(</a><a id="2070" href="Data.Nat.Properties.html#5699" class="Function">≤-reflexive</a> <a id="2082" class="Symbol">(</a><a id="2083" href="Data.Nat.Properties.html#51744" class="Function">m+[n∸m]≡n</a> <a id="2093" href="Ledger.Conway.Fees.html#1966" class="Bound">p</a><a id="2094" class="Symbol">))</a>

</pre></body></html>