<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Ledger.Rewards</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda">
<a id="2" class="Symbol">{-#</a> <a id="6" class="Keyword">OPTIONS</a> <a id="14" class="Pragma">--safe</a> <a id="21" class="Symbol">#-}</a>

<a id="26" class="Keyword">import</a>      <a id="38" href="Data.Nat.html" class="Module">Data.Nat</a> <a id="47" class="Symbol">as</a> <a id="50" class="Module">ℕ</a> <a id="52" class="Keyword">renaming</a> <a id="61" class="Symbol">(</a><a id="62" href="Data.Nat.Base.html#5485" class="Function Operator">_⊔_</a> <a id="66" class="Symbol">to</a> <a id="69" class="Function Operator">max</a><a id="72" class="Symbol">)</a>
<a id="74" class="Keyword">import</a>      <a id="86" href="Data.Integer.html" class="Module">Data.Integer</a> <a id="99" class="Symbol">as</a> <a id="102" class="Module">ℤ</a> <a id="104" class="Keyword">renaming</a> <a id="113" class="Symbol">(</a><a id="114" href="Data.Integer.Base.html#5556" class="Function Operator">_⊔_</a> <a id="118" class="Symbol">to</a> <a id="121" class="Function Operator">max</a><a id="124" class="Symbol">)</a>
<a id="126" class="Keyword">import</a>      <a id="138" href="Data.Integer.Properties.html" class="Module">Data.Integer.Properties</a> <a id="162" class="Symbol">as</a> <a id="165" class="Module">ℤ</a>
<a id="167" class="Keyword">open</a> <a id="172" class="Keyword">import</a> <a id="179" href="Data.Rational.html" class="Module">Data.Rational</a> <a id="193" class="Keyword">using</a> <a id="199" class="Symbol">(</a><a id="200" href="Data.Rational.Base.html#1342" class="Record">ℚ</a><a id="201" class="Symbol">;</a> <a id="203" href="Data.Rational.Base.html#7116" class="Function">floor</a><a id="208" class="Symbol">;</a> <a id="210" href="Data.Rational.Base.html#6315" class="Function Operator">_*_</a><a id="213" class="Symbol">;</a> <a id="215" href="Data.Rational.Base.html#6708" class="Function Operator">_÷_</a><a id="218" class="Symbol">;</a> <a id="220" href="Data.Rational.Base.html#3884" class="Function Operator">_/_</a><a id="223" class="Symbol">;</a> <a id="225" href="Data.Rational.Base.html#6405" class="Function Operator">_-_</a><a id="228" class="Symbol">)</a>
<a id="230" class="Keyword">import</a>      <a id="242" href="Data.Rational.html" class="Module">Data.Rational</a> <a id="256" class="Symbol">as</a> <a id="259" class="Module">ℚ</a> <a id="261" class="Keyword">renaming</a> <a id="270" class="Symbol">(</a><a id="271" href="Data.Rational.Base.html#6854" class="Function Operator">_⊓_</a> <a id="275" class="Symbol">to</a> <a id="278" class="Function Operator">min</a><a id="281" class="Symbol">;</a> <a id="283" href="Data.Rational.Base.html#6776" class="Function Operator">_⊔_</a> <a id="287" class="Symbol">to</a> <a id="290" class="Function Operator">max</a><a id="293" class="Symbol">)</a>
<a id="295" class="Keyword">open</a> <a id="300" class="Keyword">import</a> <a id="307" href="Data.Rational.Literals.html" class="Module">Data.Rational.Literals</a> <a id="330" class="Keyword">using</a> <a id="336" class="Symbol">(</a><a id="337" href="Data.Rational.Literals.html#740" class="Function">number</a><a id="343" class="Symbol">;</a> <a id="345" href="Data.Rational.Literals.html#613" class="Function">fromℤ</a><a id="350" class="Symbol">)</a>
<a id="352" class="Keyword">import</a>      <a id="364" href="Data.Rational.Properties.html" class="Module">Data.Rational.Properties</a> <a id="389" class="Symbol">as</a> <a id="392" class="Module">ℚ</a>

<a id="395" class="Keyword">open</a> <a id="400" class="Keyword">import</a> <a id="407" href="Ledger.Abstract.html" class="Module">Ledger.Abstract</a>
<a id="423" class="Keyword">open</a> <a id="428" class="Keyword">import</a> <a id="435" href="Ledger.Transaction.html" class="Module">Ledger.Transaction</a>
<a id="454" class="Keyword">open</a> <a id="459" class="Keyword">import</a> <a id="466" href="Ledger.Types.Numeric.UnitInterval.html" class="Module">Ledger.Types.Numeric.UnitInterval</a>

<a id="501" class="Keyword">open</a> <a id="506" class="Keyword">import</a> <a id="513" href="Agda.Builtin.FromNat.html" class="Module">Agda.Builtin.FromNat</a>
<a id="534" class="Keyword">open</a>        <a id="546" href="Agda.Builtin.FromNat.html#196" class="Module">Number</a> <a id="553" href="Data.Rational.Literals.html#740" class="Function">number</a> <a id="560" class="Keyword">renaming</a> <a id="569" class="Symbol">(</a><a id="570" href="Agda.Builtin.FromNat.html#281" class="Field">fromNat</a> <a id="578" class="Symbol">to</a> <a id="581" class="Field">fromℕ</a><a id="586" class="Symbol">)</a>

<a id="589" class="Keyword">module</a> <a id="596" href="Ledger.Rewards.html" class="Module">Ledger.Rewards</a>
  <a id="613" class="Symbol">(</a><a id="614" href="Ledger.Rewards.html#614" class="Bound">txs</a> <a id="618" class="Symbol">:</a> <a id="620" class="Symbol">_)</a> <a id="623" class="Symbol">(</a><a id="624" class="Keyword">open</a> <a id="629" href="Ledger.Transaction.html#840" class="Module">TransactionStructure</a> <a id="650" href="Ledger.Rewards.html#614" class="Bound">txs</a><a id="653" class="Symbol">)</a>
  <a id="657" class="Symbol">(</a><a id="658" href="Ledger.Rewards.html#658" class="Bound">abs</a> <a id="662" class="Symbol">:</a> <a id="664" href="Ledger.Abstract.html#578" class="Record">AbstractFunctions</a> <a id="682" href="Ledger.Rewards.html#614" class="Bound">txs</a><a id="685" class="Symbol">)</a>
  <a id="689" class="Keyword">where</a>

<a id="696" class="Keyword">open</a> <a id="701" class="Keyword">import</a> <a id="708" href="Ledger.Certs.html" class="Module">Ledger.Certs</a> <a id="721" href="Ledger.Transaction.html#1782" class="Function">govStructure</a>
<a id="734" class="Keyword">open</a> <a id="739" class="Keyword">import</a> <a id="746" href="Ledger.Ledger.html" class="Module">Ledger.Ledger</a> <a id="760" href="Ledger.Rewards.html#614" class="Bound">txs</a> <a id="764" href="Ledger.Rewards.html#658" class="Bound">abs</a>
<a id="768" class="Keyword">open</a> <a id="773" class="Keyword">import</a> <a id="780" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a> <a id="795" class="Keyword">hiding</a> <a id="802" class="Symbol">(</a><a id="803" href="Data.Nat.Base.html#7102" class="Function Operator">_/_</a><a id="806" class="Symbol">;</a> <a id="808" href="Agda.Builtin.Nat.html#539" class="Primitive Operator">_*_</a><a id="811" class="Symbol">;</a> <a id="813" href="Interface.HasSubtract.html#209" class="Field Operator">_-_</a><a id="816" class="Symbol">)</a>
<a id="818" class="Keyword">open</a> <a id="823" class="Keyword">import</a> <a id="830" href="Ledger.Utxo.html" class="Module">Ledger.Utxo</a> <a id="842" href="Ledger.Rewards.html#614" class="Bound">txs</a> <a id="846" href="Ledger.Rewards.html#658" class="Bound">abs</a>



<a id="nonZero-max-1"></a><a id="853" href="Ledger.Rewards.html#853" class="Function">nonZero-max-1</a> <a id="867" class="Symbol">:</a> <a id="869" class="Symbol">∀</a> <a id="871" class="Symbol">(</a><a id="872" href="Ledger.Rewards.html#872" class="Bound">n</a> <a id="874" class="Symbol">:</a> <a id="876" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="877" class="Symbol">)</a> <a id="879" class="Symbol">→</a> <a id="881" href="Data.Nat.Base.html#3266" class="Record">ℕ.NonZero</a> <a id="891" class="Symbol">(</a><a id="892" href="Ledger.Rewards.html#69" class="Function">ℕ.max</a> <a id="898" class="Number">1</a> <a id="900" href="Ledger.Rewards.html#872" class="Bound">n</a><a id="901" class="Symbol">)</a>
<a id="903" href="Ledger.Rewards.html#853" class="Function">nonZero-max-1</a> <a id="917" href="Agda.Builtin.Nat.html#221" class="InductiveConstructor">zero</a> <a id="922" class="Symbol">=</a> <a id="924" href="Data.Nat.Base.html#3359" class="Function">ℕ.nonZero</a>
<a id="934" href="Ledger.Rewards.html#853" class="Function">nonZero-max-1</a> <a id="948" class="Symbol">(</a><a id="949" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="953" href="Ledger.Rewards.html#953" class="Bound">n</a><a id="954" class="Symbol">)</a> <a id="956" class="Symbol">=</a> <a id="958" href="Data.Nat.Base.html#3359" class="Function">ℕ.nonZero</a>

<a id="nonZero-1/n"></a><a id="969" href="Ledger.Rewards.html#969" class="Function">nonZero-1/n</a> <a id="981" class="Symbol">:</a> <a id="983" class="Symbol">∀</a> <a id="985" class="Symbol">(</a><a id="986" href="Ledger.Rewards.html#986" class="Bound">n</a> <a id="988" class="Symbol">:</a> <a id="990" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="991" class="Symbol">)</a> <a id="993" class="Symbol">→</a> <a id="995" class="Symbol">.{{</a><a id="998" href="Ledger.Rewards.html#998" class="Bound">_</a> <a id="1000" class="Symbol">:</a> <a id="1002" href="Data.Nat.Base.html#3266" class="Record">ℕ.NonZero</a> <a id="1012" href="Ledger.Rewards.html#986" class="Bound">n</a><a id="1013" class="Symbol">}}</a> <a id="1016" class="Symbol">→</a> <a id="1018" href="Data.Rational.Base.html#4498" class="Function">ℚ.NonZero</a> <a id="1028" class="Symbol">(</a><a id="1029" class="Number">1</a> <a id="1031" href="Data.Rational.Base.html#3884" class="Function Operator">/</a> <a id="1033" href="Ledger.Rewards.html#986" class="Bound">n</a><a id="1034" class="Symbol">)</a>
<a id="1036" href="Ledger.Rewards.html#969" class="Function">nonZero-1/n</a> <a id="1048" href="Ledger.Rewards.html#1048" class="Bound">n</a> <a id="1050" class="Symbol">{{</a><a id="1052" href="Ledger.Rewards.html#1052" class="Bound">prf</a><a id="1055" class="Symbol">}}</a> <a id="1058" class="Symbol">=</a>
  <a id="1062" href="Data.Rational.Properties.html#7612" class="Function">ℚ.pos⇒nonZero</a> <a id="1076" class="Symbol">(</a><a id="1077" class="Number">1</a> <a id="1079" href="Data.Rational.Base.html#3884" class="Function Operator">/</a> <a id="1081" href="Ledger.Rewards.html#1048" class="Bound">n</a><a id="1082" class="Symbol">)</a> <a id="1084" class="Symbol">{{</a><a id="1086" href="Data.Rational.Properties.html#11672" class="Function">ℚ.normalize-pos</a> <a id="1102" class="Number">1</a> <a id="1104" href="Ledger.Rewards.html#1048" class="Bound">n</a> <a id="1106" class="Symbol">{{</a><a id="1108" href="Ledger.Rewards.html#1052" class="Bound">prf</a><a id="1111" class="Symbol">}}</a> <a id="1114" class="Symbol">{{_}}</a> <a id="1120" class="Symbol">}}</a>

<a id="nonZero-1+max0-x"></a><a id="1124" href="Ledger.Rewards.html#1124" class="Function">nonZero-1+max0-x</a> <a id="1141" class="Symbol">:</a> <a id="1143" class="Symbol">∀</a> <a id="1145" class="Symbol">(</a><a id="1146" href="Ledger.Rewards.html#1146" class="Bound">x</a> <a id="1148" class="Symbol">:</a> <a id="1150" href="Data.Rational.Base.html#1342" class="Record">ℚ</a><a id="1151" class="Symbol">)</a> <a id="1153" class="Symbol">→</a> <a id="1155" href="Data.Rational.Base.html#4498" class="Function">ℚ.NonZero</a> <a id="1165" class="Symbol">(</a><a id="1166" class="Number">1</a> <a id="1168" href="Class.HasAdd.Core.html#162" class="Field Operator">+</a> <a id="1170" href="Ledger.Rewards.html#290" class="Function">ℚ.max</a> <a id="1176" class="Number">0</a> <a id="1178" href="Ledger.Rewards.html#1146" class="Bound">x</a><a id="1179" class="Symbol">)</a>
<a id="1181" href="Ledger.Rewards.html#1124" class="Function">nonZero-1+max0-x</a> <a id="1198" href="Ledger.Rewards.html#1198" class="Bound">x</a> <a id="1200" class="Symbol">=</a>
  <a id="1204" href="Data.Rational.Base.html#5214" class="Function">ℚ.&gt;-nonZero</a> <a id="1216" class="Symbol">(</a><a id="1217" href="Data.Rational.Properties.html#36007" class="Function">ℚ.+-mono-&lt;-≤</a> <a id="1230" class="Symbol">(</a><a id="1231" href="Data.Rational.Properties.html#26724" class="Function">ℚ.positive⁻¹</a> <a id="1244" class="Number">1</a><a id="1245" class="Symbol">)</a> <a id="1247" class="Symbol">(</a><a id="1248" href="Data.Rational.Properties.html#57994" class="Function">ℚ.p≤p⊔q</a> <a id="1256" class="Number">0</a> <a id="1258" href="Ledger.Rewards.html#1198" class="Bound">x</a><a id="1259" class="Symbol">))</a>

<a id="1263" class="Keyword">private</a> <a id="1271" class="Keyword">instance</a>
  <a id="nonNegative"></a><a id="1282" href="Ledger.Rewards.html#1282" class="Function">nonNegative</a> <a id="1294" class="Symbol">:</a> <a id="1296" class="Symbol">∀</a> <a id="1298" class="Symbol">{</a><a id="1299" href="Ledger.Rewards.html#1299" class="Bound">i</a><a id="1300" class="Symbol">}</a> <a id="1302" class="Symbol">→</a> <a id="1304" href="Data.Integer.Base.html#3053" class="Record">ℤ.NonNegative</a> <a id="1318" class="Symbol">(</a><a id="1319" href="Ledger.Rewards.html#121" class="Function">ℤ.max</a> <a id="1325" class="Number">0</a> <a id="1327" href="Ledger.Rewards.html#1299" class="Bound">i</a><a id="1328" class="Symbol">)</a>
  <a id="1332" href="Ledger.Rewards.html#1282" class="Function">nonNegative</a> <a id="1344" class="Symbol">{</a><a id="1345" href="Ledger.Rewards.html#1345" class="Bound">i</a><a id="1346" class="Symbol">}</a> <a id="1348" class="Symbol">=</a> <a id="1350" href="Data.Integer.Base.html#4073" class="Function">ℤ.nonNegative</a> <a id="1364" class="Symbol">(</a><a id="1365" href="Data.Integer.Properties.html#67574" class="Function">ℤ.i≤i⊔j</a> <a id="1373" class="Number">0</a> <a id="1375" href="Ledger.Rewards.html#1345" class="Bound">i</a><a id="1376" class="Symbol">)</a>


<a id="maxPool"></a><a id="1380" href="Ledger.Rewards.html#1380" class="Function">maxPool</a> <a id="1388" class="Symbol">:</a> <a id="1390" href="Ledger.PParams.html#1570" class="Record">PParams</a> <a id="1398" class="Symbol">→</a> <a id="1400" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="1405" class="Symbol">→</a> <a id="1407" href="Ledger.Types.Numeric.UnitInterval.html#2117" class="Function">UnitInterval</a> <a id="1420" class="Symbol">→</a> <a id="1422" href="Ledger.Types.Numeric.UnitInterval.html#2117" class="Function">UnitInterval</a> <a id="1435" class="Symbol">→</a> <a id="1437" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="1442" href="Ledger.Rewards.html#1380" class="Function">maxPool</a> <a id="1450" href="Ledger.Rewards.html#1450" class="Bound">pparams</a> <a id="1458" href="Ledger.Rewards.html#1458" class="Bound">rewardPot</a> <a id="1468" href="Ledger.Rewards.html#1468" class="Bound">stake</a> <a id="1474" href="Ledger.Rewards.html#1474" class="Bound">pledge</a> <a id="1481" class="Symbol">=</a> <a id="1483" href="Ledger.Rewards.html#2161" class="Function">rewardℕ</a>
  <a id="1493" class="Keyword">where</a>
    <a id="1503" href="Ledger.Rewards.html#1503" class="Function">a0</a>      <a id="1511" class="Symbol">=</a> <a id="1513" href="Ledger.Rewards.html#290" class="Function">ℚ.max</a> <a id="1519" class="Number">0</a> <a id="1521" class="Symbol">(</a><a id="1522" href="Ledger.Rewards.html#1450" class="Bound">pparams</a> <a id="1530" class="Symbol">.</a><a id="1531" href="Ledger.PParams.html#2770" class="Field">PParams.a0</a><a id="1541" class="Symbol">)</a>
    <a id="1547" href="Ledger.Rewards.html#1547" class="Function">1+a0</a>    <a id="1555" class="Symbol">=</a> <a id="1557" class="Number">1</a> <a id="1559" href="Class.HasAdd.Core.html#162" class="Field Operator">+</a> <a id="1561" href="Ledger.Rewards.html#1503" class="Function">a0</a>
    <a id="1568" href="Ledger.Rewards.html#1568" class="Function">nopt</a>    <a id="1576" class="Symbol">=</a> <a id="1578" href="Ledger.Rewards.html#69" class="Function">ℕ.max</a> <a id="1584" class="Number">1</a> <a id="1586" class="Symbol">(</a><a id="1587" href="Ledger.Rewards.html#1450" class="Bound">pparams</a> <a id="1595" class="Symbol">.</a><a id="1596" href="Ledger.PParams.html#2728" class="Field">PParams.nopt</a><a id="1608" class="Symbol">)</a>


    <a id="1616" class="Keyword">instance</a>
      <a id="1631" href="Ledger.Rewards.html#1631" class="Function">nonZero-nopt</a> <a id="1644" class="Symbol">:</a> <a id="1646" href="Data.Nat.Base.html#3266" class="Record">ℕ.NonZero</a> <a id="1656" href="Ledger.Rewards.html#1568" class="Function">nopt</a>
      <a id="1667" href="Ledger.Rewards.html#1631" class="Function">nonZero-nopt</a> <a id="1680" class="Symbol">=</a> <a id="1682" href="Ledger.Rewards.html#853" class="Function">nonZero-max-1</a> <a id="1696" class="Symbol">(</a><a id="1697" href="Ledger.Rewards.html#1450" class="Bound">pparams</a> <a id="1705" class="Symbol">.</a><a id="1706" href="Ledger.PParams.html#2728" class="Field">PParams.nopt</a><a id="1718" class="Symbol">)</a>


    <a id="1726" href="Ledger.Rewards.html#1726" class="Function">z0</a>       <a id="1735" class="Symbol">=</a> <a id="1737" class="Number">1</a> <a id="1739" href="Data.Rational.Base.html#3884" class="Function Operator">/</a> <a id="1741" href="Ledger.Rewards.html#1568" class="Function">nopt</a>
    <a id="1750" href="Ledger.Rewards.html#1750" class="Function">stake&#39;</a>   <a id="1759" class="Symbol">=</a> <a id="1761" href="Ledger.Rewards.html#278" class="Function">ℚ.min</a> <a id="1767" class="Symbol">(</a><a id="1768" href="Ledger.Types.Numeric.UnitInterval.html#2334" class="Function">fromUnitInterval</a> <a id="1785" href="Ledger.Rewards.html#1468" class="Bound">stake</a><a id="1790" class="Symbol">)</a> <a id="1792" href="Ledger.Rewards.html#1726" class="Function">z0</a>
    <a id="1799" href="Ledger.Rewards.html#1799" class="Function">pledge&#39;</a>  <a id="1808" class="Symbol">=</a> <a id="1810" href="Ledger.Rewards.html#278" class="Function">ℚ.min</a> <a id="1816" class="Symbol">(</a><a id="1817" href="Ledger.Types.Numeric.UnitInterval.html#2334" class="Function">fromUnitInterval</a> <a id="1834" href="Ledger.Rewards.html#1474" class="Bound">pledge</a><a id="1840" class="Symbol">)</a> <a id="1842" href="Ledger.Rewards.html#1726" class="Function">z0</a>


    <a id="1851" class="Keyword">instance</a>
      <a id="1866" href="Ledger.Rewards.html#1866" class="Function">nonZeroz0</a> <a id="1876" class="Symbol">:</a> <a id="1878" href="Data.Rational.Base.html#4498" class="Function">ℚ.NonZero</a> <a id="1888" href="Ledger.Rewards.html#1726" class="Function">z0</a>
      <a id="1897" href="Ledger.Rewards.html#1866" class="Function">nonZeroz0</a> <a id="1907" class="Symbol">=</a> <a id="1909" href="Ledger.Rewards.html#969" class="Function">nonZero-1/n</a> <a id="1921" href="Ledger.Rewards.html#1568" class="Function">nopt</a>

      <a id="1933" href="Ledger.Rewards.html#1933" class="Function">nonZero-1+a0</a> <a id="1946" class="Symbol">:</a> <a id="1948" href="Data.Rational.Base.html#4498" class="Function">ℚ.NonZero</a> <a id="1958" class="Symbol">(</a><a id="1959" href="Ledger.Rewards.html#1547" class="Function">1+a0</a><a id="1963" class="Symbol">)</a>
      <a id="1971" href="Ledger.Rewards.html#1933" class="Function">nonZero-1+a0</a> <a id="1984" class="Symbol">=</a> <a id="1986" href="Ledger.Rewards.html#1124" class="Function">nonZero-1+max0-x</a> <a id="2003" class="Symbol">(</a><a id="2004" href="Ledger.Rewards.html#1450" class="Bound">pparams</a> <a id="2012" class="Symbol">.</a><a id="2013" href="Ledger.PParams.html#2770" class="Field">PParams.a0</a><a id="2023" class="Symbol">)</a>


    <a id="2031" href="Ledger.Rewards.html#2031" class="Function">rewardℚ</a> <a id="2039" class="Symbol">=</a>
        <a id="2049" class="Symbol">((</a><a id="2051" href="Ledger.Rewards.html#581" class="Function">fromℕ</a> <a id="2057" href="Ledger.Rewards.html#1458" class="Bound">rewardPot</a><a id="2066" class="Symbol">)</a> <a id="2068" href="Data.Rational.Base.html#6708" class="Function Operator">÷</a> <a id="2070" href="Ledger.Rewards.html#1547" class="Function">1+a0</a><a id="2074" class="Symbol">)</a>
        <a id="2084" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="2086" class="Symbol">(</a><a id="2087" href="Ledger.Rewards.html#1750" class="Function">stake&#39;</a> <a id="2094" href="Class.HasAdd.Core.html#162" class="Field Operator">+</a> <a id="2096" href="Ledger.Rewards.html#1799" class="Function">pledge&#39;</a> <a id="2104" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="2106" href="Ledger.Rewards.html#1503" class="Function">a0</a> <a id="2109" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="2111" class="Symbol">(</a><a id="2112" href="Ledger.Rewards.html#1750" class="Function">stake&#39;</a> <a id="2119" href="Data.Rational.Base.html#6405" class="Function Operator">-</a> <a id="2121" href="Ledger.Rewards.html#1799" class="Function">pledge&#39;</a> <a id="2129" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="2131" class="Symbol">(</a><a id="2132" href="Ledger.Rewards.html#1726" class="Function">z0</a> <a id="2135" href="Data.Rational.Base.html#6405" class="Function Operator">-</a> <a id="2137" href="Ledger.Rewards.html#1750" class="Function">stake&#39;</a><a id="2143" class="Symbol">)</a> <a id="2145" href="Data.Rational.Base.html#6708" class="Function Operator">÷</a> <a id="2147" href="Ledger.Rewards.html#1726" class="Function">z0</a><a id="2149" class="Symbol">)</a> <a id="2151" href="Data.Rational.Base.html#6708" class="Function Operator">÷</a> <a id="2153" href="Ledger.Rewards.html#1726" class="Function">z0</a><a id="2155" class="Symbol">)</a>
    <a id="2161" href="Ledger.Rewards.html#2161" class="Function">rewardℕ</a> <a id="2169" class="Symbol">=</a> <a id="2171" href="Prelude.html#3167" class="Function">posPart</a> <a id="2179" class="Symbol">(</a><a id="2180" href="Data.Rational.Base.html#7116" class="Function">floor</a> <a id="2186" href="Ledger.Rewards.html#2031" class="Function">rewardℚ</a><a id="2193" class="Symbol">)</a>


<a id="mkApparentPerformance"></a><a id="2197" href="Ledger.Rewards.html#2197" class="Function">mkApparentPerformance</a> <a id="2219" class="Symbol">:</a> <a id="2221" href="Ledger.Types.Numeric.UnitInterval.html#2117" class="Function">UnitInterval</a> <a id="2234" class="Symbol">→</a> <a id="2236" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="2238" class="Symbol">→</a> <a id="2240" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="2242" class="Symbol">→</a> <a id="2244" href="Data.Rational.Base.html#1342" class="Record">ℚ</a>
<a id="2246" href="Ledger.Rewards.html#2197" class="Function">mkApparentPerformance</a> <a id="2268" href="Ledger.Rewards.html#2268" class="Bound">stake</a> <a id="2274" href="Ledger.Rewards.html#2274" class="Bound">poolBlocks</a> <a id="2285" href="Ledger.Rewards.html#2285" class="Bound">totalBlocks</a> <a id="2297" class="Symbol">=</a> <a id="2299" href="Ledger.Rewards.html#2500" class="Function">ratioBlocks</a> <a id="2311" href="Ledger.Prelude.html#2305" class="Function Operator">÷₀</a> <a id="2314" href="Ledger.Rewards.html#2333" class="Function">stake&#39;</a>
  <a id="2323" class="Keyword">where</a>
    <a id="2333" href="Ledger.Rewards.html#2333" class="Function">stake&#39;</a> <a id="2340" class="Symbol">=</a> <a id="2342" href="Ledger.Types.Numeric.UnitInterval.html#2334" class="Function">fromUnitInterval</a> <a id="2359" href="Ledger.Rewards.html#2268" class="Bound">stake</a>


    <a id="2371" class="Keyword">instance</a>
      <a id="2386" href="Ledger.Rewards.html#2386" class="Function">nonZero-totalBlocks</a> <a id="2406" class="Symbol">:</a> <a id="2408" href="Data.Nat.Base.html#3266" class="Record">ℕ.NonZero</a> <a id="2418" class="Symbol">(</a><a id="2419" href="Ledger.Rewards.html#69" class="Function">ℕ.max</a> <a id="2425" class="Number">1</a> <a id="2427" href="Ledger.Rewards.html#2285" class="Bound">totalBlocks</a><a id="2438" class="Symbol">)</a>
      <a id="2446" href="Ledger.Rewards.html#2386" class="Function">nonZero-totalBlocks</a> <a id="2466" class="Symbol">=</a> <a id="2468" href="Ledger.Rewards.html#853" class="Function">nonZero-max-1</a> <a id="2482" href="Ledger.Rewards.html#2285" class="Bound">totalBlocks</a>


    <a id="2500" href="Ledger.Rewards.html#2500" class="Function">ratioBlocks</a> <a id="2512" class="Symbol">=</a> <a id="2514" class="Symbol">(</a><a id="2515" href="Agda.Builtin.Int.html#263" class="InductiveConstructor Operator">ℤ.+</a> <a id="2519" href="Ledger.Rewards.html#2274" class="Bound">poolBlocks</a><a id="2529" class="Symbol">)</a> <a id="2531" href="Data.Rational.Base.html#3884" class="Function Operator">/</a> <a id="2533" class="Symbol">(</a><a id="2534" href="Ledger.Rewards.html#69" class="Function">ℕ.max</a> <a id="2540" class="Number">1</a> <a id="2542" href="Ledger.Rewards.html#2285" class="Bound">totalBlocks</a><a id="2553" class="Symbol">)</a>


<a id="rewardOwners"></a><a id="2557" href="Ledger.Rewards.html#2557" class="Function">rewardOwners</a> <a id="2570" class="Symbol">:</a> <a id="2572" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="2577" class="Symbol">→</a> <a id="2579" href="Ledger.Certs.html#1131" class="Record">PoolParams</a> <a id="2590" class="Symbol">→</a> <a id="2592" href="Ledger.Types.Numeric.UnitInterval.html#2117" class="Function">UnitInterval</a> <a id="2605" class="Symbol">→</a> <a id="2607" href="Ledger.Types.Numeric.UnitInterval.html#2117" class="Function">UnitInterval</a> <a id="2620" class="Symbol">→</a> <a id="2622" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="2627" href="Ledger.Rewards.html#2557" class="Function">rewardOwners</a> <a id="2640" href="Ledger.Rewards.html#2640" class="Bound">rewards</a> <a id="2648" href="Ledger.Rewards.html#2648" class="Bound">pool</a> <a id="2653" href="Ledger.Rewards.html#2653" class="Bound">ownerStake</a> <a id="2664" href="Ledger.Rewards.html#2664" class="Bound">stake</a> <a id="2670" class="Symbol">=</a> <a id="2672" href="Class.ToBool.html#389" class="Function Operator">if</a> <a id="2675" href="Ledger.Rewards.html#2640" class="Bound">rewards</a> <a id="2683" href="Class.HasOrder.Core.html#608" class="Field Operator">≤</a> <a id="2685" href="Ledger.Rewards.html#2899" class="Function">cost</a>
  <a id="2692" href="Class.ToBool.html#389" class="Function Operator">then</a> <a id="2697" href="Ledger.Rewards.html#2640" class="Bound">rewards</a>
  <a id="2707" href="Class.ToBool.html#389" class="Function Operator">else</a> <a id="2712" href="Ledger.Rewards.html#2899" class="Function">cost</a> <a id="2717" href="Class.HasAdd.Core.html#162" class="Field Operator">+</a> <a id="2719" href="Prelude.html#3167" class="Function">posPart</a> <a id="2727" class="Symbol">(</a><a id="2728" href="Data.Rational.Base.html#7116" class="Function">floor</a> <a id="2734" class="Symbol">(</a>
        <a id="2744" class="Symbol">(</a><a id="2745" href="Ledger.Rewards.html#581" class="Function">fromℕ</a> <a id="2751" href="Ledger.Rewards.html#2640" class="Bound">rewards</a> <a id="2759" href="Data.Rational.Base.html#6405" class="Function Operator">-</a> <a id="2761" href="Ledger.Rewards.html#581" class="Function">fromℕ</a> <a id="2767" href="Ledger.Rewards.html#2899" class="Function">cost</a><a id="2771" class="Symbol">)</a> <a id="2773" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="2775" class="Symbol">(</a><a id="2776" href="Ledger.Rewards.html#2940" class="Function">margin</a> <a id="2783" href="Class.HasAdd.Core.html#162" class="Field Operator">+</a> <a id="2785" class="Symbol">(</a><a id="2786" class="Number">1</a> <a id="2788" href="Data.Rational.Base.html#6405" class="Function Operator">-</a> <a id="2790" href="Ledger.Rewards.html#2940" class="Function">margin</a><a id="2796" class="Symbol">)</a> <a id="2798" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="2800" href="Ledger.Rewards.html#2826" class="Function">ratioStake</a><a id="2810" class="Symbol">)))</a>
  <a id="2816" class="Keyword">where</a>
    <a id="2826" href="Ledger.Rewards.html#2826" class="Function">ratioStake</a>   <a id="2839" class="Symbol">=</a> <a id="2841" href="Ledger.Types.Numeric.UnitInterval.html#2334" class="Function">fromUnitInterval</a> <a id="2858" href="Ledger.Rewards.html#2653" class="Bound">ownerStake</a> <a id="2869" href="Ledger.Prelude.html#2305" class="Function Operator">÷₀</a> <a id="2872" href="Ledger.Types.Numeric.UnitInterval.html#2334" class="Function">fromUnitInterval</a> <a id="2889" href="Ledger.Rewards.html#2664" class="Bound">stake</a>
    <a id="2899" href="Ledger.Rewards.html#2899" class="Function">cost</a>         <a id="2912" class="Symbol">=</a> <a id="2914" href="Ledger.Rewards.html#2648" class="Bound">pool</a> <a id="2919" class="Symbol">.</a><a id="2920" href="Ledger.Certs.html#1199" class="Field">PoolParams.cost</a>
    <a id="2940" href="Ledger.Rewards.html#2940" class="Function">margin</a>       <a id="2953" class="Symbol">=</a> <a id="2955" href="Ledger.Types.Numeric.UnitInterval.html#2334" class="Function">fromUnitInterval</a> <a id="2972" class="Symbol">(</a><a id="2973" href="Ledger.Rewards.html#2648" class="Bound">pool</a> <a id="2978" class="Symbol">.</a><a id="2979" href="Ledger.Certs.html#1226" class="Field">PoolParams.margin</a><a id="2996" class="Symbol">)</a>


<a id="rewardMember"></a><a id="3000" href="Ledger.Rewards.html#3000" class="Function">rewardMember</a> <a id="3013" class="Symbol">:</a> <a id="3015" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="3020" class="Symbol">→</a> <a id="3022" href="Ledger.Certs.html#1131" class="Record">PoolParams</a> <a id="3033" class="Symbol">→</a> <a id="3035" href="Ledger.Types.Numeric.UnitInterval.html#2117" class="Function">UnitInterval</a> <a id="3048" class="Symbol">→</a> <a id="3050" href="Ledger.Types.Numeric.UnitInterval.html#2117" class="Function">UnitInterval</a> <a id="3063" class="Symbol">→</a> <a id="3065" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="3070" href="Ledger.Rewards.html#3000" class="Function">rewardMember</a> <a id="3083" href="Ledger.Rewards.html#3083" class="Bound">rewards</a> <a id="3091" href="Ledger.Rewards.html#3091" class="Bound">pool</a> <a id="3096" href="Ledger.Rewards.html#3096" class="Bound">memberStake</a> <a id="3108" href="Ledger.Rewards.html#3108" class="Bound">stake</a> <a id="3114" class="Symbol">=</a> <a id="3116" href="Class.ToBool.html#389" class="Function Operator">if</a> <a id="3119" href="Ledger.Rewards.html#3083" class="Bound">rewards</a> <a id="3127" href="Class.HasOrder.Core.html#608" class="Field Operator">≤</a> <a id="3129" href="Ledger.Rewards.html#3324" class="Function">cost</a>
  <a id="3136" href="Class.ToBool.html#389" class="Function Operator">then</a> <a id="3141" class="Number">0</a>
  <a id="3145" href="Class.ToBool.html#389" class="Function Operator">else</a> <a id="3150" href="Prelude.html#3167" class="Function">posPart</a> <a id="3158" class="Symbol">(</a><a id="3159" href="Data.Rational.Base.html#7116" class="Function">floor</a> <a id="3165" class="Symbol">(</a>
         <a id="3176" class="Symbol">(</a><a id="3177" href="Ledger.Rewards.html#581" class="Function">fromℕ</a> <a id="3183" href="Ledger.Rewards.html#3083" class="Bound">rewards</a> <a id="3191" href="Data.Rational.Base.html#6405" class="Function Operator">-</a> <a id="3193" href="Ledger.Rewards.html#581" class="Function">fromℕ</a> <a id="3199" href="Ledger.Rewards.html#3324" class="Function">cost</a><a id="3203" class="Symbol">)</a> <a id="3205" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="3207" class="Symbol">((</a><a id="3209" class="Number">1</a> <a id="3211" href="Data.Rational.Base.html#6405" class="Function Operator">-</a> <a id="3213" href="Ledger.Rewards.html#3366" class="Function">margin</a><a id="3219" class="Symbol">)</a> <a id="3221" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="3223" href="Ledger.Rewards.html#3249" class="Function">ratioStake</a><a id="3233" class="Symbol">)))</a>
  <a id="3239" class="Keyword">where</a>
    <a id="3249" href="Ledger.Rewards.html#3249" class="Function">ratioStake</a>    <a id="3263" class="Symbol">=</a> <a id="3265" href="Ledger.Types.Numeric.UnitInterval.html#2334" class="Function">fromUnitInterval</a> <a id="3282" href="Ledger.Rewards.html#3096" class="Bound">memberStake</a> <a id="3294" href="Ledger.Prelude.html#2305" class="Function Operator">÷₀</a> <a id="3297" href="Ledger.Types.Numeric.UnitInterval.html#2334" class="Function">fromUnitInterval</a> <a id="3314" href="Ledger.Rewards.html#3108" class="Bound">stake</a>
    <a id="3324" href="Ledger.Rewards.html#3324" class="Function">cost</a>          <a id="3338" class="Symbol">=</a> <a id="3340" href="Ledger.Rewards.html#3091" class="Bound">pool</a> <a id="3345" class="Symbol">.</a><a id="3346" href="Ledger.Certs.html#1199" class="Field">PoolParams.cost</a>
    <a id="3366" href="Ledger.Rewards.html#3366" class="Function">margin</a>        <a id="3380" class="Symbol">=</a> <a id="3382" href="Ledger.Types.Numeric.UnitInterval.html#2334" class="Function">fromUnitInterval</a> <a id="3399" class="Symbol">(</a><a id="3400" href="Ledger.Rewards.html#3091" class="Bound">pool</a> <a id="3405" class="Symbol">.</a><a id="3406" href="Ledger.Certs.html#1226" class="Field">PoolParams.margin</a><a id="3423" class="Symbol">)</a>


<a id="Stake"></a><a id="3427" href="Ledger.Rewards.html#3427" class="Function">Stake</a> <a id="3433" class="Symbol">=</a> <a id="3435" href="Ledger.Address.html#273" class="Datatype">Credential</a> <a id="3446" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="3448" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>

<a id="rewardOnePool"></a><a id="3454" href="Ledger.Rewards.html#3454" class="Function">rewardOnePool</a> <a id="3468" class="Symbol">:</a> <a id="3470" href="Ledger.PParams.html#1570" class="Record">PParams</a> <a id="3478" class="Symbol">→</a> <a id="3480" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="3485" class="Symbol">→</a> <a id="3487" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="3489" class="Symbol">→</a> <a id="3491" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="3493" class="Symbol">→</a> <a id="3495" href="Ledger.Certs.html#1131" class="Record">PoolParams</a>
  <a id="3508" class="Symbol">→</a> <a id="3510" href="Ledger.Rewards.html#3427" class="Function">Stake</a> <a id="3516" class="Symbol">→</a> <a id="3518" href="Ledger.Types.Numeric.UnitInterval.html#2117" class="Function">UnitInterval</a> <a id="3531" class="Symbol">→</a> <a id="3533" href="Ledger.Types.Numeric.UnitInterval.html#2117" class="Function">UnitInterval</a> <a id="3546" class="Symbol">→</a> <a id="3548" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="3553" class="Symbol">→</a> <a id="3555" class="Symbol">(</a><a id="3556" href="Ledger.Address.html#273" class="Datatype">Credential</a> <a id="3567" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="3569" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a><a id="3573" class="Symbol">)</a>
<a id="3575" href="Ledger.Rewards.html#3454" class="Function">rewardOnePool</a> <a id="3589" href="Ledger.Rewards.html#3589" class="Bound">pparams</a> <a id="3597" href="Ledger.Rewards.html#3597" class="Bound">rewardPot</a> <a id="3607" href="Ledger.Rewards.html#3607" class="Bound">n</a> <a id="3609" href="Ledger.Rewards.html#3609" class="Bound">N</a> <a id="3611" href="Ledger.Rewards.html#3611" class="Bound">pool</a> <a id="3616" href="Ledger.Rewards.html#3616" class="Bound">stakeDistr</a> <a id="3627" href="Ledger.Rewards.html#3627" class="Bound">σ</a> <a id="3629" href="Ledger.Rewards.html#3629" class="Bound">σa</a> <a id="3632" href="Ledger.Rewards.html#3632" class="Bound">tot</a> <a id="3636" class="Symbol">=</a> <a id="3638" href="Ledger.Rewards.html#4348" class="Function">rewards</a>
  <a id="3648" class="Keyword">where</a>
    <a id="3658" href="Ledger.Rewards.html#3658" class="Function">mkRelativeStake</a> <a id="3674" class="Symbol">=</a> <a id="3676" class="Symbol">λ</a> <a id="3678" href="Ledger.Rewards.html#3678" class="Bound">coin</a> <a id="3683" class="Symbol">→</a> <a id="3685" href="Ledger.Types.Numeric.UnitInterval.html#3110" class="Function">clamp</a> <a id="3691" class="Symbol">(</a><a id="3692" href="Ledger.Rewards.html#3678" class="Bound">coin</a> <a id="3697" href="Ledger.Prelude.html#2186" class="Function Operator">/₀</a> <a id="3700" href="Ledger.Rewards.html#3632" class="Bound">tot</a><a id="3703" class="Symbol">)</a>
    <a id="3709" href="Ledger.Rewards.html#3709" class="Function">owners</a> <a id="3716" class="Symbol">=</a> <a id="3718" href="abstract-set-theory.FiniteSetTheory.html#519" class="Function">mapˢ</a> <a id="3723" href="Ledger.Address.html#299" class="InductiveConstructor">KeyHashObj</a> <a id="3734" class="Symbol">(</a><a id="3735" href="Ledger.Rewards.html#3611" class="Bound">pool</a> <a id="3740" class="Symbol">.</a><a id="3741" href="Ledger.Certs.html#1167" class="Field">PoolParams.owners</a><a id="3758" class="Symbol">)</a> 
    <a id="3765" href="Ledger.Rewards.html#3765" class="Function">ownerStake</a> <a id="3776" class="Symbol">=</a> <a id="3778" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">∑[</a> <a id="3781" href="Ledger.Rewards.html#3781" class="Bound">c</a> <a id="3783" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">←</a> <a id="3785" href="Ledger.Rewards.html#3616" class="Bound">stakeDistr</a> <a id="3796" href="Axiom.Set.Map.html#10678" class="Function Operator">∣</a> <a id="3798" href="Ledger.Rewards.html#3709" class="Function">owners</a> <a id="3805" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">]</a> <a id="3807" href="Ledger.Rewards.html#3781" class="Bound">c</a>
    <a id="3813" href="Ledger.Rewards.html#3813" class="Function">pledge</a> <a id="3820" class="Symbol">=</a> <a id="3822" href="Ledger.Rewards.html#3611" class="Bound">pool</a> <a id="3827" class="Symbol">.</a><a id="3828" href="Ledger.Certs.html#1261" class="Field">PoolParams.pledge</a>
    <a id="3850" href="Ledger.Rewards.html#3850" class="Function">maxP</a> <a id="3855" class="Symbol">=</a> <a id="3857" href="Class.ToBool.html#389" class="Function Operator">if</a> <a id="3860" href="Ledger.Rewards.html#3813" class="Function">pledge</a> <a id="3867" href="Class.HasOrder.Core.html#608" class="Field Operator">≤</a> <a id="3869" href="Ledger.Rewards.html#3765" class="Function">ownerStake</a>
      <a id="3886" href="Class.ToBool.html#389" class="Function Operator">then</a> <a id="3891" href="Ledger.Rewards.html#1380" class="Function">maxPool</a> <a id="3899" href="Ledger.Rewards.html#3589" class="Bound">pparams</a> <a id="3907" href="Ledger.Rewards.html#3597" class="Bound">rewardPot</a> <a id="3917" href="Ledger.Rewards.html#3627" class="Bound">σ</a> <a id="3919" class="Symbol">(</a><a id="3920" href="Ledger.Rewards.html#3658" class="Function">mkRelativeStake</a> <a id="3936" href="Ledger.Rewards.html#3813" class="Function">pledge</a><a id="3942" class="Symbol">)</a>
      <a id="3950" href="Class.ToBool.html#389" class="Function Operator">else</a> <a id="3955" class="Number">0</a>
    <a id="3961" href="Ledger.Rewards.html#3961" class="Function">apparentPerformance</a> <a id="3981" class="Symbol">=</a> <a id="3983" href="Ledger.Rewards.html#2197" class="Function">mkApparentPerformance</a> <a id="4005" href="Ledger.Rewards.html#3629" class="Bound">σa</a> <a id="4008" href="Ledger.Rewards.html#3607" class="Bound">n</a> <a id="4010" href="Ledger.Rewards.html#3609" class="Bound">N</a>
    <a id="4016" href="Ledger.Rewards.html#4016" class="Function">poolReward</a> <a id="4027" class="Symbol">=</a> <a id="4029" href="Prelude.html#3167" class="Function">posPart</a> <a id="4037" class="Symbol">(</a><a id="4038" href="Data.Rational.Base.html#7116" class="Function">floor</a> <a id="4044" class="Symbol">(</a><a id="4045" href="Ledger.Rewards.html#3961" class="Function">apparentPerformance</a> <a id="4065" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="4067" href="Ledger.Rewards.html#581" class="Function">fromℕ</a> <a id="4073" href="Ledger.Rewards.html#3850" class="Function">maxP</a><a id="4077" class="Symbol">))</a>
    <a id="4084" href="Ledger.Rewards.html#4084" class="Function">memberRewards</a> <a id="4098" class="Symbol">=</a>
      <a id="4106" href="Axiom.Set.Map.html#6068" class="Function">mapValues</a> <a id="4116" class="Symbol">(λ</a> <a id="4119" href="Ledger.Rewards.html#4119" class="Bound">coin</a> <a id="4124" class="Symbol">→</a> <a id="4126" href="Ledger.Rewards.html#3000" class="Function">rewardMember</a> <a id="4139" href="Ledger.Rewards.html#4016" class="Function">poolReward</a> <a id="4150" href="Ledger.Rewards.html#3611" class="Bound">pool</a> <a id="4155" class="Symbol">(</a><a id="4156" href="Ledger.Rewards.html#3658" class="Function">mkRelativeStake</a> <a id="4172" href="Ledger.Rewards.html#4119" class="Bound">coin</a><a id="4176" class="Symbol">)</a> <a id="4178" href="Ledger.Rewards.html#3627" class="Bound">σ</a><a id="4179" class="Symbol">)</a>
        <a id="4189" class="Symbol">(</a><a id="4190" href="Ledger.Rewards.html#3616" class="Bound">stakeDistr</a> <a id="4201" href="Axiom.Set.Map.html#10748" class="Function Operator">∣</a> <a id="4203" href="Ledger.Rewards.html#3709" class="Function">owners</a> <a id="4210" href="Axiom.Set.Map.html#10748" class="Function Operator">ᶜ</a><a id="4211" class="Symbol">)</a>
    <a id="4217" href="Ledger.Rewards.html#4217" class="Function">ownersRewards</a>  <a id="4232" class="Symbol">=</a>
      <a id="4240" href="Axiom.Set.Map.html#4588" class="Function Operator">❴</a> <a id="4242" href="Ledger.Rewards.html#3611" class="Bound">pool</a> <a id="4247" class="Symbol">.</a><a id="4248" href="Ledger.Certs.html#1288" class="Field">PoolParams.rewardAccount</a>
      <a id="4279" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4281" href="Ledger.Rewards.html#2557" class="Function">rewardOwners</a> <a id="4294" href="Ledger.Rewards.html#4016" class="Function">poolReward</a> <a id="4305" href="Ledger.Rewards.html#3611" class="Bound">pool</a> <a id="4310" class="Symbol">(</a><a id="4311" href="Ledger.Rewards.html#3658" class="Function">mkRelativeStake</a> <a id="4327" href="Ledger.Rewards.html#3765" class="Function">ownerStake</a><a id="4337" class="Symbol">)</a> <a id="4339" href="Ledger.Rewards.html#3627" class="Bound">σ</a> <a id="4341" href="Axiom.Set.Map.html#4588" class="Function Operator">❵ᵐ</a>
    <a id="4348" href="Ledger.Rewards.html#4348" class="Function">rewards</a> <a id="4356" class="Symbol">=</a> <a id="4358" href="Ledger.Rewards.html#4084" class="Function">memberRewards</a> <a id="4372" href="Axiom.Set.Map.Dec.html#1854" class="Function Operator">∪⁺</a> <a id="4375" href="Ledger.Rewards.html#4217" class="Function">ownersRewards</a>


<a id="Delegations"></a><a id="4391" href="Ledger.Rewards.html#4391" class="Function">Delegations</a> <a id="4403" class="Symbol">=</a> <a id="4405" href="Ledger.Address.html#273" class="Datatype">Credential</a> <a id="4416" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="4418" href="Ledger.Crypto.html#1310" class="Function">KeyHash</a>

<a id="poolStake"></a><a id="4427" href="Ledger.Rewards.html#4427" class="Function">poolStake</a>  <a id="4438" class="Symbol">:</a> <a id="4440" href="Ledger.Crypto.html#1310" class="Function">KeyHash</a> <a id="4448" class="Symbol">→</a> <a id="4450" href="Ledger.Rewards.html#4391" class="Function">Delegations</a> <a id="4462" class="Symbol">→</a> <a id="4464" href="Ledger.Rewards.html#3427" class="Function">Stake</a> <a id="4470" class="Symbol">→</a> <a id="4472" href="Ledger.Rewards.html#3427" class="Function">Stake</a>
<a id="4478" href="Ledger.Rewards.html#4427" class="Function">poolStake</a> <a id="4488" href="Ledger.Rewards.html#4488" class="Bound">hk</a> <a id="4491" href="Ledger.Rewards.html#4491" class="Bound">delegs</a> <a id="4498" href="Ledger.Rewards.html#4498" class="Bound">stake</a> <a id="4504" class="Symbol">=</a> <a id="4506" href="Ledger.Rewards.html#4498" class="Bound">stake</a> <a id="4512" href="Axiom.Set.Map.html#10678" class="Function Operator">∣</a> <a id="4514" href="Class.IsSet.html#916" class="Function">dom</a> <a id="4518" class="Symbol">(</a><a id="4519" href="Ledger.Rewards.html#4491" class="Bound">delegs</a> <a id="4526" href="Axiom.Set.Map.html#14048" class="Function Operator">∣^</a> <a id="4529" href="Class.HasSingleton.html#288" class="Field Operator">❴</a> <a id="4531" href="Ledger.Rewards.html#4488" class="Bound">hk</a> <a id="4534" href="Class.HasSingleton.html#288" class="Field Operator">❵</a><a id="4535" class="Symbol">)</a>


<a id="BlocksMade"></a><a id="4539" href="Ledger.Rewards.html#4539" class="Function">BlocksMade</a> <a id="4550" class="Symbol">=</a> <a id="4552" href="Ledger.Crypto.html#1310" class="Function">KeyHash</a> <a id="4560" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="4562" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>

<a id="uncurryᵐ"></a><a id="4565" href="Ledger.Rewards.html#4565" class="Function">uncurryᵐ</a> <a id="4574" class="Symbol">:</a>


  <a id="4580" class="Symbol">∀</a> <a id="4582" class="Symbol">{</a><a id="4583" href="Ledger.Rewards.html#4583" class="Bound">A</a> <a id="4585" href="Ledger.Rewards.html#4585" class="Bound">B</a> <a id="4587" href="Ledger.Rewards.html#4587" class="Bound">C</a> <a id="4589" class="Symbol">:</a> <a id="4591" href="Agda.Primitive.html#388" class="Primitive">Type</a><a id="4595" class="Symbol">}</a> <a id="4597" class="Symbol">⦃</a> <a id="4599" href="Ledger.Rewards.html#4599" class="Bound">_</a> <a id="4601" class="Symbol">:</a> <a id="4603" href="Class.DecEq.Core.html#117" class="Record">DecEq</a> <a id="4609" href="Ledger.Rewards.html#4583" class="Bound">A</a> <a id="4611" class="Symbol">⦄</a> <a id="4613" class="Symbol">⦃</a> <a id="4615" href="Ledger.Rewards.html#4615" class="Bound">_</a> <a id="4617" class="Symbol">:</a> <a id="4619" href="Class.DecEq.Core.html#117" class="Record">DecEq</a> <a id="4625" href="Ledger.Rewards.html#4585" class="Bound">B</a> <a id="4627" class="Symbol">⦄</a> <a id="4629" class="Symbol">→</a>


  <a id="4635" href="Ledger.Rewards.html#4583" class="Bound">A</a> <a id="4637" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="4639" class="Symbol">(</a><a id="4640" href="Ledger.Rewards.html#4585" class="Bound">B</a> <a id="4642" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="4644" href="Ledger.Rewards.html#4587" class="Bound">C</a><a id="4645" class="Symbol">)</a> <a id="4647" class="Symbol">→</a> <a id="4649" class="Symbol">(</a><a id="4650" href="Ledger.Rewards.html#4583" class="Bound">A</a> <a id="4652" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="4654" href="Ledger.Rewards.html#4585" class="Bound">B</a><a id="4655" class="Symbol">)</a> <a id="4657" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="4659" href="Ledger.Rewards.html#4587" class="Bound">C</a>


<a id="4663" href="Ledger.Rewards.html#4565" class="Function">uncurryᵐ</a> <a id="4672" class="Symbol">{</a><a id="4673" href="Ledger.Rewards.html#4673" class="Bound">A</a><a id="4674" class="Symbol">}</a> <a id="4676" class="Symbol">{</a><a id="4677" href="Ledger.Rewards.html#4677" class="Bound">B</a><a id="4678" class="Symbol">}</a> <a id="4680" class="Symbol">{</a><a id="4681" href="Ledger.Rewards.html#4681" class="Bound">C</a><a id="4682" class="Symbol">}</a> <a id="4684" href="Ledger.Rewards.html#4684" class="Bound">abc</a> <a id="4688" class="Symbol">=</a> <a id="4690" href="Axiom.Set.Map.html#10460" class="Function">mapFromPartialFun</a> <a id="4708" href="Ledger.Rewards.html#4736" class="Function">lookup&#39;</a> <a id="4716" href="Ledger.Rewards.html#4894" class="Function">domain&#39;</a>
  <a id="4726" class="Keyword">where</a>
    <a id="4736" href="Ledger.Rewards.html#4736" class="Function">lookup&#39;</a> <a id="4744" class="Symbol">:</a> <a id="4746" class="Symbol">(</a><a id="4747" href="Ledger.Rewards.html#4673" class="Bound">A</a> <a id="4749" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="4751" href="Ledger.Rewards.html#4677" class="Bound">B</a><a id="4752" class="Symbol">)</a> <a id="4754" class="Symbol">→</a> <a id="4756" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="4762" href="Ledger.Rewards.html#4681" class="Bound">C</a>
    <a id="4768" href="Ledger.Rewards.html#4736" class="Function">lookup&#39;</a> <a id="4776" class="Symbol">(</a><a id="4777" href="Ledger.Rewards.html#4777" class="Bound">a</a> <a id="4779" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4781" href="Ledger.Rewards.html#4781" class="Bound">b</a><a id="4782" class="Symbol">)</a> <a id="4784" class="Symbol">=</a> <a id="4786" href="Axiom.Set.Map.html#13670" class="Function">lookupᵐ?</a> <a id="4795" href="Ledger.Rewards.html#4684" class="Bound">abc</a> <a id="4799" href="Ledger.Rewards.html#4777" class="Bound">a</a> <a id="4801" href="Class.Monad.Core.html#299" class="Field Operator">&gt;&gt;=</a> <a id="4805" class="Symbol">(λ</a> <a id="4808" href="Ledger.Rewards.html#4808" class="Bound">bc</a> <a id="4811" class="Symbol">→</a> <a id="4813" href="Axiom.Set.Map.html#13670" class="Function">lookupᵐ?</a> <a id="4822" href="Ledger.Rewards.html#4808" class="Bound">bc</a> <a id="4825" href="Ledger.Rewards.html#4781" class="Bound">b</a><a id="4826" class="Symbol">)</a>

    <a id="4833" href="Ledger.Rewards.html#4833" class="Function">joinˢ</a> <a id="4839" class="Symbol">:</a> <a id="4841" class="Symbol">∀</a> <a id="4843" class="Symbol">{</a><a id="4844" href="Ledger.Rewards.html#4844" class="Bound">X</a><a id="4845" class="Symbol">}</a> <a id="4847" class="Symbol">→</a> <a id="4849" href="abstract-set-theory.FiniteSetTheory.html#488" class="Function Operator">ℙ</a> <a id="4851" class="Symbol">(</a><a id="4852" href="abstract-set-theory.FiniteSetTheory.html#488" class="Function Operator">ℙ</a> <a id="4854" href="Ledger.Rewards.html#4844" class="Bound">X</a><a id="4855" class="Symbol">)</a> <a id="4857" class="Symbol">→</a> <a id="4859" href="abstract-set-theory.FiniteSetTheory.html#488" class="Function Operator">ℙ</a> <a id="4861" href="Ledger.Rewards.html#4844" class="Bound">X</a>
    <a id="4867" href="Ledger.Rewards.html#4833" class="Function">joinˢ</a> <a id="4873" class="Symbol">=</a> <a id="4875" href="Axiom.Set.html#7022" class="Function">concatMapˢ</a> <a id="4886" href="Function.Base.html#704" class="Function">id</a>

    <a id="4894" href="Ledger.Rewards.html#4894" class="Function">domain&#39;</a> <a id="4902" class="Symbol">:</a> <a id="4904" href="abstract-set-theory.FiniteSetTheory.html#488" class="Function Operator">ℙ</a> <a id="4906" class="Symbol">(</a><a id="4907" href="Ledger.Rewards.html#4673" class="Bound">A</a> <a id="4909" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="4911" href="Ledger.Rewards.html#4677" class="Bound">B</a><a id="4912" class="Symbol">)</a>
    <a id="4918" href="Ledger.Rewards.html#4894" class="Function">domain&#39;</a> <a id="4926" class="Symbol">=</a> <a id="4928" href="Ledger.Rewards.html#4833" class="Function">joinˢ</a> <a id="4934" class="Symbol">(</a><a id="4935" href="Class.IsSet.html#959" class="Function">range</a> <a id="4941" class="Symbol">(</a><a id="4942" href="Axiom.Set.Map.html#8706" class="Function">mapWithKey</a> <a id="4953" class="Symbol">(λ</a> <a id="4956" href="Ledger.Rewards.html#4956" class="Bound">a</a> <a id="4958" href="Ledger.Rewards.html#4958" class="Bound">bc</a> <a id="4961" class="Symbol">→</a> <a id="4963" href="Class.IsSet.html#959" class="Function">range</a> <a id="4969" class="Symbol">(</a><a id="4970" href="Axiom.Set.Map.html#8706" class="Function">mapWithKey</a> <a id="4981" class="Symbol">(λ</a> <a id="4984" href="Ledger.Rewards.html#4984" class="Bound">b</a> <a id="4986" href="Ledger.Rewards.html#4986" class="Bound">_</a> <a id="4988" class="Symbol">→</a> <a id="4990" class="Symbol">(</a><a id="4991" href="Ledger.Rewards.html#4956" class="Bound">a</a> <a id="4993" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4995" href="Ledger.Rewards.html#4984" class="Bound">b</a><a id="4996" class="Symbol">))</a> <a id="4999" href="Ledger.Rewards.html#4958" class="Bound">bc</a><a id="5001" class="Symbol">))</a> <a id="5004" href="Ledger.Rewards.html#4684" class="Bound">abc</a><a id="5007" class="Symbol">))</a>



<a id="reward"></a><a id="5013" href="Ledger.Rewards.html#5013" class="Function">reward</a> <a id="5020" class="Symbol">:</a> <a id="5022" href="Ledger.PParams.html#1570" class="Record">PParams</a> <a id="5030" class="Symbol">→</a> <a id="5032" href="Ledger.Rewards.html#4539" class="Function">BlocksMade</a> <a id="5043" class="Symbol">→</a> <a id="5045" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="5050" class="Symbol">→</a> <a id="5052" class="Symbol">(</a><a id="5053" href="Ledger.Crypto.html#1310" class="Function">KeyHash</a> <a id="5061" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="5063" href="Ledger.Certs.html#1131" class="Record">PoolParams</a><a id="5073" class="Symbol">)</a>
  <a id="5077" class="Symbol">→</a> <a id="5079" href="Ledger.Rewards.html#3427" class="Function">Stake</a> <a id="5085" class="Symbol">→</a> <a id="5087" href="Ledger.Rewards.html#4391" class="Function">Delegations</a> <a id="5099" class="Symbol">→</a> <a id="5101" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="5106" class="Symbol">→</a> <a id="5108" class="Symbol">(</a><a id="5109" href="Ledger.Address.html#273" class="Datatype">Credential</a> <a id="5120" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="5122" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a><a id="5126" class="Symbol">)</a>
<a id="5128" href="Ledger.Rewards.html#5013" class="Function">reward</a> <a id="5135" href="Ledger.Rewards.html#5135" class="Bound">pp</a> <a id="5138" href="Ledger.Rewards.html#5138" class="Bound">blocks</a> <a id="5145" href="Ledger.Rewards.html#5145" class="Bound">rewardPot</a> <a id="5155" href="Ledger.Rewards.html#5155" class="Bound">poolParams</a> <a id="5166" href="Ledger.Rewards.html#5166" class="Bound">stake</a> <a id="5172" href="Ledger.Rewards.html#5172" class="Bound">delegs</a> <a id="5179" href="Ledger.Rewards.html#5179" class="Bound">total</a> <a id="5185" class="Symbol">=</a> <a id="5187" href="Ledger.Rewards.html#5712" class="Function">rewards</a>
  <a id="5197" class="Keyword">where</a>
    <a id="5207" href="Ledger.Rewards.html#5207" class="Function">active</a> <a id="5214" class="Symbol">=</a> <a id="5216" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">∑[</a> <a id="5219" href="Ledger.Rewards.html#5219" class="Bound">c</a> <a id="5221" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">←</a> <a id="5223" href="Ledger.Rewards.html#5166" class="Bound">stake</a> <a id="5229" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">]</a> <a id="5231" href="Ledger.Rewards.html#5219" class="Bound">c</a>
    <a id="5237" href="Ledger.Rewards.html#5237" class="Function Operator">Σ_/total</a> <a id="5246" class="Symbol">=</a> <a id="5248" class="Symbol">λ</a> <a id="5250" href="Ledger.Rewards.html#5250" class="Bound">st</a> <a id="5253" class="Symbol">→</a> <a id="5255" href="Ledger.Types.Numeric.UnitInterval.html#3110" class="Function">clamp</a> <a id="5261" class="Symbol">((</a><a id="5263" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">∑[</a> <a id="5266" href="Ledger.Rewards.html#5266" class="Bound">c</a> <a id="5268" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">←</a> <a id="5270" href="Ledger.Rewards.html#5250" class="Bound">st</a> <a id="5273" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">]</a> <a id="5275" href="Ledger.Rewards.html#5266" class="Bound">c</a><a id="5276" class="Symbol">)</a> <a id="5278" href="Ledger.Prelude.html#2186" class="Function Operator">/₀</a> <a id="5281" href="Ledger.Rewards.html#5179" class="Bound">total</a><a id="5286" class="Symbol">)</a>
    <a id="5292" href="Ledger.Rewards.html#5292" class="Function Operator">Σ_/active</a> <a id="5302" class="Symbol">=</a> <a id="5304" class="Symbol">λ</a> <a id="5306" href="Ledger.Rewards.html#5306" class="Bound">st</a> <a id="5309" class="Symbol">→</a> <a id="5311" href="Ledger.Types.Numeric.UnitInterval.html#3110" class="Function">clamp</a> <a id="5317" class="Symbol">((</a><a id="5319" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">∑[</a> <a id="5322" href="Ledger.Rewards.html#5322" class="Bound">c</a> <a id="5324" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">←</a> <a id="5326" href="Ledger.Rewards.html#5306" class="Bound">st</a> <a id="5329" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">]</a> <a id="5331" href="Ledger.Rewards.html#5322" class="Bound">c</a><a id="5332" class="Symbol">)</a> <a id="5334" href="Ledger.Prelude.html#2186" class="Function Operator">/₀</a> <a id="5337" href="Ledger.Rewards.html#5207" class="Function">active</a><a id="5343" class="Symbol">)</a>
    <a id="5349" href="Ledger.Rewards.html#5349" class="Function">N</a> <a id="5351" class="Symbol">=</a> <a id="5353" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">∑[</a> <a id="5356" href="Ledger.Rewards.html#5356" class="Bound">m</a> <a id="5358" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">←</a> <a id="5360" href="Ledger.Rewards.html#5138" class="Bound">blocks</a> <a id="5367" href="abstract-set-theory.FiniteSetTheory.html#3166" class="Function">]</a> <a id="5369" href="Ledger.Rewards.html#5356" class="Bound">m</a>
    <a id="5375" href="Ledger.Rewards.html#5375" class="Function">mkPoolData</a> <a id="5386" class="Symbol">=</a> <a id="5388" class="Symbol">λ</a> <a id="5390" href="Ledger.Rewards.html#5390" class="Bound">hk</a> <a id="5393" href="Ledger.Rewards.html#5393" class="Bound">p</a> <a id="5395" class="Symbol">→</a>
      <a id="5403" href="Class.Functor.Core.html#272" class="Function">map</a> <a id="5407" class="Symbol">(λ</a> <a id="5410" href="Ledger.Rewards.html#5410" class="Bound">n</a> <a id="5412" class="Symbol">→</a> <a id="5414" class="Symbol">(</a><a id="5415" href="Ledger.Rewards.html#5410" class="Bound">n</a> <a id="5417" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="5419" href="Ledger.Rewards.html#5393" class="Bound">p</a> <a id="5421" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="5423" href="Ledger.Rewards.html#4427" class="Function">poolStake</a> <a id="5433" href="Ledger.Rewards.html#5390" class="Bound">hk</a> <a id="5436" href="Ledger.Rewards.html#5172" class="Bound">delegs</a> <a id="5443" href="Ledger.Rewards.html#5166" class="Bound">stake</a><a id="5448" class="Symbol">))</a> <a id="5451" class="Symbol">(</a><a id="5452" href="Axiom.Set.Map.html#13670" class="Function">lookupᵐ?</a> <a id="5461" href="Ledger.Rewards.html#5138" class="Bound">blocks</a> <a id="5468" href="Ledger.Rewards.html#5390" class="Bound">hk</a><a id="5470" class="Symbol">)</a>
    <a id="5476" href="Ledger.Rewards.html#5476" class="Function">pdata</a> <a id="5482" class="Symbol">=</a> <a id="5484" href="Axiom.Set.Map.html#10313" class="Function">mapMaybeWithKeyᵐ</a> <a id="5501" href="Ledger.Rewards.html#5375" class="Function">mkPoolData</a> <a id="5512" href="Ledger.Rewards.html#5155" class="Bound">poolParams</a>

    <a id="5528" href="Ledger.Rewards.html#5528" class="Function">results</a>  <a id="5537" class="Symbol">:</a> <a id="5539" class="Symbol">(</a><a id="5540" href="Ledger.Crypto.html#1310" class="Function">KeyHash</a> <a id="5548" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="5550" href="Ledger.Address.html#273" class="Datatype">Credential</a><a id="5560" class="Symbol">)</a> <a id="5562" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="5564" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
    <a id="5573" href="Ledger.Rewards.html#5528" class="Function">results</a> <a id="5581" class="Symbol">=</a> <a id="5583" href="Ledger.Rewards.html#4565" class="Function">uncurryᵐ</a> <a id="5592" class="Symbol">(</a><a id="5593" href="Axiom.Set.Map.html#6068" class="Function">mapValues</a> <a id="5603" class="Symbol">(λ</a> <a id="5606" class="Symbol">(</a><a id="5607" href="Ledger.Rewards.html#5607" class="Bound">n</a> <a id="5609" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="5611" href="Ledger.Rewards.html#5611" class="Bound">p</a> <a id="5613" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="5615" href="Ledger.Rewards.html#5615" class="Bound">s</a><a id="5616" class="Symbol">)</a>
      <a id="5624" class="Symbol">→</a> <a id="5626" href="Ledger.Rewards.html#3454" class="Function">rewardOnePool</a> <a id="5640" href="Ledger.Rewards.html#5135" class="Bound">pp</a> <a id="5643" href="Ledger.Rewards.html#5145" class="Bound">rewardPot</a> <a id="5653" href="Ledger.Rewards.html#5607" class="Bound">n</a> <a id="5655" href="Ledger.Rewards.html#5349" class="Function">N</a> <a id="5657" href="Ledger.Rewards.html#5611" class="Bound">p</a> <a id="5659" href="Ledger.Rewards.html#5615" class="Bound">s</a> <a id="5661" class="Symbol">(</a><a id="5662" href="Ledger.Rewards.html#5237" class="Function Operator">Σ</a> <a id="5664" href="Ledger.Rewards.html#5615" class="Bound">s</a> <a id="5666" href="Ledger.Rewards.html#5237" class="Function Operator">/total</a><a id="5672" class="Symbol">)</a> <a id="5674" class="Symbol">(</a><a id="5675" href="Ledger.Rewards.html#5292" class="Function Operator">Σ</a> <a id="5677" href="Ledger.Rewards.html#5615" class="Bound">s</a> <a id="5679" href="Ledger.Rewards.html#5292" class="Function Operator">/active</a><a id="5686" class="Symbol">)</a> <a id="5688" href="Ledger.Rewards.html#5179" class="Bound">total</a><a id="5693" class="Symbol">)</a>
      <a id="5701" href="Ledger.Rewards.html#5476" class="Function">pdata</a><a id="5706" class="Symbol">)</a>
    <a id="5712" href="Ledger.Rewards.html#5712" class="Function">rewards</a>  <a id="5721" class="Symbol">=</a> <a id="5723" href="abstract-set-theory.FiniteSetTheory.html#3599" class="Function">aggregateBy</a>
      <a id="5741" class="Symbol">(</a><a id="5742" href="abstract-set-theory.FiniteSetTheory.html#519" class="Function">mapˢ</a> <a id="5747" class="Symbol">(λ</a> <a id="5750" class="Symbol">(</a><a id="5751" href="Ledger.Rewards.html#5751" class="Bound">kh</a> <a id="5754" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="5756" href="Ledger.Rewards.html#5756" class="Bound">cred</a><a id="5760" class="Symbol">)</a> <a id="5762" class="Symbol">→</a> <a id="5764" class="Symbol">(</a><a id="5765" href="Ledger.Rewards.html#5751" class="Bound">kh</a> <a id="5768" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="5770" href="Ledger.Rewards.html#5756" class="Bound">cred</a><a id="5774" class="Symbol">)</a> <a id="5776" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="5778" href="Ledger.Rewards.html#5756" class="Bound">cred</a><a id="5782" class="Symbol">)</a> <a id="5784" class="Symbol">(</a><a id="5785" href="Class.IsSet.html#916" class="Function">dom</a> <a id="5789" href="Ledger.Rewards.html#5528" class="Function">results</a><a id="5796" class="Symbol">))</a>
      <a id="5805" href="Ledger.Rewards.html#5528" class="Function">results</a>


<a id="5815" class="Keyword">record</a> <a id="RewardUpdate"></a><a id="5822" href="Ledger.Rewards.html#5822" class="Record">RewardUpdate</a> <a id="5835" class="Symbol">:</a> <a id="5837" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="5841" class="Keyword">where</a>


  <a id="5851" class="Keyword">constructor</a> <a id="⟦_,_,_,_⟧ʳᵘ"></a><a id="5863" href="Ledger.Rewards.html#5863" class="InductiveConstructor Operator">⟦_,_,_,_⟧ʳᵘ</a>


  <a id="5879" class="Keyword">field</a>
    <a id="RewardUpdate.Δt"></a><a id="5889" href="Ledger.Rewards.html#5889" class="Field">Δt</a> <a id="RewardUpdate.Δr"></a><a id="5892" href="Ledger.Rewards.html#5892" class="Field">Δr</a> <a id="RewardUpdate.Δf"></a><a id="5895" href="Ledger.Rewards.html#5895" class="Field">Δf</a> <a id="5898" class="Symbol">:</a> <a id="5900" href="Agda.Builtin.Int.html#245" class="Datatype">ℤ</a>
    <a id="RewardUpdate.rs"></a><a id="5906" href="Ledger.Rewards.html#5906" class="Field">rs</a> <a id="5909" class="Symbol">:</a> <a id="5911" href="Ledger.Address.html#273" class="Datatype">Credential</a> <a id="5922" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="5924" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>


<a id="5931" class="Keyword">record</a> <a id="Snapshot"></a><a id="5938" href="Ledger.Rewards.html#5938" class="Record">Snapshot</a> <a id="5947" class="Symbol">:</a> <a id="5949" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="5953" class="Keyword">where</a>
  <a id="5961" class="Keyword">field</a>
    <a id="Snapshot.stake"></a><a id="5971" href="Ledger.Rewards.html#5971" class="Field">stake</a>           <a id="5987" class="Symbol">:</a> <a id="5989" href="Ledger.Address.html#273" class="Datatype">Credential</a> <a id="6000" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="6002" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
    <a id="Snapshot.delegations"></a><a id="6011" href="Ledger.Rewards.html#6011" class="Field">delegations</a>     <a id="6027" class="Symbol">:</a> <a id="6029" href="Ledger.Address.html#273" class="Datatype">Credential</a> <a id="6040" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="6042" href="Ledger.Crypto.html#1310" class="Function">KeyHash</a>
    <a id="Snapshot.poolParameters"></a><a id="6054" href="Ledger.Rewards.html#6054" class="Field">poolParameters</a>  <a id="6070" class="Symbol">:</a> <a id="6072" href="Ledger.Crypto.html#1310" class="Function">KeyHash</a> <a id="6080" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="6082" href="Ledger.Certs.html#1131" class="Record">PoolParams</a>



<a id="6096" class="Keyword">instance</a>
  <a id="6107" class="Keyword">unquoteDecl</a> <a id="HasCast-Snapshot"></a><a id="6119" href="Ledger.Rewards.html#6119" class="Function">HasCast-Snapshot</a> <a id="6136" class="Symbol">=</a>
    <a id="6142" href="stdlib-classes.Class.HasCast.Derive.html#2690" class="Function">derive-HasCast</a> <a id="6157" href="Data.List.Base.html#5205" class="Function Operator">[</a> <a id="6159" class="Symbol">(</a><a id="6160" class="Keyword">quote</a> <a id="6166" href="Ledger.Rewards.html#5938" class="Record">Snapshot</a> <a id="6175" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6177" href="Ledger.Rewards.html#6119" class="Function">HasCast-Snapshot</a><a id="6193" class="Symbol">)</a> <a id="6195" href="Data.List.Base.html#5205" class="Function Operator">]</a>


<a id="6199" class="Keyword">private</a>
  <a id="getStakeCred"></a><a id="6209" href="Ledger.Rewards.html#6209" class="Function">getStakeCred</a> <a id="6222" class="Symbol">:</a> <a id="6224" href="Ledger.Transaction.html#2293" class="Function">TxOut</a> <a id="6230" class="Symbol">→</a> <a id="6232" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="6238" href="Ledger.Address.html#273" class="Datatype">Credential</a>
  <a id="6251" href="Ledger.Rewards.html#6209" class="Function">getStakeCred</a> <a id="6264" class="Symbol">(</a><a id="6265" href="Ledger.Rewards.html#6265" class="Bound">a</a> <a id="6267" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6269" class="Symbol">_</a> <a id="6271" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6273" class="Symbol">_</a> <a id="6275" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6277" class="Symbol">_)</a> <a id="6280" class="Symbol">=</a> <a id="6282" href="Ledger.Address.html#2509" class="Function">stakeCred</a> <a id="6292" href="Ledger.Rewards.html#6265" class="Bound">a</a>


<a id="stakeDistr"></a><a id="6296" href="Ledger.Rewards.html#6296" class="Function">stakeDistr</a> <a id="6307" class="Symbol">:</a> <a id="6309" href="Ledger.Transaction.html#2361" class="Function">UTxO</a> <a id="6314" class="Symbol">→</a> <a id="6316" href="Ledger.Certs.html#3171" class="Record">DState</a> <a id="6323" class="Symbol">→</a> <a id="6325" href="Ledger.Certs.html#3781" class="Record">PState</a> <a id="6332" class="Symbol">→</a> <a id="6334" href="Ledger.Rewards.html#5938" class="Record">Snapshot</a>
<a id="6343" href="Ledger.Rewards.html#6296" class="Function">stakeDistr</a> <a id="6354" href="Ledger.Rewards.html#6354" class="Bound">utxo</a> <a id="6359" href="Ledger.Rewards.html#6359" class="Bound">stᵈ</a> <a id="6363" href="Ledger.Rewards.html#6363" class="Bound">pState</a> <a id="6370" class="Symbol">=</a>
    <a id="6376" href="Ledger.Prelude.html#2441" class="Function Operator">⟦</a> <a id="6378" href="Axiom.Set.Map.Dec.html#1932" class="Function">aggregate₊</a> <a id="6389" class="Symbol">(</a><a id="6390" href="Ledger.Rewards.html#6627" class="Function">stakeRelation</a> <a id="6404" href="abstract-set-theory.FiniteSetTheory.html#2767" class="Function Operator">ᶠˢ</a><a id="6406" class="Symbol">)</a> <a id="6408" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6410" href="Ledger.Certs.html#3269" class="Function">stakeDelegs</a> <a id="6422" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6424" href="Ledger.Rewards.html#6449" class="Function">poolParams</a> <a id="6435" href="Ledger.Prelude.html#2441" class="Function Operator">⟧</a>
  <a id="6439" class="Keyword">where</a>
    <a id="6449" href="Ledger.Rewards.html#6449" class="Function">poolParams</a> <a id="6460" class="Symbol">=</a> <a id="6462" href="Ledger.Rewards.html#6363" class="Bound">pState</a> <a id="6469" class="Symbol">.</a><a id="6470" href="Ledger.Certs.html#3813" class="Field">PState.pools</a>
    <a id="6487" class="Keyword">open</a> <a id="6492" href="Ledger.Certs.html#3171" class="Module">DState</a> <a id="6499" href="Ledger.Rewards.html#6359" class="Bound">stᵈ</a> <a id="6503" class="Keyword">using</a> <a id="6509" class="Symbol">(</a><a id="6510" href="Ledger.Certs.html#3269" class="Field">stakeDelegs</a><a id="6521" class="Symbol">;</a> <a id="6523" href="Ledger.Certs.html#3309" class="Field">rewards</a><a id="6530" class="Symbol">)</a>
    <a id="6536" href="Ledger.Rewards.html#6536" class="Function">m</a> <a id="6538" class="Symbol">=</a> <a id="6540" href="abstract-set-theory.FiniteSetTheory.html#519" class="Function">mapˢ</a> <a id="6545" class="Symbol">(λ</a> <a id="6548" href="Ledger.Rewards.html#6548" class="Bound">a</a> <a id="6550" class="Symbol">→</a> <a id="6552" class="Symbol">(</a><a id="6553" href="Ledger.Rewards.html#6548" class="Bound">a</a> <a id="6555" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6557" href="Ledger.Utxo.html#3643" class="Function">cbalance</a> <a id="6566" class="Symbol">(</a><a id="6567" href="Ledger.Rewards.html#6354" class="Bound">utxo</a> <a id="6572" href="abstract-set-theory.FiniteSetTheory.html#3088" class="Function Operator">∣^&#39;</a> <a id="6576" class="Symbol">λ</a> <a id="6578" href="Ledger.Rewards.html#6578" class="Bound">i</a> <a id="6580" class="Symbol">→</a> <a id="6582" href="Ledger.Rewards.html#6209" class="Function">getStakeCred</a> <a id="6595" href="Ledger.Rewards.html#6578" class="Bound">i</a> <a id="6597" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="6599" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="6604" href="Ledger.Rewards.html#6548" class="Bound">a</a><a id="6605" class="Symbol">)))</a> <a id="6609" class="Symbol">(</a><a id="6610" href="Class.IsSet.html#916" class="Function">dom</a> <a id="6614" href="Ledger.Certs.html#3309" class="Function">rewards</a><a id="6621" class="Symbol">)</a>
    <a id="6627" href="Ledger.Rewards.html#6627" class="Function">stakeRelation</a> <a id="6641" class="Symbol">=</a> <a id="6643" href="Ledger.Rewards.html#6536" class="Function">m</a> <a id="6645" href="Axiom.Set.html#8952" class="Function Operator">∪</a> <a id="6647" href="Ledger.Prelude.html#2543" class="Function Operator">∣</a> <a id="6649" href="Ledger.Certs.html#3309" class="Function">rewards</a> <a id="6657" href="Ledger.Prelude.html#2543" class="Function Operator">∣</a>


<a id="6661" class="Keyword">record</a> <a id="Snapshots"></a><a id="6668" href="Ledger.Rewards.html#6668" class="Record">Snapshots</a> <a id="6678" class="Symbol">:</a> <a id="6680" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="6684" class="Keyword">where</a>
  <a id="6692" class="Keyword">field</a>
    <a id="Snapshots.mark"></a><a id="6702" href="Ledger.Rewards.html#6702" class="Field">mark</a> <a id="Snapshots.set"></a><a id="6707" href="Ledger.Rewards.html#6707" class="Field">set</a> <a id="Snapshots.go"></a><a id="6711" href="Ledger.Rewards.html#6711" class="Field">go</a>  <a id="6715" class="Symbol">:</a> <a id="6717" href="Ledger.Rewards.html#5938" class="Record">Snapshot</a>
    <a id="Snapshots.feeSS"></a><a id="6730" href="Ledger.Rewards.html#6730" class="Field">feeSS</a>        <a id="6743" class="Symbol">:</a> <a id="6745" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>



<a id="6753" class="Keyword">instance</a>
  <a id="6764" class="Keyword">unquoteDecl</a> <a id="HasCast-Snapshots"></a><a id="6776" href="Ledger.Rewards.html#6776" class="Function">HasCast-Snapshots</a> <a id="6794" class="Symbol">=</a>
    <a id="6800" href="stdlib-classes.Class.HasCast.Derive.html#2690" class="Function">derive-HasCast</a> <a id="6815" href="Data.List.Base.html#5205" class="Function Operator">[</a> <a id="6817" class="Symbol">(</a><a id="6818" class="Keyword">quote</a> <a id="6824" href="Ledger.Rewards.html#6668" class="Record">Snapshots</a> <a id="6834" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6836" href="Ledger.Rewards.html#6776" class="Function">HasCast-Snapshots</a><a id="6853" class="Symbol">)</a> <a id="6855" href="Data.List.Base.html#5205" class="Function Operator">]</a>


<a id="6859" class="Keyword">private</a> <a id="6867" class="Keyword">variable</a>
  <a id="6878" href="Ledger.Rewards.html#6878" class="Generalizable">lstate</a> <a id="6885" class="Symbol">:</a> <a id="6887" href="Ledger.Ledger.html#809" class="Record">LState</a>
  <a id="6896" href="Ledger.Rewards.html#6896" class="Generalizable">mark</a> <a id="6901" href="Ledger.Rewards.html#6901" class="Generalizable">set</a> <a id="6905" href="Ledger.Rewards.html#6905" class="Generalizable">go</a> <a id="6908" class="Symbol">:</a> <a id="6910" href="Ledger.Rewards.html#5938" class="Record">Snapshot</a>
  <a id="6921" href="Ledger.Rewards.html#6921" class="Generalizable">feeSS</a> <a id="6927" class="Symbol">:</a> <a id="6929" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>


<a id="6936" class="Keyword">data</a> <a id="_⊢_⇀⦇_,SNAP⦈_"></a><a id="6941" href="Ledger.Rewards.html#6941" class="Datatype Operator">_⊢_⇀⦇_,SNAP⦈_</a> <a id="6955" class="Symbol">:</a> <a id="6957" href="Ledger.Ledger.html#809" class="Record">LState</a> <a id="6964" class="Symbol">→</a> <a id="6966" href="Ledger.Rewards.html#6668" class="Record">Snapshots</a> <a id="6976" class="Symbol">→</a> <a id="6978" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a> <a id="6980" class="Symbol">→</a> <a id="6982" href="Ledger.Rewards.html#6668" class="Record">Snapshots</a> <a id="6992" class="Symbol">→</a> <a id="6994" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="6999" class="Keyword">where</a>
  <a id="_⊢_⇀⦇_,SNAP⦈_.SNAP"></a><a id="7007" href="Ledger.Rewards.html#7007" class="InductiveConstructor">SNAP</a> <a id="7012" class="Symbol">:</a> <a id="7014" class="Keyword">let</a> <a id="7018" class="Keyword">open</a> <a id="7023" href="Ledger.Ledger.html#809" class="Module">LState</a> <a id="7030" href="Ledger.Rewards.html#6878" class="Generalizable">lstate</a><a id="7036" class="Symbol">;</a> <a id="7038" class="Keyword">open</a> <a id="7043" href="Ledger.Utxo.html#2705" class="Module">UTxOState</a> <a id="7053" href="Ledger.Ledger.html#868" class="Function">utxoSt</a><a id="7059" class="Symbol">;</a> <a id="7061" class="Keyword">open</a> <a id="7066" href="Ledger.Certs.html#4327" class="Module">CertState</a> <a id="7076" href="Ledger.Ledger.html#921" class="Function">certState</a>
             <a id="7099" href="Ledger.Rewards.html#7099" class="Bound">stake</a> <a id="7105" class="Symbol">=</a> <a id="7107" href="Ledger.Rewards.html#6296" class="Function">stakeDistr</a> <a id="7118" href="Ledger.Utxo.html#2769" class="Function">utxo</a> <a id="7123" href="Ledger.Certs.html#4390" class="Function">dState</a> <a id="7130" href="Ledger.Certs.html#4410" class="Function">pState</a>
    <a id="7141" class="Keyword">in</a>
    <a id="7148" href="Ledger.Rewards.html#6878" class="Generalizable">lstate</a> <a id="7155" href="Ledger.Rewards.html#6941" class="Datatype Operator">⊢</a> <a id="7157" href="Ledger.Prelude.html#2441" class="Function Operator">⟦</a> <a id="7159" href="Ledger.Rewards.html#6896" class="Generalizable">mark</a> <a id="7164" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="7166" href="Ledger.Rewards.html#6901" class="Generalizable">set</a> <a id="7170" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="7172" href="Ledger.Rewards.html#6905" class="Generalizable">go</a> <a id="7175" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="7177" href="Ledger.Rewards.html#6921" class="Generalizable">feeSS</a> <a id="7183" href="Ledger.Prelude.html#2441" class="Function Operator">⟧</a> <a id="7185" href="Ledger.Rewards.html#6941" class="Datatype Operator">⇀⦇</a> <a id="7188" href="Agda.Builtin.Unit.html#212" class="InductiveConstructor">tt</a> <a id="7191" href="Ledger.Rewards.html#6941" class="Datatype Operator">,SNAP⦈</a> <a id="7198" href="Ledger.Prelude.html#2441" class="Function Operator">⟦</a> <a id="7200" href="Ledger.Rewards.html#7099" class="Bound">stake</a> <a id="7206" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="7208" href="Ledger.Rewards.html#6896" class="Generalizable">mark</a> <a id="7213" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="7215" href="Ledger.Rewards.html#6901" class="Generalizable">set</a> <a id="7219" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="7221" href="Ledger.Utxo.html#2791" class="Function">fees</a> <a id="7226" href="Ledger.Prelude.html#2441" class="Function Operator">⟧</a>

</pre></body></html>