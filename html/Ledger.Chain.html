<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Ledger.Chain</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda">
<a id="2" class="Symbol">{-#</a> <a id="6" class="Keyword">OPTIONS</a> <a id="14" class="Pragma">--safe</a> <a id="21" class="Symbol">#-}</a>

<a id="26" class="Keyword">open</a> <a id="31" class="Keyword">import</a> <a id="38" href="Algebra.html" class="Module">Algebra</a>
<a id="46" class="Keyword">open</a> <a id="51" class="Keyword">import</a> <a id="58" href="Data.Nat.Properties.html" class="Module">Data.Nat.Properties</a> <a id="78" class="Keyword">using</a> <a id="84" class="Symbol">(</a><a id="85" href="Data.Nat.Properties.html#17252" class="Function">+-0-monoid</a><a id="95" class="Symbol">)</a>

<a id="98" class="Keyword">open</a> <a id="103" class="Keyword">import</a> <a id="110" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a><a id="124" class="Symbol">;</a> <a id="126" class="Keyword">open</a> <a id="131" href="Function.Bundles.html#4752" class="Module">Equivalence</a>
<a id="143" class="Keyword">open</a> <a id="148" class="Keyword">import</a> <a id="155" href="Ledger.Transaction.html" class="Module">Ledger.Transaction</a>
<a id="174" class="Keyword">open</a> <a id="179" class="Keyword">import</a> <a id="186" href="Ledger.Abstract.html" class="Module">Ledger.Abstract</a>

<a id="203" class="Keyword">module</a> <a id="210" href="Ledger.Chain.html" class="Module">Ledger.Chain</a>
  <a id="225" class="Symbol">(</a><a id="226" href="Ledger.Chain.html#226" class="Bound">txs</a> <a id="230" class="Symbol">:</a> <a id="232" class="Symbol">_)</a> <a id="235" class="Symbol">(</a><a id="236" class="Keyword">open</a> <a id="241" href="Ledger.Transaction.html#867" class="Module">TransactionStructure</a> <a id="262" href="Ledger.Chain.html#226" class="Bound">txs</a><a id="265" class="Symbol">)</a>
  <a id="269" class="Symbol">(</a><a id="270" href="Ledger.Chain.html#270" class="Bound">abs</a> <a id="274" class="Symbol">:</a> <a id="276" href="Ledger.Abstract.html#578" class="Record">AbstractFunctions</a> <a id="294" href="Ledger.Chain.html#226" class="Bound">txs</a><a id="297" class="Symbol">)</a> <a id="299" class="Symbol">(</a><a id="300" class="Keyword">open</a> <a id="305" href="Ledger.Abstract.html#578" class="Module">AbstractFunctions</a> <a id="323" href="Ledger.Chain.html#270" class="Bound">abs</a><a id="326" class="Symbol">)</a>
  <a id="330" class="Keyword">where</a>

<a id="337" class="Keyword">open</a> <a id="342" class="Keyword">import</a> <a id="349" href="Ledger.Enact.html" class="Module">Ledger.Enact</a> <a id="362" href="Ledger.Transaction.html#1809" class="Function">govStructure</a>
<a id="375" class="Keyword">open</a> <a id="380" class="Keyword">import</a> <a id="387" href="Ledger.Ledger.html" class="Module">Ledger.Ledger</a> <a id="401" href="Ledger.Chain.html#226" class="Bound">txs</a> <a id="405" href="Ledger.Chain.html#270" class="Bound">abs</a>
<a id="409" class="Keyword">open</a> <a id="414" class="Keyword">import</a> <a id="421" href="Ledger.Ratify.html" class="Module">Ledger.Ratify</a> <a id="435" href="Ledger.Chain.html#226" class="Bound">txs</a>
<a id="439" class="Keyword">open</a> <a id="444" class="Keyword">import</a> <a id="451" href="Ledger.Utxo.html" class="Module">Ledger.Utxo</a> <a id="463" href="Ledger.Chain.html#226" class="Bound">txs</a> <a id="467" href="Ledger.Chain.html#270" class="Bound">abs</a>
<a id="471" class="Keyword">open</a> <a id="476" class="Keyword">import</a> <a id="483" href="Ledger.Epoch.html" class="Module">Ledger.Epoch</a> <a id="496" href="Ledger.Chain.html#226" class="Bound">txs</a> <a id="500" href="Ledger.Chain.html#270" class="Bound">abs</a>
<a id="504" class="Keyword">open</a> <a id="509" class="Keyword">import</a> <a id="516" href="Ledger.Certs.html" class="Module">Ledger.Certs</a> <a id="529" href="Ledger.Transaction.html#1809" class="Function">govStructure</a>


<a id="544" class="Keyword">record</a> <a id="ChainState"></a><a id="551" href="Ledger.Chain.html#551" class="Record">ChainState</a> <a id="562" class="Symbol">:</a> <a id="564" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="569" class="Keyword">where</a>
  <a id="577" class="Keyword">field</a>
    <a id="ChainState.newEpochState"></a><a id="587" href="Ledger.Chain.html#587" class="Field">newEpochState</a>  <a id="602" class="Symbol">:</a> <a id="604" href="Ledger.Epoch.html#1878" class="Record">NewEpochState</a>

<a id="619" class="Keyword">record</a> <a id="Block"></a><a id="626" href="Ledger.Chain.html#626" class="Record">Block</a> <a id="632" class="Symbol">:</a> <a id="634" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="639" class="Keyword">where</a>
  <a id="647" class="Keyword">field</a>
    <a id="Block.ts"></a><a id="657" href="Ledger.Chain.html#657" class="Field">ts</a>    <a id="663" class="Symbol">:</a> <a id="665" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="670" href="Ledger.Transaction.html#4234" class="Record">Tx</a>
    <a id="Block.slot"></a><a id="677" href="Ledger.Chain.html#677" class="Field">slot</a>  <a id="683" class="Symbol">:</a> <a id="685" href="Ledger.Types.Epoch.html#552" class="Function">Slot</a>


<a id="692" class="Keyword">instance</a>
  <a id="HasNewEpochState-ChainState"></a><a id="703" href="Ledger.Chain.html#703" class="Function">HasNewEpochState-ChainState</a> <a id="731" class="Symbol">:</a> <a id="733" href="Ledger.Epoch.html#2012" class="Record">HasNewEpochState</a> <a id="750" href="Ledger.Chain.html#551" class="Record">ChainState</a>
  <a id="763" href="Ledger.Chain.html#703" class="Function">HasNewEpochState-ChainState</a> <a id="791" class="Symbol">.</a><a id="792" href="Ledger.Epoch.html#2069" class="Field">NewEpochStateOf</a> <a id="808" class="Symbol">=</a> <a id="810" href="Ledger.Chain.html#587" class="Field">ChainState.newEpochState</a>

  <a id="HasEpochState-ChainState"></a><a id="838" href="Ledger.Chain.html#838" class="Function">HasEpochState-ChainState</a> <a id="863" class="Symbol">:</a> <a id="865" href="Ledger.Epoch.html#1301" class="Record">HasEpochState</a> <a id="879" href="Ledger.Chain.html#551" class="Record">ChainState</a> 
  <a id="893" href="Ledger.Chain.html#838" class="Function">HasEpochState-ChainState</a> <a id="918" class="Symbol">.</a><a id="919" href="Ledger.Epoch.html#1355" class="Field">EpochStateOf</a> <a id="932" class="Symbol">=</a> <a id="934" href="Ledger.Epoch.html#1355" class="Field">EpochStateOf</a> <a id="947" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="949" href="Ledger.Epoch.html#2069" class="Field">NewEpochStateOf</a>

  <a id="HasEnactState-ChainState"></a><a id="968" href="Ledger.Chain.html#968" class="Function">HasEnactState-ChainState</a> <a id="993" class="Symbol">:</a> <a id="995" href="Ledger.Enact.html#689" class="Record">HasEnactState</a> <a id="1009" href="Ledger.Chain.html#551" class="Record">ChainState</a> 
  <a id="1023" href="Ledger.Chain.html#968" class="Function">HasEnactState-ChainState</a> <a id="1048" class="Symbol">.</a><a id="1049" href="Ledger.Enact.html#743" class="Field">EnactStateOf</a> <a id="1062" class="Symbol">=</a> <a id="1064" href="Ledger.Enact.html#743" class="Field">EnactStateOf</a> <a id="1077" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="1079" href="Ledger.Epoch.html#1355" class="Field">EpochStateOf</a>

  <a id="HasLState-ChainState"></a><a id="1095" href="Ledger.Chain.html#1095" class="Function">HasLState-ChainState</a> <a id="1116" class="Symbol">:</a> <a id="1118" href="Ledger.Ledger.html#954" class="Record">HasLState</a> <a id="1128" href="Ledger.Chain.html#551" class="Record">ChainState</a>
  <a id="1141" href="Ledger.Chain.html#1095" class="Function">HasLState-ChainState</a> <a id="1162" class="Symbol">.</a><a id="1163" href="Ledger.Ledger.html#1004" class="Field">LStateOf</a> <a id="1172" class="Symbol">=</a> <a id="1174" href="Ledger.Ledger.html#1004" class="Field">LStateOf</a> <a id="1183" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="1185" href="Ledger.Epoch.html#1355" class="Field">EpochStateOf</a>

  <a id="HasUTxOState-ChainState"></a><a id="1201" href="Ledger.Chain.html#1201" class="Function">HasUTxOState-ChainState</a> <a id="1225" class="Symbol">:</a> <a id="1227" href="Ledger.Utxo.html#2723" class="Record">HasUTxOState</a> <a id="1240" href="Ledger.Chain.html#551" class="Record">ChainState</a>
  <a id="1253" href="Ledger.Chain.html#1201" class="Function">HasUTxOState-ChainState</a> <a id="1277" class="Symbol">.</a><a id="1278" href="Ledger.Utxo.html#2776" class="Field">UTxOStateOf</a> <a id="1290" class="Symbol">=</a> <a id="1292" href="Ledger.Utxo.html#2776" class="Field">UTxOStateOf</a> <a id="1304" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="1306" href="Ledger.Ledger.html#1004" class="Field">LStateOf</a>

  <a id="HasCertState-ChainState"></a><a id="1318" href="Ledger.Chain.html#1318" class="Function">HasCertState-ChainState</a> <a id="1342" class="Symbol">:</a> <a id="1344" href="Ledger.Certs.html#4025" class="Record">HasCertState</a> <a id="1357" href="Ledger.Chain.html#551" class="Record">ChainState</a>
  <a id="1370" href="Ledger.Chain.html#1318" class="Function">HasCertState-ChainState</a> <a id="1394" class="Symbol">.</a><a id="1395" href="Ledger.Certs.html#4078" class="Field">CertStateOf</a> <a id="1407" class="Symbol">=</a> <a id="1409" href="Ledger.Certs.html#4078" class="Field">CertStateOf</a> <a id="1421" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="1423" href="Ledger.Ledger.html#1004" class="Field">LStateOf</a>

  <a id="HasDeposits-ChainState"></a><a id="1435" href="Ledger.Chain.html#1435" class="Function">HasDeposits-ChainState</a> <a id="1458" class="Symbol">:</a> <a id="1460" href="Ledger.Certs.html#677" class="Record">HasDeposits</a> <a id="1472" href="Ledger.Chain.html#551" class="Record">ChainState</a>
  <a id="1485" href="Ledger.Chain.html#1435" class="Function">HasDeposits-ChainState</a> <a id="1508" class="Symbol">.</a><a id="1509" href="Ledger.Certs.html#729" class="Field">DepositsOf</a> <a id="1520" class="Symbol">=</a> <a id="1522" href="Ledger.Certs.html#729" class="Field">DepositsOf</a> <a id="1533" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="1535" href="Ledger.Utxo.html#2776" class="Field">UTxOStateOf</a>

  <a id="HasRewards-ChainState"></a><a id="1550" href="Ledger.Chain.html#1550" class="Function">HasRewards-ChainState</a> <a id="1572" class="Symbol">:</a> <a id="1574" href="Ledger.Certs.html#793" class="Record">HasRewards</a> <a id="1585" href="Ledger.Chain.html#551" class="Record">ChainState</a>
  <a id="1598" href="Ledger.Chain.html#1550" class="Function">HasRewards-ChainState</a> <a id="1620" class="Symbol">.</a><a id="1621" href="Ledger.Certs.html#844" class="Field">RewardsOf</a> <a id="1631" class="Symbol">=</a> <a id="1633" href="Ledger.Certs.html#844" class="Field">RewardsOf</a> <a id="1643" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="1645" href="Ledger.Certs.html#4078" class="Field">CertStateOf</a>

  <a id="HasPParams-ChainState"></a><a id="1660" href="Ledger.Chain.html#1660" class="Function">HasPParams-ChainState</a> <a id="1682" class="Symbol">:</a> <a id="1684" href="Ledger.PParams.html#3373" class="Record">HasPParams</a> <a id="1695" href="Ledger.Chain.html#551" class="Record">ChainState</a>
  <a id="1708" href="Ledger.Chain.html#1660" class="Function">HasPParams-ChainState</a> <a id="1730" class="Symbol">.</a><a id="1731" href="Ledger.PParams.html#3424" class="Field">PParamsOf</a> <a id="1741" class="Symbol">=</a> <a id="1743" href="Ledger.PParams.html#3424" class="Field">PParamsOf</a> <a id="1753" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="1755" href="Ledger.Enact.html#743" class="Field">EnactStateOf</a>

<a id="1769" class="Keyword">instance</a> <a id="1778" href="Ledger.Chain.html#1778" class="Function">_</a> <a id="1780" class="Symbol">=</a> <a id="1782" href="Data.Nat.Properties.html#17252" class="Function">+-0-monoid</a>

<a id="1794" class="Comment">-- TODO: do we still need this for anything?</a>
<a id="maybePurpose"></a><a id="1839" href="Ledger.Chain.html#1839" class="Function">maybePurpose</a> <a id="1852" class="Symbol">:</a> <a id="1854" href="Ledger.Certs.html#332" class="Datatype">DepositPurpose</a> <a id="1869" class="Symbol">→</a> <a id="1871" class="Symbol">(</a><a id="1872" href="Ledger.Certs.html#332" class="Datatype">DepositPurpose</a> <a id="1887" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="1889" href="Ledger.Address.html#273" class="Datatype">Credential</a><a id="1899" class="Symbol">)</a> <a id="1901" class="Symbol">→</a> <a id="1903" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="1908" class="Symbol">→</a> <a id="1910" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="1916" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="1921" href="Ledger.Chain.html#1839" class="Function">maybePurpose</a> <a id="1934" href="Ledger.Chain.html#1934" class="Bound">prps</a> <a id="1939" class="Symbol">(</a><a id="1940" href="Ledger.Chain.html#1940" class="Bound">prps&#39;</a> <a id="1946" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1948" class="Symbol">_)</a> <a id="1951" href="Ledger.Chain.html#1951" class="Bound">c</a> <a id="1953" class="Keyword">with</a> <a id="1958" href="Ledger.Chain.html#1934" class="Bound">prps</a> <a id="1963" href="Class.DecEq.Core.html#159" class="Field Operator">≟</a> <a id="1965" href="Ledger.Chain.html#1940" class="Bound">prps&#39;</a>
<a id="1971" class="Symbol">...</a> <a id="1975" class="Symbol">|</a> <a id="1977" href="Relation.Nullary.Decidable.Core.html#1994" class="InductiveConstructor">yes</a> <a id="1981" class="Symbol">_</a> <a id="1983" class="Symbol">=</a> <a id="1985" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="1990" class="Bound">c</a>
<a id="1992" class="Symbol">...</a> <a id="1996" class="Symbol">|</a> <a id="1998" href="Relation.Nullary.Decidable.Core.html#2031" class="InductiveConstructor">no</a> <a id="2001" class="Symbol">_</a> <a id="2003" class="Symbol">=</a> <a id="2005" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a>

<a id="maybePurpose-prop"></a><a id="2014" href="Ledger.Chain.html#2014" class="Function">maybePurpose-prop</a> <a id="2032" class="Symbol">:</a> <a id="2034" class="Symbol">∀</a> <a id="2036" class="Symbol">{</a><a id="2037" href="Ledger.Chain.html#2037" class="Bound">prps</a><a id="2041" class="Symbol">}</a> <a id="2043" class="Symbol">{</a><a id="2044" href="Ledger.Chain.html#2044" class="Bound">x</a><a id="2045" class="Symbol">}</a> <a id="2047" class="Symbol">{</a><a id="2048" href="Ledger.Chain.html#2048" class="Bound">y</a><a id="2049" class="Symbol">}</a>
  <a id="2053" class="Symbol">→</a> <a id="2055" class="Symbol">(</a><a id="2056" href="Ledger.Chain.html#2056" class="Bound">m</a> <a id="2058" class="Symbol">:</a> <a id="2060" class="Symbol">(</a><a id="2061" href="Ledger.Certs.html#332" class="Datatype">DepositPurpose</a> <a id="2076" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="2078" href="Ledger.Address.html#273" class="Datatype">Credential</a><a id="2088" class="Symbol">)</a> <a id="2090" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="2092" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a><a id="2096" class="Symbol">)</a>
  <a id="2100" class="Symbol">→</a> <a id="2102" class="Symbol">(</a><a id="2103" href="Ledger.Chain.html#2044" class="Bound">x</a> <a id="2105" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="2107" href="Ledger.Chain.html#2048" class="Bound">y</a><a id="2108" class="Symbol">)</a> <a id="2110" href="Class.IsSet.html#458" class="Function Operator">∈</a> <a id="2112" href="Class.IsSet.html#916" class="Function">dom</a> <a id="2116" class="Symbol">((</a><a id="2118" href="Axiom.Set.Map.html#10313" class="Function">mapMaybeWithKeyᵐ</a> <a id="2135" class="Symbol">(</a><a id="2136" href="Ledger.Chain.html#1839" class="Function">maybePurpose</a> <a id="2149" href="Ledger.Chain.html#2037" class="Bound">prps</a><a id="2153" class="Symbol">)</a> <a id="2155" href="Ledger.Chain.html#2056" class="Bound">m</a><a id="2156" class="Symbol">)</a> <a id="2158" href="Axiom.Set.Map.html#2293" class="Function Operator">ˢ</a><a id="2159" class="Symbol">)</a>
  <a id="2163" class="Symbol">→</a> <a id="2165" href="Ledger.Chain.html#2044" class="Bound">x</a> <a id="2167" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="2169" href="Ledger.Chain.html#2037" class="Bound">prps</a>
<a id="2174" href="Ledger.Chain.html#2014" class="Function">maybePurpose-prop</a> <a id="2192" class="Symbol">{</a><a id="2193" class="Argument">prps</a> <a id="2198" class="Symbol">=</a> <a id="2200" href="Ledger.Chain.html#2200" class="Bound">prps</a><a id="2204" class="Symbol">}</a> <a id="2206" class="Symbol">{</a><a id="2207" href="Ledger.Chain.html#2207" class="Bound">x</a><a id="2208" class="Symbol">}</a> <a id="2210" class="Symbol">{</a><a id="2211" href="Ledger.Chain.html#2211" class="Bound">y</a><a id="2212" class="Symbol">}</a> <a id="2214" class="Symbol">_</a> <a id="2216" href="Ledger.Chain.html#2216" class="Bound">xy∈dom</a> <a id="2223" class="Keyword">with</a> <a id="2228" href="Function.Bundles.html#4834" class="Field">from</a> <a id="2233" href="Axiom.Set.Rel.html#2472" class="Function">dom∈</a> <a id="2238" href="Ledger.Chain.html#2216" class="Bound">xy∈dom</a>
<a id="2245" class="Symbol">...</a> <a id="2249" class="Symbol">|</a> <a id="2251" href="Ledger.Chain.html#2251" class="Bound">z</a> <a id="2253" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="2255" href="Ledger.Chain.html#2255" class="Bound">∈mmwk</a> <a id="2261" class="Keyword">with</a> <a id="2266" class="Bound">prps</a> <a id="2271" href="Class.DecEq.Core.html#159" class="Field Operator">≟</a> <a id="2273" class="Bound">x</a> <a id="2275" class="Symbol">|</a> <a id="2277" href="Axiom.Set.Rel.html#5977" class="Function">∈-mapMaybeWithKey</a> <a id="2295" class="Symbol">{</a><a id="2296" class="Argument">f</a> <a id="2298" class="Symbol">=</a> <a id="2300" href="Ledger.Chain.html#1839" class="Function">maybePurpose</a> <a id="2313" class="Bound">prps</a><a id="2317" class="Symbol">}</a> <a id="2319" href="Ledger.Chain.html#2255" class="Bound">∈mmwk</a>
<a id="2325" class="Symbol">...</a> <a id="2329" class="Symbol">|</a> <a id="2331" href="Relation.Nullary.Decidable.Core.html#1994" class="InductiveConstructor">yes</a> <a id="2335" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a> <a id="2340" class="Symbol">|</a> <a id="2342" class="Symbol">_</a> <a id="2344" class="Symbol">=</a> <a id="2346" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a>

<a id="filterPurpose"></a><a id="2352" href="Ledger.Chain.html#2352" class="Function">filterPurpose</a> <a id="2366" class="Symbol">:</a> <a id="2368" href="Ledger.Certs.html#332" class="Datatype">DepositPurpose</a> <a id="2383" class="Symbol">→</a> <a id="2385" class="Symbol">(</a><a id="2386" href="Ledger.Certs.html#332" class="Datatype">DepositPurpose</a> <a id="2401" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="2403" href="Ledger.Address.html#273" class="Datatype">Credential</a><a id="2413" class="Symbol">)</a> <a id="2415" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="2417" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="2422" class="Symbol">→</a> <a id="2424" href="Ledger.Address.html#273" class="Datatype">Credential</a> <a id="2435" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="2437" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="2442" href="Ledger.Chain.html#2352" class="Function">filterPurpose</a> <a id="2456" href="Ledger.Chain.html#2456" class="Bound">prps</a> <a id="2461" href="Ledger.Chain.html#2461" class="Bound">m</a> <a id="2463" class="Symbol">=</a> <a id="2465" href="Axiom.Set.Map.html#5896" class="Function">mapKeys</a> <a id="2473" href="Data.Product.Base.html#650" class="Field">proj₂</a> <a id="2479" class="Symbol">(</a><a id="2480" href="Axiom.Set.Map.html#10313" class="Function">mapMaybeWithKeyᵐ</a> <a id="2497" class="Symbol">(</a><a id="2498" href="Ledger.Chain.html#1839" class="Function">maybePurpose</a> <a id="2511" href="Ledger.Chain.html#2456" class="Bound">prps</a><a id="2515" class="Symbol">)</a> <a id="2517" href="Ledger.Chain.html#2461" class="Bound">m</a><a id="2518" class="Symbol">)</a>
  <a id="2522" class="Symbol">{λ</a> <a id="2525" class="Keyword">where</a> <a id="2531" href="Ledger.Chain.html#2531" class="Bound">x∈dom</a> <a id="2537" href="Ledger.Chain.html#2537" class="Bound">y∈dom</a> <a id="2543" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a> <a id="2548" class="Symbol">→</a> <a id="2550" href="Relation.Binary.PropositionalEquality.Core.html#1339" class="Function">cong</a> <a id="2555" class="Symbol">(</a><a id="2556" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">_,</a> <a id="2559" class="Symbol">_)</a>
                            <a id="2590" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="2592" href="Relation.Binary.PropositionalEquality.Core.html#1938" class="Function">trans</a> <a id="2598" class="Symbol">(</a><a id="2599" href="Ledger.Chain.html#2014" class="Function">maybePurpose-prop</a> <a id="2617" class="Symbol">{</a><a id="2618" class="Argument">prps</a> <a id="2623" class="Symbol">=</a> <a id="2625" href="Ledger.Chain.html#2456" class="Bound">prps</a><a id="2629" class="Symbol">}</a> <a id="2631" href="Ledger.Chain.html#2461" class="Bound">m</a> <a id="2633" href="Ledger.Chain.html#2531" class="Bound">x∈dom</a><a id="2638" class="Symbol">)</a>
                            <a id="2668" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="2670" href="Relation.Binary.PropositionalEquality.Core.html#1893" class="Function">sym</a>   <a id="2676" class="Symbol">(</a><a id="2677" href="Ledger.Chain.html#2014" class="Function">maybePurpose-prop</a> <a id="2695" class="Symbol">{</a><a id="2696" class="Argument">prps</a> <a id="2701" class="Symbol">=</a> <a id="2703" href="Ledger.Chain.html#2456" class="Bound">prps</a><a id="2707" class="Symbol">}</a> <a id="2709" href="Ledger.Chain.html#2461" class="Bound">m</a> <a id="2711" href="Ledger.Chain.html#2537" class="Bound">y∈dom</a><a id="2716" class="Symbol">)}</a>

<a id="govActionDeposits"></a><a id="2720" href="Ledger.Chain.html#2720" class="Function">govActionDeposits</a> <a id="2738" class="Symbol">:</a> <a id="2740" href="Ledger.Ledger.html#809" class="Record">LState</a> <a id="2747" class="Symbol">→</a> <a id="2749" href="Ledger.GovernanceActions.html#458" class="Datatype">VDeleg</a> <a id="2756" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="2758" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="2763" href="Ledger.Chain.html#2720" class="Function">govActionDeposits</a> <a id="2781" href="Ledger.Chain.html#2781" class="Bound">ls</a> <a id="2784" class="Symbol">=</a>
  <a id="2788" class="Keyword">let</a> <a id="2792" class="Keyword">open</a> <a id="2797" href="Ledger.Ledger.html#809" class="Module">LState</a> <a id="2804" href="Ledger.Chain.html#2781" class="Bound">ls</a><a id="2806" class="Symbol">;</a> <a id="2808" class="Keyword">open</a> <a id="2813" href="Ledger.Certs.html#3897" class="Module">CertState</a> <a id="2823" href="Ledger.Ledger.html#921" class="Field">certState</a><a id="2832" class="Symbol">;</a> <a id="2834" class="Keyword">open</a> <a id="2839" href="Ledger.Certs.html#3351" class="Module">PState</a> <a id="2846" href="Ledger.Certs.html#3980" class="Function">pState</a>
      <a id="2859" class="Keyword">open</a> <a id="2864" href="Ledger.Utxo.html#2561" class="Module">UTxOState</a> <a id="2874" href="Ledger.Ledger.html#868" class="Field">utxoSt</a><a id="2880" class="Symbol">;</a> <a id="2882" class="Keyword">open</a> <a id="2887" href="Ledger.Certs.html#2963" class="Module">DState</a> <a id="2894" href="Ledger.Certs.html#3960" class="Function">dState</a>
   <a id="2904" class="Keyword">in</a> <a id="2907" href="Data.List.Base.html#4249" class="Function">foldl</a> <a id="2913" href="Axiom.Set.Map.Dec.html#1854" class="Function Operator">_∪⁺_</a> <a id="2918" href="Class.HasEmptySet.html#287" class="Field">∅</a> <a id="2920" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="2922" href="abstract-set-theory.FiniteSetTheory.html#2463" class="Function">setToList</a> <a id="2932" href="Function.Base.html#1974" class="Function Operator">$</a>
    <a id="2938" href="Axiom.Set.html#7805" class="Function">mapPartial</a>
      <a id="2955" class="Symbol">(λ</a> <a id="2958" class="Keyword">where</a> <a id="2964" class="Symbol">(</a><a id="2965" href="Ledger.Chain.html#2965" class="Bound">gaid</a> <a id="2970" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="2972" class="Keyword">record</a> <a id="2979" class="Symbol">{</a> <a id="2981" href="Ledger.GovernanceActions.html#2665" class="Field">returnAddr</a> <a id="2992" class="Symbol">=</a> <a id="2994" class="Keyword">record</a> <a id="3001" class="Symbol">{</a><a id="3002" href="Ledger.Address.html#1390" class="Field">stake</a> <a id="3008" class="Symbol">=</a> <a id="3010" href="Ledger.Chain.html#3010" class="Bound">c</a><a id="3011" class="Symbol">}</a> <a id="3013" class="Symbol">})</a> <a id="3016" class="Symbol">→</a> <a id="3018" class="Keyword">do</a>
        <a id="3029" href="Ledger.Chain.html#3029" class="Bound">vd</a> <a id="3032" href="Class.Monad.Core.html#299" class="Field Operator">←</a> <a id="3034" href="Axiom.Set.Map.html#13670" class="Function">lookupᵐ?</a> <a id="3043" href="Ledger.Certs.html#3022" class="Function">voteDelegs</a> <a id="3054" href="Ledger.Chain.html#3010" class="Bound">c</a>
        <a id="3064" href="Ledger.Chain.html#3064" class="Bound">dep</a> <a id="3068" href="Class.Monad.Core.html#299" class="Field Operator">←</a> <a id="3070" href="Axiom.Set.Map.html#13670" class="Function">lookupᵐ?</a> <a id="3079" href="Ledger.Utxo.html#2669" class="Function">deposits</a> <a id="3088" class="Symbol">(</a><a id="3089" href="Ledger.Certs.html#521" class="InductiveConstructor">GovActionDeposit</a> <a id="3106" href="Ledger.Chain.html#2965" class="Bound">gaid</a><a id="3110" class="Symbol">)</a>
        <a id="3120" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="3125" href="Class.HasSingleton.html#288" class="Field Operator">❴</a> <a id="3127" href="Ledger.Chain.html#3029" class="Bound">vd</a> <a id="3130" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3132" href="Ledger.Chain.html#3064" class="Bound">dep</a> <a id="3136" href="Class.HasSingleton.html#288" class="Field Operator">❵</a> <a id="3138" class="Symbol">)</a>
      <a id="3146" class="Symbol">(</a><a id="3147" href="Axiom.Set.html#5718" class="Function">fromList</a> <a id="3156" href="Ledger.Ledger.html#895" class="Field">govSt</a><a id="3161" class="Symbol">)</a>

<a id="calculateStakeDistrs"></a><a id="3164" href="Ledger.Chain.html#3164" class="Function">calculateStakeDistrs</a> <a id="3185" class="Symbol">:</a> <a id="3187" href="Ledger.Ledger.html#809" class="Record">LState</a> <a id="3194" class="Symbol">→</a> <a id="3196" href="Ledger.Ratify.html#2859" class="Record">StakeDistrs</a>
<a id="3208" href="Ledger.Chain.html#3164" class="Function">calculateStakeDistrs</a> <a id="3229" href="Ledger.Chain.html#3229" class="Bound">ls</a> <a id="3232" class="Symbol">=</a>
  <a id="3236" class="Keyword">let</a> <a id="3240" class="Keyword">open</a> <a id="3245" href="Ledger.Ledger.html#809" class="Module">LState</a> <a id="3252" href="Ledger.Chain.html#3229" class="Bound">ls</a><a id="3254" class="Symbol">;</a> <a id="3256" class="Keyword">open</a> <a id="3261" href="Ledger.Certs.html#3897" class="Module">CertState</a> <a id="3271" href="Ledger.Ledger.html#921" class="Field">certState</a><a id="3280" class="Symbol">;</a> <a id="3282" class="Keyword">open</a> <a id="3287" href="Ledger.Certs.html#3351" class="Module">PState</a> <a id="3294" href="Ledger.Certs.html#3980" class="Function">pState</a>
      <a id="3307" class="Keyword">open</a> <a id="3312" href="Ledger.Utxo.html#2561" class="Module">UTxOState</a> <a id="3322" href="Ledger.Ledger.html#868" class="Field">utxoSt</a><a id="3328" class="Symbol">;</a> <a id="3330" class="Keyword">open</a> <a id="3335" href="Ledger.Certs.html#2963" class="Module">DState</a> <a id="3342" href="Ledger.Certs.html#3960" class="Function">dState</a>
      <a id="3355" href="Ledger.Chain.html#3355" class="Bound">spoDelegs</a> <a id="3365" class="Symbol">=</a> <a id="3367" href="Class.HasEmptySet.html#287" class="Field">∅</a> <a id="3369" class="Comment">-- TODO</a>
      <a id="3383" href="Ledger.Chain.html#3383" class="Bound">drepDelegs</a> <a id="3394" class="Symbol">=</a> <a id="3396" href="Class.HasEmptySet.html#287" class="Field">∅</a> <a id="3398" class="Comment">-- TODO</a>
  <a id="3408" class="Keyword">in</a>
  <a id="3413" class="Keyword">record</a>
    <a id="3424" class="Symbol">{</a> <a id="3426" href="Ledger.Ratify.html#2896" class="Field">stakeDistr</a> <a id="3437" class="Symbol">=</a> <a id="3439" href="Ledger.Chain.html#2720" class="Function">govActionDeposits</a> <a id="3457" href="Ledger.Chain.html#3229" class="Bound">ls</a>
    <a id="3464" class="Symbol">}</a>

<a id="totalRefScriptsSize"></a><a id="3467" href="Ledger.Chain.html#3467" class="Function">totalRefScriptsSize</a> <a id="3487" class="Symbol">:</a> <a id="3489" href="Ledger.Ledger.html#809" class="Record">LState</a> <a id="3496" class="Symbol">→</a> <a id="3498" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3503" href="Ledger.Transaction.html#4234" class="Record">Tx</a> <a id="3506" class="Symbol">→</a> <a id="3508" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
<a id="3510" href="Ledger.Chain.html#3467" class="Function">totalRefScriptsSize</a> <a id="3530" href="Ledger.Chain.html#3530" class="Bound">lst</a> <a id="3534" href="Ledger.Chain.html#3534" class="Bound">txs</a> <a id="3538" class="Symbol">=</a> <a id="3540" href="Data.List.Base.html#4964" class="Function">sum</a> <a id="3544" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="3546" href="Class.Functor.Core.html#272" class="Function">map</a> <a id="3550" class="Symbol">(</a><a id="3551" href="Ledger.Utxo.html#3565" class="Function">refScriptsSize</a> <a id="3566" href="Ledger.Utxo.html#2625" class="Function">utxo</a><a id="3570" class="Symbol">)</a> <a id="3572" href="Ledger.Chain.html#3534" class="Bound">txs</a>
  <a id="3578" class="Keyword">where</a> <a id="3584" class="Keyword">open</a> <a id="3589" href="Ledger.Utxo.html#2561" class="Module">UTxOState</a> <a id="3599" class="Symbol">(</a><a id="3600" href="Ledger.Ledger.html#868" class="Field">LState.utxoSt</a> <a id="3614" href="Ledger.Chain.html#3530" class="Bound">lst</a><a id="3617" class="Symbol">)</a>

<a id="3620" class="Keyword">private</a> <a id="3628" class="Keyword">variable</a>
  <a id="3639" href="Ledger.Chain.html#3639" class="Generalizable">ls&#39;</a> <a id="3643" class="Symbol">:</a> <a id="3645" href="Ledger.Ledger.html#809" class="Record">LState</a> 
<a id="3653" class="Keyword">data</a>


  <a id="_⊢_⇀⦇_,CHAIN⦈_"></a><a id="3662" href="Ledger.Chain.html#3662" class="Datatype Operator">_⊢_⇀⦇_,CHAIN⦈_</a> <a id="3677" class="Symbol">:</a> <a id="3679" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a> <a id="3681" class="Symbol">→</a> <a id="3683" href="Ledger.Chain.html#551" class="Record">ChainState</a> <a id="3694" class="Symbol">→</a> <a id="3696" href="Ledger.Chain.html#626" class="Record">Block</a> <a id="3702" class="Symbol">→</a> <a id="3704" href="Ledger.Chain.html#551" class="Record">ChainState</a> <a id="3715" class="Symbol">→</a> <a id="3717" href="Agda.Primitive.html#388" class="Primitive">Type</a>


  <a id="3726" class="Keyword">where</a>


  <a id="_⊢_⇀⦇_,CHAIN⦈_.CHAIN"></a><a id="3736" href="Ledger.Chain.html#3736" class="InductiveConstructor">CHAIN</a> <a id="3742" class="Symbol">:</a> <a id="3744" class="Symbol">{</a><a id="3745" href="Ledger.Chain.html#3745" class="Bound">b</a> <a id="3747" class="Symbol">:</a> <a id="3749" href="Ledger.Chain.html#626" class="Record">Block</a><a id="3754" class="Symbol">}</a> <a id="3756" class="Symbol">{</a><a id="3757" href="Ledger.Chain.html#3757" class="Bound">nes</a> <a id="3761" class="Symbol">:</a> <a id="3763" href="Ledger.Epoch.html#1878" class="Record">NewEpochState</a><a id="3776" class="Symbol">}</a> <a id="3778" class="Symbol">{</a><a id="3779" href="Ledger.Chain.html#3779" class="Bound">cs</a> <a id="3782" class="Symbol">:</a> <a id="3784" href="Ledger.Chain.html#551" class="Record">ChainState</a><a id="3794" class="Symbol">}</a>


    <a id="3802" class="Symbol">→</a> <a id="3804" class="Keyword">let</a> <a id="3808" class="Keyword">open</a> <a id="3813" href="Ledger.Chain.html#551" class="Module">ChainState</a> <a id="3824" href="Ledger.Chain.html#3779" class="Bound">cs</a><a id="3826" class="Symbol">;</a> <a id="3828" class="Keyword">open</a> <a id="3833" href="Ledger.Chain.html#626" class="Module">Block</a> <a id="3839" href="Ledger.Chain.html#3745" class="Bound">b</a><a id="3840" class="Symbol">;</a> <a id="3842" class="Keyword">open</a> <a id="3847" href="Ledger.Epoch.html#1878" class="Module">NewEpochState</a> <a id="3861" href="Ledger.Chain.html#3757" class="Bound">nes</a>
          <a id="3875" class="Keyword">open</a> <a id="3880" href="Ledger.Epoch.html#1098" class="Module">EpochState</a> <a id="3891" href="Ledger.Epoch.html#1941" class="Function">epochState</a><a id="3901" class="Symbol">;</a> <a id="3903" class="Keyword">open</a> <a id="3908" href="Ledger.Enact.html#397" class="Module">EnactState</a> <a id="3919" href="Ledger.Epoch.html#1239" class="Function">es</a> <a id="3922" class="Keyword">renaming</a> <a id="3931" class="Symbol">(</a><a id="3932" href="Ledger.Enact.html#607" class="Field">pparams</a> <a id="3940" class="Symbol">to</a> <a id="3943" class="Field">pp</a><a id="3945" class="Symbol">)</a>
          <a id="3957" class="Keyword">open</a> <a id="3962" href="Ledger.PParams.html#1570" class="Module">PParams</a> <a id="3970" href="Ledger.Prelude.html#2393" class="Function Operator">∣</a> <a id="3972" href="Ledger.Chain.html#3943" class="Function">pp</a> <a id="3975" href="Ledger.Prelude.html#2393" class="Function Operator">∣</a> <a id="3977" class="Keyword">using</a> <a id="3983" class="Symbol">(</a><a id="3984" href="Ledger.PParams.html#2482" class="Field">maxRefScriptSizePerBlock</a><a id="4008" class="Symbol">)</a> <a id="4010" class="Keyword">in</a>


    <a id="4019" class="Keyword">let</a>  <a id="4024" href="Ledger.Chain.html#4024" class="Bound">cs&#39;</a>  <a id="4029" class="Symbol">=</a> <a id="4031" class="Keyword">record</a> <a id="4038" href="Ledger.Chain.html#3779" class="Bound">cs</a> <a id="4041" class="Symbol">{</a>  <a id="4044" href="Ledger.Chain.html#587" class="Field">newEpochState</a>
                             <a id="4087" class="Symbol">=</a> <a id="4089" class="Keyword">record</a> <a id="4096" href="Ledger.Chain.html#3757" class="Bound">nes</a> <a id="4100" class="Symbol">{</a>  <a id="4103" href="Ledger.Epoch.html#1941" class="Field">epochState</a>
                                             <a id="4159" class="Symbol">=</a> <a id="4161" class="Keyword">record</a> <a id="4168" href="Ledger.Epoch.html#1941" class="Function">epochState</a> <a id="4179" class="Symbol">{</a><a id="4180" href="Ledger.Epoch.html#1215" class="Field">ls</a> <a id="4183" class="Symbol">=</a> <a id="4185" href="Ledger.Chain.html#3639" class="Generalizable">ls&#39;</a><a id="4188" class="Symbol">}</a> <a id="4190" class="Symbol">}</a> <a id="4192" class="Symbol">}</a>
         <a id="4203" href="Ledger.Chain.html#4203" class="Bound">Γ</a>    <a id="4208" class="Symbol">=</a> <a id="4210" href="Ledger.Prelude.html#2291" class="Function Operator">⟦</a> <a id="4212" href="Ledger.Chain.html#677" class="Function">slot</a> <a id="4217" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4219" href="Ledger.Prelude.html#2393" class="Function Operator">∣</a> <a id="4221" href="Ledger.Enact.html#502" class="Function">constitution</a> <a id="4234" href="Ledger.Prelude.html#2393" class="Function Operator">∣</a> <a id="4236" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4238" href="Ledger.Prelude.html#2393" class="Function Operator">∣</a> <a id="4240" href="Ledger.Chain.html#3943" class="Function">pp</a> <a id="4243" href="Ledger.Prelude.html#2393" class="Function Operator">∣</a> <a id="4245" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4247" href="Ledger.Epoch.html#1239" class="Function">es</a> <a id="4250" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4252" href="Ledger.PParams.html#814" class="Field">treasuryOf</a> <a id="4263" href="Ledger.Chain.html#3757" class="Bound">nes</a> <a id="4267" href="Ledger.Prelude.html#2291" class="Function Operator">⟧</a>
    <a id="4273" class="Keyword">in</a>
    <a id="4280" href="Interface.STS.html#105" class="Function Operator">∙</a> <a id="4282" href="Ledger.Chain.html#3467" class="Function">totalRefScriptsSize</a> <a id="4302" href="Ledger.Epoch.html#1215" class="Function">ls</a> <a id="4305" href="Ledger.Chain.html#657" class="Function">ts</a> <a id="4308" href="Class.HasOrder.Core.html#608" class="Field Operator">≤</a> <a id="4310" href="Ledger.PParams.html#2482" class="Function">maxRefScriptSizePerBlock</a>
    <a id="4339" href="Interface.STS.html#131" class="Function Operator">∙</a> <a id="4341" class="Symbol">_</a> <a id="4343" href="Ledger.Epoch.html#8607" class="Datatype Operator">⊢</a> <a id="4345" href="Ledger.Chain.html#587" class="Field">newEpochState</a> <a id="4359" href="Ledger.Epoch.html#8607" class="Datatype Operator">⇀⦇</a> <a id="4362" href="Ledger.Types.Epoch.html#688" class="Function">epoch</a> <a id="4368" href="Ledger.Chain.html#677" class="Function">slot</a> <a id="4373" href="Ledger.Epoch.html#8607" class="Datatype Operator">,NEWEPOCH⦈</a> <a id="4384" href="Ledger.Chain.html#3757" class="Bound">nes</a>
    <a id="4392" href="Interface.STS.html#131" class="Function Operator">∙</a> <a id="4394" href="Ledger.Chain.html#4203" class="Bound">Γ</a> <a id="4396" href="Ledger.Ledger.html#3676" class="Function Operator">⊢</a> <a id="4398" href="Ledger.Epoch.html#1215" class="Function">ls</a> <a id="4401" href="Ledger.Ledger.html#3676" class="Function Operator">⇀⦇</a> <a id="4404" href="Ledger.Chain.html#657" class="Function">ts</a> <a id="4407" href="Ledger.Ledger.html#3676" class="Function Operator">,LEDGERS⦈</a> <a id="4417" href="Ledger.Chain.html#3639" class="Generalizable">ls&#39;</a>
      <a id="4427" href="Interface.STS.html#350" class="Function Operator">────────────────────────────────</a>
      <a id="4466" class="Symbol">_</a> <a id="4468" href="Ledger.Chain.html#3662" class="Datatype Operator">⊢</a> <a id="4470" href="Ledger.Chain.html#3779" class="Bound">cs</a> <a id="4473" href="Ledger.Chain.html#3662" class="Datatype Operator">⇀⦇</a> <a id="4476" href="Ledger.Chain.html#3745" class="Bound">b</a> <a id="4478" href="Ledger.Chain.html#3662" class="Datatype Operator">,CHAIN⦈</a> <a id="4486" href="Ledger.Chain.html#4024" class="Bound">cs&#39;</a>

</pre></body></html>