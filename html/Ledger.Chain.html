<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Ledger.Chain</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda">
<a id="2" class="Symbol">{-#</a> <a id="6" class="Keyword">OPTIONS</a> <a id="14" class="Pragma">--safe</a> <a id="21" class="Symbol">#-}</a>

<a id="26" class="Keyword">open</a> <a id="31" class="Keyword">import</a> <a id="38" href="Algebra.html" class="Module">Algebra</a>
<a id="46" class="Keyword">open</a> <a id="51" class="Keyword">import</a> <a id="58" href="Data.Nat.Properties.html" class="Module">Data.Nat.Properties</a> <a id="78" class="Keyword">using</a> <a id="84" class="Symbol">(</a><a id="85" href="Data.Nat.Properties.html#17056" class="Function">+-0-monoid</a><a id="95" class="Symbol">)</a>

<a id="98" class="Keyword">open</a> <a id="103" class="Keyword">import</a> <a id="110" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a><a id="124" class="Symbol">;</a> <a id="126" class="Keyword">open</a> <a id="131" href="Function.Bundles.html#4752" class="Module">Equivalence</a>
<a id="143" class="Keyword">open</a> <a id="148" class="Keyword">import</a> <a id="155" href="Ledger.Transaction.html" class="Module">Ledger.Transaction</a>
<a id="174" class="Keyword">open</a> <a id="179" class="Keyword">import</a> <a id="186" href="Ledger.Abstract.html" class="Module">Ledger.Abstract</a>

<a id="203" class="Keyword">module</a> <a id="210" href="Ledger.Chain.html" class="Module">Ledger.Chain</a>
  <a id="225" class="Symbol">(</a><a id="226" href="Ledger.Chain.html#226" class="Bound">txs</a> <a id="230" class="Symbol">:</a> <a id="232" class="Symbol">_)</a> <a id="235" class="Symbol">(</a><a id="236" class="Keyword">open</a> <a id="241" href="Ledger.Transaction.html#867" class="Module">TransactionStructure</a> <a id="262" href="Ledger.Chain.html#226" class="Bound">txs</a><a id="265" class="Symbol">)</a>
  <a id="269" class="Symbol">(</a><a id="270" href="Ledger.Chain.html#270" class="Bound">abs</a> <a id="274" class="Symbol">:</a> <a id="276" href="Ledger.Abstract.html#578" class="Record">AbstractFunctions</a> <a id="294" href="Ledger.Chain.html#226" class="Bound">txs</a><a id="297" class="Symbol">)</a> <a id="299" class="Symbol">(</a><a id="300" class="Keyword">open</a> <a id="305" href="Ledger.Abstract.html#578" class="Module">AbstractFunctions</a> <a id="323" href="Ledger.Chain.html#270" class="Bound">abs</a><a id="326" class="Symbol">)</a>
  <a id="330" class="Keyword">where</a>

<a id="337" class="Keyword">open</a> <a id="342" class="Keyword">import</a> <a id="349" href="Ledger.Enact.html" class="Module">Ledger.Enact</a> <a id="362" href="Ledger.Transaction.html#1809" class="Function">govStructure</a>
<a id="375" class="Keyword">open</a> <a id="380" class="Keyword">import</a> <a id="387" href="Ledger.Ledger.html" class="Module">Ledger.Ledger</a> <a id="401" href="Ledger.Chain.html#226" class="Bound">txs</a> <a id="405" href="Ledger.Chain.html#270" class="Bound">abs</a>
<a id="409" class="Keyword">open</a> <a id="414" class="Keyword">import</a> <a id="421" href="Ledger.Ratify.html" class="Module">Ledger.Ratify</a> <a id="435" href="Ledger.Chain.html#226" class="Bound">txs</a>
<a id="439" class="Keyword">open</a> <a id="444" class="Keyword">import</a> <a id="451" href="Ledger.Utxo.html" class="Module">Ledger.Utxo</a> <a id="463" href="Ledger.Chain.html#226" class="Bound">txs</a> <a id="467" href="Ledger.Chain.html#270" class="Bound">abs</a>
<a id="471" class="Keyword">open</a> <a id="476" class="Keyword">import</a> <a id="483" href="Ledger.Epoch.html" class="Module">Ledger.Epoch</a> <a id="496" href="Ledger.Chain.html#226" class="Bound">txs</a> <a id="500" href="Ledger.Chain.html#270" class="Bound">abs</a>
<a id="504" class="Keyword">open</a> <a id="509" class="Keyword">import</a> <a id="516" href="Ledger.Certs.html" class="Module">Ledger.Certs</a> <a id="529" href="Ledger.Transaction.html#1809" class="Function">govStructure</a>


<a id="544" class="Keyword">record</a> <a id="ChainState"></a><a id="551" href="Ledger.Chain.html#551" class="Record">ChainState</a> <a id="562" class="Symbol">:</a> <a id="564" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="569" class="Keyword">where</a>
  <a id="577" class="Keyword">field</a>
    <a id="ChainState.newEpochState"></a><a id="587" href="Ledger.Chain.html#587" class="Field">newEpochState</a>  <a id="602" class="Symbol">:</a> <a id="604" href="Ledger.Epoch.html#1330" class="Record">NewEpochState</a>

<a id="619" class="Keyword">record</a> <a id="Block"></a><a id="626" href="Ledger.Chain.html#626" class="Record">Block</a> <a id="632" class="Symbol">:</a> <a id="634" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="639" class="Keyword">where</a>
  <a id="647" class="Keyword">field</a>
    <a id="Block.ts"></a><a id="657" href="Ledger.Chain.html#657" class="Field">ts</a>    <a id="663" class="Symbol">:</a> <a id="665" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="670" href="Ledger.Transaction.html#3538" class="Record">Tx</a>
    <a id="Block.slot"></a><a id="677" href="Ledger.Chain.html#677" class="Field">slot</a>  <a id="683" class="Symbol">:</a> <a id="685" href="Ledger.Types.Epoch.html#552" class="Function">Slot</a>


<a id="692" class="Keyword">private</a> <a id="700" class="Keyword">variable</a>
  <a id="711" href="Ledger.Chain.html#711" class="Generalizable">s</a> <a id="713" class="Symbol">:</a> <a id="715" href="Ledger.Chain.html#551" class="Record">ChainState</a>
  <a id="728" href="Ledger.Chain.html#728" class="Generalizable">b</a> <a id="730" class="Symbol">:</a> <a id="732" href="Ledger.Chain.html#626" class="Record">Block</a>
  <a id="740" href="Ledger.Chain.html#740" class="Generalizable">ls&#39;</a> <a id="744" class="Symbol">:</a> <a id="746" href="Ledger.Ledger.html#715" class="Record">LState</a>
  <a id="755" href="Ledger.Chain.html#755" class="Generalizable">nes</a> <a id="759" class="Symbol">:</a> <a id="761" href="Ledger.Epoch.html#1330" class="Record">NewEpochState</a>

<a id="776" class="Keyword">instance</a> <a id="785" href="Ledger.Chain.html#785" class="Function">_</a> <a id="787" class="Symbol">=</a> <a id="789" href="Data.Nat.Properties.html#17056" class="Function">+-0-monoid</a>

<a id="801" class="Comment">-- TODO: do we still need this for anything?</a>
<a id="maybePurpose"></a><a id="846" href="Ledger.Chain.html#846" class="Function">maybePurpose</a> <a id="859" class="Symbol">:</a> <a id="861" href="Ledger.Certs.html#286" class="Datatype">DepositPurpose</a> <a id="876" class="Symbol">→</a> <a id="878" class="Symbol">(</a><a id="879" href="Ledger.Certs.html#286" class="Datatype">DepositPurpose</a> <a id="894" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="896" href="Ledger.Address.html#273" class="Datatype">Credential</a><a id="906" class="Symbol">)</a> <a id="908" class="Symbol">→</a> <a id="910" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="915" class="Symbol">→</a> <a id="917" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="923" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="928" href="Ledger.Chain.html#846" class="Function">maybePurpose</a> <a id="941" href="Ledger.Chain.html#941" class="Bound">prps</a> <a id="946" class="Symbol">(</a><a id="947" href="Ledger.Chain.html#947" class="Bound">prps&#39;</a> <a id="953" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="955" class="Symbol">_)</a> <a id="958" href="Ledger.Chain.html#958" class="Bound">c</a> <a id="960" class="Keyword">with</a> <a id="965" href="Ledger.Chain.html#941" class="Bound">prps</a> <a id="970" href="Class.DecEq.Core.html#159" class="Field Operator">≟</a> <a id="972" href="Ledger.Chain.html#947" class="Bound">prps&#39;</a>
<a id="978" class="Symbol">...</a> <a id="982" class="Symbol">|</a> <a id="984" href="Relation.Nullary.Decidable.Core.html#1994" class="InductiveConstructor">yes</a> <a id="988" class="Symbol">_</a> <a id="990" class="Symbol">=</a> <a id="992" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="997" class="Bound">c</a>
<a id="999" class="Symbol">...</a> <a id="1003" class="Symbol">|</a> <a id="1005" href="Relation.Nullary.Decidable.Core.html#2031" class="InductiveConstructor">no</a> <a id="1008" class="Symbol">_</a> <a id="1010" class="Symbol">=</a> <a id="1012" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a>

<a id="maybePurpose-prop"></a><a id="1021" href="Ledger.Chain.html#1021" class="Function">maybePurpose-prop</a> <a id="1039" class="Symbol">:</a> <a id="1041" class="Symbol">∀</a> <a id="1043" class="Symbol">{</a><a id="1044" href="Ledger.Chain.html#1044" class="Bound">prps</a><a id="1048" class="Symbol">}</a> <a id="1050" class="Symbol">{</a><a id="1051" href="Ledger.Chain.html#1051" class="Bound">x</a><a id="1052" class="Symbol">}</a> <a id="1054" class="Symbol">{</a><a id="1055" href="Ledger.Chain.html#1055" class="Bound">y</a><a id="1056" class="Symbol">}</a>
  <a id="1060" class="Symbol">→</a> <a id="1062" class="Symbol">(</a><a id="1063" href="Ledger.Chain.html#1063" class="Bound">m</a> <a id="1065" class="Symbol">:</a> <a id="1067" class="Symbol">(</a><a id="1068" href="Ledger.Certs.html#286" class="Datatype">DepositPurpose</a> <a id="1083" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="1085" href="Ledger.Address.html#273" class="Datatype">Credential</a><a id="1095" class="Symbol">)</a> <a id="1097" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="1099" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a><a id="1103" class="Symbol">)</a>
  <a id="1107" class="Symbol">→</a> <a id="1109" class="Symbol">(</a><a id="1110" href="Ledger.Chain.html#1051" class="Bound">x</a> <a id="1112" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1114" href="Ledger.Chain.html#1055" class="Bound">y</a><a id="1115" class="Symbol">)</a> <a id="1117" href="Class.IsSet.html#458" class="Function Operator">∈</a> <a id="1119" href="Class.IsSet.html#916" class="Function">dom</a> <a id="1123" class="Symbol">((</a><a id="1125" href="Axiom.Set.Map.html#10313" class="Function">mapMaybeWithKeyᵐ</a> <a id="1142" class="Symbol">(</a><a id="1143" href="Ledger.Chain.html#846" class="Function">maybePurpose</a> <a id="1156" href="Ledger.Chain.html#1044" class="Bound">prps</a><a id="1160" class="Symbol">)</a> <a id="1162" href="Ledger.Chain.html#1063" class="Bound">m</a><a id="1163" class="Symbol">)</a> <a id="1165" href="Axiom.Set.Map.html#2293" class="Function Operator">ˢ</a><a id="1166" class="Symbol">)</a>
  <a id="1170" class="Symbol">→</a> <a id="1172" href="Ledger.Chain.html#1051" class="Bound">x</a> <a id="1174" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="1176" href="Ledger.Chain.html#1044" class="Bound">prps</a>
<a id="1181" href="Ledger.Chain.html#1021" class="Function">maybePurpose-prop</a> <a id="1199" class="Symbol">{</a><a id="1200" class="Argument">prps</a> <a id="1205" class="Symbol">=</a> <a id="1207" href="Ledger.Chain.html#1207" class="Bound">prps</a><a id="1211" class="Symbol">}</a> <a id="1213" class="Symbol">{</a><a id="1214" href="Ledger.Chain.html#1214" class="Bound">x</a><a id="1215" class="Symbol">}</a> <a id="1217" class="Symbol">{</a><a id="1218" href="Ledger.Chain.html#1218" class="Bound">y</a><a id="1219" class="Symbol">}</a> <a id="1221" class="Symbol">_</a> <a id="1223" href="Ledger.Chain.html#1223" class="Bound">xy∈dom</a> <a id="1230" class="Keyword">with</a> <a id="1235" href="Function.Bundles.html#4834" class="Field">from</a> <a id="1240" href="Axiom.Set.Rel.html#2472" class="Function">dom∈</a> <a id="1245" href="Ledger.Chain.html#1223" class="Bound">xy∈dom</a>
<a id="1252" class="Symbol">...</a> <a id="1256" class="Symbol">|</a> <a id="1258" href="Ledger.Chain.html#1258" class="Bound">z</a> <a id="1260" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1262" href="Ledger.Chain.html#1262" class="Bound">∈mmwk</a> <a id="1268" class="Keyword">with</a> <a id="1273" class="Bound">prps</a> <a id="1278" href="Class.DecEq.Core.html#159" class="Field Operator">≟</a> <a id="1280" class="Bound">x</a> <a id="1282" class="Symbol">|</a> <a id="1284" href="Axiom.Set.Rel.html#5977" class="Function">∈-mapMaybeWithKey</a> <a id="1302" class="Symbol">{</a><a id="1303" class="Argument">f</a> <a id="1305" class="Symbol">=</a> <a id="1307" href="Ledger.Chain.html#846" class="Function">maybePurpose</a> <a id="1320" class="Bound">prps</a><a id="1324" class="Symbol">}</a> <a id="1326" href="Ledger.Chain.html#1262" class="Bound">∈mmwk</a>
<a id="1332" class="Symbol">...</a> <a id="1336" class="Symbol">|</a> <a id="1338" href="Relation.Nullary.Decidable.Core.html#1994" class="InductiveConstructor">yes</a> <a id="1342" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a> <a id="1347" class="Symbol">|</a> <a id="1349" class="Symbol">_</a> <a id="1351" class="Symbol">=</a> <a id="1353" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a>

<a id="filterPurpose"></a><a id="1359" href="Ledger.Chain.html#1359" class="Function">filterPurpose</a> <a id="1373" class="Symbol">:</a> <a id="1375" href="Ledger.Certs.html#286" class="Datatype">DepositPurpose</a> <a id="1390" class="Symbol">→</a> <a id="1392" class="Symbol">(</a><a id="1393" href="Ledger.Certs.html#286" class="Datatype">DepositPurpose</a> <a id="1408" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="1410" href="Ledger.Address.html#273" class="Datatype">Credential</a><a id="1420" class="Symbol">)</a> <a id="1422" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="1424" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="1429" class="Symbol">→</a> <a id="1431" href="Ledger.Address.html#273" class="Datatype">Credential</a> <a id="1442" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="1444" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="1449" href="Ledger.Chain.html#1359" class="Function">filterPurpose</a> <a id="1463" href="Ledger.Chain.html#1463" class="Bound">prps</a> <a id="1468" href="Ledger.Chain.html#1468" class="Bound">m</a> <a id="1470" class="Symbol">=</a> <a id="1472" href="Axiom.Set.Map.html#5896" class="Function">mapKeys</a> <a id="1480" href="Data.Product.Base.html#650" class="Field">proj₂</a> <a id="1486" class="Symbol">(</a><a id="1487" href="Axiom.Set.Map.html#10313" class="Function">mapMaybeWithKeyᵐ</a> <a id="1504" class="Symbol">(</a><a id="1505" href="Ledger.Chain.html#846" class="Function">maybePurpose</a> <a id="1518" href="Ledger.Chain.html#1463" class="Bound">prps</a><a id="1522" class="Symbol">)</a> <a id="1524" href="Ledger.Chain.html#1468" class="Bound">m</a><a id="1525" class="Symbol">)</a>
  <a id="1529" class="Symbol">{λ</a> <a id="1532" class="Keyword">where</a> <a id="1538" href="Ledger.Chain.html#1538" class="Bound">x∈dom</a> <a id="1544" href="Ledger.Chain.html#1544" class="Bound">y∈dom</a> <a id="1550" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a> <a id="1555" class="Symbol">→</a> <a id="1557" href="Relation.Binary.PropositionalEquality.Core.html#1339" class="Function">cong</a> <a id="1562" class="Symbol">(</a><a id="1563" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">_,</a> <a id="1566" class="Symbol">_)</a>
                            <a id="1597" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="1599" href="Relation.Binary.PropositionalEquality.Core.html#1938" class="Function">trans</a> <a id="1605" class="Symbol">(</a><a id="1606" href="Ledger.Chain.html#1021" class="Function">maybePurpose-prop</a> <a id="1624" class="Symbol">{</a><a id="1625" class="Argument">prps</a> <a id="1630" class="Symbol">=</a> <a id="1632" href="Ledger.Chain.html#1463" class="Bound">prps</a><a id="1636" class="Symbol">}</a> <a id="1638" href="Ledger.Chain.html#1468" class="Bound">m</a> <a id="1640" href="Ledger.Chain.html#1538" class="Bound">x∈dom</a><a id="1645" class="Symbol">)</a>
                            <a id="1675" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="1677" href="Relation.Binary.PropositionalEquality.Core.html#1893" class="Function">sym</a>   <a id="1683" class="Symbol">(</a><a id="1684" href="Ledger.Chain.html#1021" class="Function">maybePurpose-prop</a> <a id="1702" class="Symbol">{</a><a id="1703" class="Argument">prps</a> <a id="1708" class="Symbol">=</a> <a id="1710" href="Ledger.Chain.html#1463" class="Bound">prps</a><a id="1714" class="Symbol">}</a> <a id="1716" href="Ledger.Chain.html#1468" class="Bound">m</a> <a id="1718" href="Ledger.Chain.html#1544" class="Bound">y∈dom</a><a id="1723" class="Symbol">)}</a>

<a id="govActionDeposits"></a><a id="1727" href="Ledger.Chain.html#1727" class="Function">govActionDeposits</a> <a id="1745" class="Symbol">:</a> <a id="1747" href="Ledger.Ledger.html#715" class="Record">LState</a> <a id="1754" class="Symbol">→</a> <a id="1756" href="Ledger.GovernanceActions.html#458" class="Datatype">VDeleg</a> <a id="1763" href="abstract-set-theory.FiniteSetTheory.html#633" class="Function Operator">⇀</a> <a id="1765" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="1770" href="Ledger.Chain.html#1727" class="Function">govActionDeposits</a> <a id="1788" href="Ledger.Chain.html#1788" class="Bound">ls</a> <a id="1791" class="Symbol">=</a>
  <a id="1795" class="Keyword">let</a> <a id="1799" class="Keyword">open</a> <a id="1804" href="Ledger.Ledger.html#715" class="Module">LState</a> <a id="1811" href="Ledger.Chain.html#1788" class="Bound">ls</a><a id="1813" class="Symbol">;</a> <a id="1815" class="Keyword">open</a> <a id="1820" href="Ledger.Certs.html#2825" class="Module">CertState</a> <a id="1830" href="Ledger.Ledger.html#827" class="Field">certState</a><a id="1839" class="Symbol">;</a> <a id="1841" class="Keyword">open</a> <a id="1846" href="Ledger.Certs.html#2574" class="Module">PState</a> <a id="1853" href="Ledger.Certs.html#2908" class="Function">pState</a>
      <a id="1866" class="Keyword">open</a> <a id="1871" href="Ledger.Utxo.html#2516" class="Module">UTxOState</a> <a id="1881" href="Ledger.Ledger.html#774" class="Field">utxoSt</a><a id="1887" class="Symbol">;</a> <a id="1889" class="Keyword">open</a> <a id="1894" href="Ledger.Certs.html#2393" class="Module">DState</a> <a id="1901" href="Ledger.Certs.html#2888" class="Function">dState</a>
   <a id="1911" class="Keyword">in</a> <a id="1914" href="Data.List.Base.html#4249" class="Function">foldl</a> <a id="1920" href="Axiom.Set.Map.Dec.html#1854" class="Function Operator">_∪⁺_</a> <a id="1925" href="Class.HasEmptySet.html#287" class="Field">∅</a> <a id="1927" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="1929" href="abstract-set-theory.FiniteSetTheory.html#2463" class="Function">setToList</a> <a id="1939" href="Function.Base.html#1974" class="Function Operator">$</a>
    <a id="1945" href="Axiom.Set.html#7805" class="Function">mapPartial</a>
      <a id="1962" class="Symbol">(λ</a> <a id="1965" class="Keyword">where</a> <a id="1971" class="Symbol">(</a><a id="1972" href="Ledger.Chain.html#1972" class="Bound">gaid</a> <a id="1977" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1979" class="Keyword">record</a> <a id="1986" class="Symbol">{</a> <a id="1988" href="Ledger.GovernanceActions.html#2370" class="Field">returnAddr</a> <a id="1999" class="Symbol">=</a> <a id="2001" class="Keyword">record</a> <a id="2008" class="Symbol">{</a><a id="2009" href="Ledger.Address.html#1265" class="Field">stake</a> <a id="2015" class="Symbol">=</a> <a id="2017" href="Ledger.Chain.html#2017" class="Bound">c</a><a id="2018" class="Symbol">}</a> <a id="2020" class="Symbol">})</a> <a id="2023" class="Symbol">→</a> <a id="2025" class="Keyword">do</a>
        <a id="2036" href="Ledger.Chain.html#2036" class="Bound">vd</a> <a id="2039" href="Class.Monad.Core.html#290" class="Field Operator">←</a> <a id="2041" href="Axiom.Set.Map.html#13670" class="Function">lookupᵐ?</a> <a id="2050" href="Ledger.Certs.html#2452" class="Function">voteDelegs</a> <a id="2061" href="Ledger.Chain.html#2017" class="Bound">c</a>
        <a id="2071" href="Ledger.Chain.html#2071" class="Bound">dep</a> <a id="2075" href="Class.Monad.Core.html#290" class="Field Operator">←</a> <a id="2077" href="Axiom.Set.Map.html#13670" class="Function">lookupᵐ?</a> <a id="2086" href="Ledger.Utxo.html#2624" class="Function">deposits</a> <a id="2095" class="Symbol">(</a><a id="2096" href="Ledger.Certs.html#475" class="InductiveConstructor">GovActionDeposit</a> <a id="2113" href="Ledger.Chain.html#1972" class="Bound">gaid</a><a id="2117" class="Symbol">)</a>
        <a id="2127" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="2132" href="Class.HasSingleton.html#288" class="Field Operator">❴</a> <a id="2134" href="Ledger.Chain.html#2036" class="Bound">vd</a> <a id="2137" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="2139" href="Ledger.Chain.html#2071" class="Bound">dep</a> <a id="2143" href="Class.HasSingleton.html#288" class="Field Operator">❵</a> <a id="2145" class="Symbol">)</a>
      <a id="2153" class="Symbol">(</a><a id="2154" href="Axiom.Set.html#5718" class="Function">fromList</a> <a id="2163" href="Ledger.Ledger.html#801" class="Field">govSt</a><a id="2168" class="Symbol">)</a>

<a id="calculateStakeDistrs"></a><a id="2171" href="Ledger.Chain.html#2171" class="Function">calculateStakeDistrs</a> <a id="2192" class="Symbol">:</a> <a id="2194" href="Ledger.Ledger.html#715" class="Record">LState</a> <a id="2201" class="Symbol">→</a> <a id="2203" href="Ledger.Ratify.html#2890" class="Record">StakeDistrs</a>
<a id="2215" href="Ledger.Chain.html#2171" class="Function">calculateStakeDistrs</a> <a id="2236" href="Ledger.Chain.html#2236" class="Bound">ls</a> <a id="2239" class="Symbol">=</a>
  <a id="2243" class="Keyword">let</a> <a id="2247" class="Keyword">open</a> <a id="2252" href="Ledger.Ledger.html#715" class="Module">LState</a> <a id="2259" href="Ledger.Chain.html#2236" class="Bound">ls</a><a id="2261" class="Symbol">;</a> <a id="2263" class="Keyword">open</a> <a id="2268" href="Ledger.Certs.html#2825" class="Module">CertState</a> <a id="2278" href="Ledger.Ledger.html#827" class="Field">certState</a><a id="2287" class="Symbol">;</a> <a id="2289" class="Keyword">open</a> <a id="2294" href="Ledger.Certs.html#2574" class="Module">PState</a> <a id="2301" href="Ledger.Certs.html#2908" class="Function">pState</a>
      <a id="2314" class="Keyword">open</a> <a id="2319" href="Ledger.Utxo.html#2516" class="Module">UTxOState</a> <a id="2329" href="Ledger.Ledger.html#774" class="Field">utxoSt</a><a id="2335" class="Symbol">;</a> <a id="2337" class="Keyword">open</a> <a id="2342" href="Ledger.Certs.html#2393" class="Module">DState</a> <a id="2349" href="Ledger.Certs.html#2888" class="Function">dState</a>
      <a id="2362" href="Ledger.Chain.html#2362" class="Bound">spoDelegs</a> <a id="2372" class="Symbol">=</a> <a id="2374" href="Class.HasEmptySet.html#287" class="Field">∅</a> <a id="2376" class="Comment">-- TODO</a>
      <a id="2390" href="Ledger.Chain.html#2390" class="Bound">drepDelegs</a> <a id="2401" class="Symbol">=</a> <a id="2403" href="Class.HasEmptySet.html#287" class="Field">∅</a> <a id="2405" class="Comment">-- TODO</a>
  <a id="2415" class="Keyword">in</a>
  <a id="2420" class="Keyword">record</a>
    <a id="2431" class="Symbol">{</a> <a id="2433" href="Ledger.Ratify.html#2927" class="Field">stakeDistr</a> <a id="2444" class="Symbol">=</a> <a id="2446" href="Ledger.Chain.html#1727" class="Function">govActionDeposits</a> <a id="2464" href="Ledger.Chain.html#2236" class="Bound">ls</a>
    <a id="2471" class="Symbol">}</a>

<a id="totalRefScriptsSize"></a><a id="2474" href="Ledger.Chain.html#2474" class="Function">totalRefScriptsSize</a> <a id="2494" class="Symbol">:</a> <a id="2496" href="Ledger.Ledger.html#715" class="Record">LState</a> <a id="2503" class="Symbol">→</a> <a id="2505" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="2510" href="Ledger.Transaction.html#3538" class="Record">Tx</a> <a id="2513" class="Symbol">→</a> <a id="2515" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
<a id="2517" href="Ledger.Chain.html#2474" class="Function">totalRefScriptsSize</a> <a id="2537" href="Ledger.Chain.html#2537" class="Bound">lst</a> <a id="2541" href="Ledger.Chain.html#2541" class="Bound">txs</a> <a id="2545" class="Symbol">=</a> <a id="2547" href="Data.List.Base.html#4964" class="Function">sum</a> <a id="2551" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="2553" href="Class.Functor.Core.html#263" class="Function">map</a> <a id="2557" class="Symbol">(</a><a id="2558" href="Ledger.Utxo.html#3183" class="Function">refScriptsSize</a> <a id="2573" href="Ledger.Utxo.html#2580" class="Function">utxo</a><a id="2577" class="Symbol">)</a> <a id="2579" href="Ledger.Chain.html#2541" class="Bound">txs</a>
  <a id="2585" class="Keyword">where</a> <a id="2591" class="Keyword">open</a> <a id="2596" href="Ledger.Utxo.html#2516" class="Module">UTxOState</a> <a id="2606" class="Symbol">(</a><a id="2607" href="Ledger.Ledger.html#774" class="Field">LState.utxoSt</a> <a id="2621" href="Ledger.Chain.html#2537" class="Bound">lst</a><a id="2624" class="Symbol">)</a>

<a id="2627" class="Keyword">data</a>


  <a id="_⊢_⇀⦇_,CHAIN⦈_"></a><a id="2636" href="Ledger.Chain.html#2636" class="Datatype Operator">_⊢_⇀⦇_,CHAIN⦈_</a> <a id="2651" class="Symbol">:</a> <a id="2653" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a> <a id="2655" class="Symbol">→</a> <a id="2657" href="Ledger.Chain.html#551" class="Record">ChainState</a> <a id="2668" class="Symbol">→</a> <a id="2670" href="Ledger.Chain.html#626" class="Record">Block</a> <a id="2676" class="Symbol">→</a> <a id="2678" href="Ledger.Chain.html#551" class="Record">ChainState</a> <a id="2689" class="Symbol">→</a> <a id="2691" href="Agda.Primitive.html#388" class="Primitive">Type</a>


  <a id="2700" class="Keyword">where</a>


  <a id="_⊢_⇀⦇_,CHAIN⦈_.CHAIN"></a><a id="2710" href="Ledger.Chain.html#2710" class="InductiveConstructor">CHAIN</a> <a id="2716" class="Symbol">:</a>


    <a id="2724" class="Keyword">let</a> <a id="2728" class="Keyword">open</a> <a id="2733" href="Ledger.Chain.html#551" class="Module">ChainState</a> <a id="2744" href="Ledger.Chain.html#711" class="Generalizable">s</a><a id="2745" class="Symbol">;</a> <a id="2747" class="Keyword">open</a> <a id="2752" href="Ledger.Chain.html#626" class="Module">Block</a> <a id="2758" href="Ledger.Chain.html#728" class="Generalizable">b</a><a id="2759" class="Symbol">;</a> <a id="2761" class="Keyword">open</a> <a id="2766" href="Ledger.Epoch.html#1330" class="Module">NewEpochState</a> <a id="2780" href="Ledger.Chain.html#755" class="Generalizable">nes</a>
        <a id="2792" class="Keyword">open</a> <a id="2797" href="Ledger.Epoch.html#1127" class="Module">EpochState</a> <a id="2808" href="Ledger.Epoch.html#1393" class="Function">epochState</a><a id="2818" class="Symbol">;</a> <a id="2820" class="Keyword">open</a> <a id="2825" href="Ledger.Enact.html#397" class="Module">EnactState</a> <a id="2836" href="Ledger.Epoch.html#1268" class="Function">es</a>
        <a id="2847" href="Ledger.Chain.html#2847" class="Bound">pp</a> <a id="2850" class="Symbol">=</a> <a id="2852" href="Ledger.Enact.html#607" class="Function">pparams</a> <a id="2860" class="Symbol">.</a><a id="2861" href="Data.Product.Base.html#636" class="Field">proj₁</a><a id="2866" class="Symbol">;</a> <a id="2868" class="Keyword">open</a> <a id="2873" href="Ledger.PParams.html#1389" class="Module">PParams</a> <a id="2881" href="Ledger.Chain.html#2847" class="Bound">pp</a> <a id="2884" class="Keyword">using</a> <a id="2890" class="Symbol">(</a><a id="2891" href="Ledger.PParams.html#2161" class="Field">maxRefScriptSizePerBlock</a><a id="2915" class="Symbol">)</a>
    <a id="2921" class="Keyword">in</a>


    <a id="2930" href="Ledger.Chain.html#2474" class="Function">totalRefScriptsSize</a> <a id="2950" href="Ledger.Epoch.html#1244" class="Function">ls</a> <a id="2953" href="Ledger.Chain.html#657" class="Function">ts</a> <a id="2956" href="Class.HasOrder.Core.html#551" class="Field Operator">≤</a> <a id="2958" href="Ledger.PParams.html#2161" class="Function">maxRefScriptSizePerBlock</a>
    <a id="2987" class="Symbol">→</a>  <a id="2990" class="Symbol">_</a>   <a id="2994" href="Ledger.Epoch.html#7026" class="Datatype Operator">⊢</a> <a id="2996" href="Ledger.Chain.html#587" class="Function">newEpochState</a> <a id="3010" href="Ledger.Epoch.html#7026" class="Datatype Operator">⇀⦇</a> <a id="3013" href="Ledger.Types.Epoch.html#688" class="Function">epoch</a> <a id="3019" href="Ledger.Chain.html#677" class="Function">slot</a> <a id="3024" href="Ledger.Epoch.html#7026" class="Datatype Operator">,NEWEPOCH⦈</a> <a id="3035" href="Ledger.Chain.html#755" class="Generalizable">nes</a>
    <a id="3043" class="Symbol">→</a>  <a id="3046" href="Class.To.html#102" class="Field Operator">⟦</a> <a id="3048" href="Ledger.Chain.html#677" class="Function">slot</a> <a id="3053" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3055" href="Ledger.Enact.html#502" class="Function">constitution</a> <a id="3068" class="Symbol">.</a><a id="3069" href="Data.Product.Base.html#636" class="Field">proj₁</a> <a id="3075" class="Symbol">.</a><a id="3076" href="Data.Product.Base.html#650" class="Field">proj₂</a> <a id="3082" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3084" href="Ledger.Chain.html#2847" class="Bound">pp</a> <a id="3087" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3089" href="Ledger.Epoch.html#1268" class="Function">es</a> <a id="3092" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3094" href="Ledger.PParams.html#675" class="Field">Acnt.treasury</a> <a id="3108" href="Ledger.Epoch.html#1195" class="Function">acnt</a> <a id="3113" href="Class.To.html#102" class="Field Operator">⟧</a> <a id="3115" href="Ledger.Ledger.html#2968" class="Function Operator">⊢</a> <a id="3117" href="Ledger.Epoch.html#1244" class="Function">ls</a> <a id="3120" href="Ledger.Ledger.html#2968" class="Function Operator">⇀⦇</a> <a id="3123" href="Ledger.Chain.html#657" class="Function">ts</a> <a id="3126" href="Ledger.Ledger.html#2968" class="Function Operator">,LEDGERS⦈</a> <a id="3136" href="Ledger.Chain.html#740" class="Generalizable">ls&#39;</a>
    <a id="3144" href="Interface.STS.html#350" class="Function Operator">────────────────────────────────</a>
    <a id="3181" class="Symbol">_</a> <a id="3183" href="Ledger.Chain.html#2636" class="Datatype Operator">⊢</a> <a id="3185" href="Ledger.Chain.html#711" class="Generalizable">s</a> <a id="3187" href="Ledger.Chain.html#2636" class="Datatype Operator">⇀⦇</a> <a id="3190" href="Ledger.Chain.html#728" class="Generalizable">b</a> <a id="3192" href="Ledger.Chain.html#2636" class="Datatype Operator">,CHAIN⦈</a> <a id="3200" class="Keyword">record</a> <a id="3207" href="Ledger.Chain.html#711" class="Generalizable">s</a> <a id="3209" class="Symbol">{</a>  <a id="3212" href="Ledger.Chain.html#587" class="Field">newEpochState</a> <a id="3226" class="Symbol">=</a>
                                   <a id="3263" class="Keyword">record</a> <a id="3270" href="Ledger.Chain.html#755" class="Generalizable">nes</a> <a id="3274" class="Symbol">{</a>  <a id="3277" href="Ledger.Epoch.html#1393" class="Field">epochState</a> <a id="3288" class="Symbol">=</a>
                                                 <a id="3339" class="Keyword">record</a> <a id="3346" href="Ledger.Epoch.html#1393" class="Function">epochState</a> <a id="3357" class="Symbol">{</a> <a id="3359" href="Ledger.Epoch.html#1244" class="Field">ls</a> <a id="3362" class="Symbol">=</a> <a id="3364" href="Ledger.Chain.html#740" class="Generalizable">ls&#39;</a><a id="3367" class="Symbol">}</a> <a id="3369" class="Symbol">}</a> <a id="3371" class="Symbol">}</a>

</pre></body></html>