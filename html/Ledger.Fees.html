<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Ledger.Fees</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda">
<a id="2" class="Symbol">{-#</a> <a id="6" class="Keyword">OPTIONS</a> <a id="14" class="Pragma">--safe</a> <a id="21" class="Symbol">#-}</a>

<a id="26" class="Keyword">open</a> <a id="31" class="Keyword">import</a> <a id="38" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a> <a id="53" class="Keyword">hiding</a> <a id="60" class="Symbol">(</a><a id="61" href="Data.Nat.Base.html#7279" class="Function Operator">_%_</a><a id="64" class="Symbol">;</a> <a id="66" href="Agda.Builtin.Nat.html#539" class="Primitive Operator">_*_</a><a id="69" class="Symbol">)</a>
<a id="71" class="Keyword">open</a> <a id="76" class="Keyword">import</a> <a id="83" href="Ledger.Abstract.html" class="Module">Ledger.Abstract</a>
<a id="99" class="Keyword">open</a> <a id="104" class="Keyword">import</a> <a id="111" href="Ledger.Transaction.html" class="Module">Ledger.Transaction</a>

<a id="131" class="Keyword">module</a> <a id="138" href="Ledger.Fees.html" class="Module">Ledger.Fees</a>
  <a id="152" class="Symbol">(</a><a id="153" href="Ledger.Fees.html#153" class="Bound">txs</a> <a id="157" class="Symbol">:</a> <a id="159" class="Symbol">_)</a> <a id="162" class="Symbol">(</a><a id="163" class="Keyword">open</a> <a id="168" href="Ledger.Transaction.html#867" class="Module">TransactionStructure</a> <a id="189" href="Ledger.Fees.html#153" class="Bound">txs</a><a id="192" class="Symbol">)</a>
  <a id="196" class="Keyword">where</a>

<a id="203" class="Keyword">open</a> <a id="208" class="Keyword">import</a> <a id="215" href="Data.Rational.html" class="Module">Data.Rational</a> <a id="229" class="Keyword">using</a> <a id="235" class="Symbol">(</a><a id="236" href="Data.Rational.Base.html#4325" class="Function">0ℚ</a><a id="238" class="Symbol">;</a> <a id="240" href="Data.Rational.Base.html#1342" class="Record">ℚ</a><a id="241" class="Symbol">;</a> <a id="243" href="Data.Rational.Base.html#1960" class="Function">mkℚ+</a><a id="247" class="Symbol">;</a> <a id="249" href="Data.Rational.Base.html#6315" class="Function Operator">_*_</a><a id="252" class="Symbol">;</a> <a id="254" href="Data.Rational.Base.html#7116" class="Function">floor</a><a id="259" class="Symbol">)</a>
<a id="261" class="Keyword">open</a> <a id="266" class="Keyword">import</a> <a id="273" href="Data.Rational.Literals.html" class="Module">Data.Rational.Literals</a> <a id="296" class="Keyword">using</a> <a id="302" class="Symbol">(</a><a id="303" href="Data.Rational.Literals.html#740" class="Function">number</a><a id="309" class="Symbol">)</a>
<a id="311" class="Keyword">open</a> <a id="316" class="Keyword">import</a> <a id="323" href="Data.Nat.Induction.html" class="Module">Data.Nat.Induction</a> <a id="342" class="Keyword">using</a> <a id="348" class="Symbol">(</a><a id="349" href="Data.Nat.Induction.html#1604" class="Function">&lt;′-wellFounded</a><a id="363" class="Symbol">)</a>
<a id="365" class="Keyword">open</a> <a id="370" class="Keyword">import</a> <a id="377" href="Data.Nat.Properties.html" class="Module">Data.Nat.Properties</a> <a id="397" class="Keyword">using</a> <a id="403" class="Symbol">(</a><a id="404" href="Data.Nat.Properties.html#63833" class="Function">≤′-trans</a><a id="412" class="Symbol">;</a> <a id="414" href="Data.Nat.Properties.html#64747" class="Function">&lt;⇒&lt;′</a><a id="418" class="Symbol">;</a> <a id="420" href="Data.Nat.Properties.html#9357" class="Function">≰⇒&gt;</a><a id="423" class="Symbol">)</a>
<a id="425" class="Keyword">open</a> <a id="430" class="Keyword">import</a> <a id="437" href="Data.Integer.html" class="Module">Data.Integer</a> <a id="450" class="Keyword">using</a> <a id="456" class="Symbol">(</a><a id="457" href="Data.Integer.Base.html#1715" class="Function Operator">∣_∣</a><a id="460" class="Symbol">)</a>
<a id="462" class="Keyword">open</a> <a id="467" class="Keyword">import</a> <a id="474" href="Induction.WellFounded.html" class="Module">Induction.WellFounded</a> <a id="496" class="Keyword">using</a> <a id="502" class="Symbol">(</a><a id="503" href="Induction.WellFounded.html#1356" class="Datatype">Acc</a><a id="506" class="Symbol">;</a> <a id="508" href="Induction.WellFounded.html#1418" class="InductiveConstructor">acc</a><a id="511" class="Symbol">)</a>
<a id="513" class="Keyword">open</a> <a id="518" class="Keyword">import</a> <a id="525" href="Agda.Builtin.FromNat.html" class="Module">Agda.Builtin.FromNat</a> <a id="546" class="Keyword">using</a> <a id="552" class="Symbol">(</a><a id="553" href="Agda.Builtin.FromNat.html#196" class="Record">Number</a><a id="559" class="Symbol">)</a>

<a id="562" class="Keyword">open</a> <a id="567" href="Agda.Builtin.FromNat.html#196" class="Module">Number</a> <a id="574" href="Data.Rational.Literals.html#740" class="Function">number</a> <a id="581" class="Keyword">renaming</a> <a id="590" class="Symbol">(</a><a id="591" href="Agda.Builtin.FromNat.html#281" class="Field">fromNat</a> <a id="599" class="Symbol">to</a> <a id="602" class="Field">fromℕ</a><a id="607" class="Symbol">)</a>


<a id="scriptsCost"></a><a id="611" href="Ledger.Fees.html#611" class="Function">scriptsCost</a> <a id="623" class="Symbol">:</a> <a id="625" class="Symbol">(</a><a id="626" href="Ledger.Fees.html#626" class="Bound">pp</a> <a id="629" class="Symbol">:</a> <a id="631" href="Ledger.PParams.html#1443" class="Record">PParams</a><a id="638" class="Symbol">)</a> <a id="640" class="Symbol">→</a> <a id="642" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="644" class="Symbol">→</a> <a id="646" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="651" href="Ledger.Fees.html#611" class="Function">scriptsCost</a> <a id="663" href="Ledger.Fees.html#663" class="Bound">pp</a> <a id="666" href="Ledger.Fees.html#666" class="Bound">scriptSize</a>


  <a id="681" class="Keyword">with</a> <a id="686" class="Symbol">(</a><a id="687" href="Ledger.PParams.html#2397" class="Field">PParams.refScriptCostStride</a> <a id="715" href="Ledger.Fees.html#663" class="Bound">pp</a><a id="717" class="Symbol">)</a>
<a id="719" class="Symbol">...</a> <a id="723" class="Symbol">|</a> <a id="725" class="Number">0</a> <a id="727" class="Symbol">=</a> <a id="729" class="Number">0</a>  <a id="732" class="Comment">-- This case should never occur; refScriptCostStride should always be &gt; 0.</a>
<a id="807" class="Symbol">...</a> <a id="811" class="Symbol">|</a> <a id="813" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="817" href="Ledger.Fees.html#817" class="Bound">m</a>


  <a id="823" class="Symbol">=</a> <a id="825" href="Ledger.Fees.html#1027" class="Function">scriptsCostAux</a> <a id="840" href="Data.Rational.Base.html#4325" class="Function">0ℚ</a> <a id="843" href="Ledger.PParams.html#2271" class="Function">minFeeRefScriptCoinsPerByte</a> <a id="871" class="Bound">scriptSize</a>


                  <a id="902" class="Symbol">(</a><a id="903" href="Data.Nat.Induction.html#1604" class="Function">&lt;′-wellFounded</a> <a id="918" class="Bound">scriptSize</a><a id="928" class="Symbol">)</a>


  <a id="934" class="Keyword">where</a>
    <a id="944" class="Keyword">open</a> <a id="949" href="Ledger.PParams.html#1443" class="Module">PParams</a> <a id="957" class="Bound">pp</a> <a id="960" class="Keyword">hiding</a> <a id="967" class="Symbol">(</a><a id="968" href="Ledger.PParams.html#2397" class="Field">refScriptCostStride</a><a id="987" class="Symbol">)</a>
    <a id="993" href="Ledger.Fees.html#993" class="Function">refScriptCostStride</a> <a id="1013" class="Symbol">=</a> <a id="1015" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="1019" href="Ledger.Fees.html#817" class="Bound">m</a>


    <a id="1027" href="Ledger.Fees.html#1027" class="Function">scriptsCostAux</a> <a id="1042" class="Symbol">:</a> <a id="1044" href="Data.Rational.Base.html#1342" class="Record">ℚ</a>        <a id="1053" class="Comment">-- accumulator</a>
                   <a id="1087" class="Symbol">→</a> <a id="1089" href="Data.Rational.Base.html#1342" class="Record">ℚ</a>        <a id="1098" class="Comment">-- current tier price</a>
                   <a id="1139" class="Symbol">→</a> <a id="1141" class="Symbol">(</a><a id="1142" href="Ledger.Fees.html#1142" class="Bound">n</a> <a id="1144" class="Symbol">:</a> <a id="1146" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="1147" class="Symbol">)</a>  <a id="1150" class="Comment">-- remaining script size</a>


                   <a id="1196" class="Symbol">→</a> <a id="1198" href="Induction.WellFounded.html#1356" class="Datatype">Acc</a> <a id="1202" href="Data.Nat.Base.html#7825" class="Function Operator">_&lt;′_</a> <a id="1207" href="Ledger.Fees.html#1142" class="Bound">n</a>


                   <a id="1230" class="Symbol">→</a> <a id="1232" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
    <a id="1241" href="Ledger.Fees.html#1027" class="Function">scriptsCostAux</a> <a id="1256" href="Ledger.Fees.html#1256" class="Bound">acl</a> <a id="1260" href="Ledger.Fees.html#1260" class="Bound">curTierPrice</a> <a id="1273" href="Ledger.Fees.html#1273" class="Bound">n</a>


      <a id="1283" class="Symbol">(</a><a id="1284" href="Induction.WellFounded.html#1418" class="InductiveConstructor">acc</a> <a id="1288" href="Ledger.Fees.html#1288" class="Bound">rs</a><a id="1290" class="Symbol">)</a>


        <a id="1302" class="Symbol">=</a> <a id="1304" href="Function.Base.html#4042" class="Function Operator">case</a> <a id="1309" href="Ledger.Fees.html#1273" class="Bound">n</a> <a id="1311" href="Class.HasOrder.Core.html#1011" class="Function Operator">≤?</a> <a id="1314" href="Ledger.Fees.html#993" class="Function">refScriptCostStride</a> <a id="1334" href="Function.Base.html#4042" class="Function Operator">of</a> <a id="1337" class="Symbol">λ</a> <a id="1339" class="Keyword">where</a>
            <a id="1357" class="Symbol">(</a><a id="1358" href="Relation.Nullary.Decidable.Core.html#1994" class="InductiveConstructor">yes</a> <a id="1362" class="Symbol">_)</a>  <a id="1366" class="Symbol">→</a> <a id="1368" href="Data.Integer.Base.html#1715" class="Function Operator">∣</a> <a id="1370" href="Data.Rational.Base.html#7116" class="Function">floor</a> <a id="1376" class="Symbol">(</a><a id="1377" href="Ledger.Fees.html#1256" class="Bound">acl</a> <a id="1381" href="Class.HasAdd.Core.html#162" class="Field Operator">+</a> <a id="1383" class="Symbol">(</a><a id="1384" href="Ledger.Fees.html#602" class="Function">fromℕ</a> <a id="1390" href="Ledger.Fees.html#1273" class="Bound">n</a> <a id="1392" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="1394" href="Ledger.Fees.html#1260" class="Bound">curTierPrice</a><a id="1406" class="Symbol">))</a> <a id="1409" href="Data.Integer.Base.html#1715" class="Function Operator">∣</a>
            <a id="1423" class="Symbol">(</a><a id="1424" href="Relation.Nullary.Decidable.Core.html#2031" class="InductiveConstructor">no</a>  <a id="1428" href="Ledger.Fees.html#1428" class="Bound">p</a><a id="1429" class="Symbol">)</a>  <a id="1432" class="Symbol">→</a> <a id="1434" href="Ledger.Fees.html#1027" class="Function">scriptsCostAux</a> <a id="1449" class="Symbol">(</a><a id="1450" href="Ledger.Fees.html#1256" class="Bound">acl</a> <a id="1454" href="Class.HasAdd.Core.html#162" class="Field Operator">+</a> <a id="1456" class="Symbol">(</a><a id="1457" href="Ledger.Fees.html#602" class="Function">fromℕ</a> <a id="1463" href="Ledger.Fees.html#993" class="Function">refScriptCostStride</a> <a id="1483" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="1485" href="Ledger.Fees.html#1260" class="Bound">curTierPrice</a><a id="1497" class="Symbol">))</a>
                                      <a id="1538" class="Symbol">(</a><a id="1539" href="Ledger.PParams.html#2439" class="Function">refScriptCostMultiplier</a> <a id="1563" href="Data.Rational.Base.html#6315" class="Function Operator">*</a> <a id="1565" href="Ledger.Fees.html#1260" class="Bound">curTierPrice</a><a id="1577" class="Symbol">)</a>
                                      <a id="1617" class="Symbol">(</a><a id="1618" href="Ledger.Fees.html#1273" class="Bound">n</a> <a id="1620" href="Interface.HasSubtract.html#209" class="Field Operator">-</a> <a id="1622" href="Ledger.Fees.html#993" class="Function">refScriptCostStride</a><a id="1641" class="Symbol">)</a>


                                     <a id="1682" class="Symbol">(</a><a id="1683" href="Ledger.Fees.html#1288" class="Bound">rs</a> <a id="1686" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="1688" href="Ledger.Fees.html#1766" class="Function">suc∸≤′</a> <a id="1695" class="Symbol">(</a><a id="1696" href="Data.Nat.Properties.html#63833" class="Function">≤′-trans</a> <a id="1705" class="Symbol">(</a><a id="1706" href="Data.Nat.Properties.html#64747" class="Function">&lt;⇒&lt;′</a> <a id="1711" href="Data.Nat.Base.html#1873" class="InductiveConstructor">z&lt;s</a><a id="1714" class="Symbol">)</a> <a id="1716" class="Symbol">(</a><a id="1717" href="Data.Nat.Properties.html#64747" class="Function">&lt;⇒&lt;′</a> <a id="1722" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="1724" href="Data.Nat.Properties.html#9357" class="Function">≰⇒&gt;</a> <a id="1728" href="Ledger.Fees.html#1428" class="Bound">p</a><a id="1729" class="Symbol">))</a> <a id="1732" class="Symbol">(</a><a id="1733" href="Data.Nat.Properties.html#64747" class="Function">&lt;⇒&lt;′</a> <a id="1738" href="Data.Nat.Base.html#1873" class="InductiveConstructor">z&lt;s</a><a id="1741" class="Symbol">))</a>


      <a id="1752" class="Keyword">where</a>
        <a id="1766" href="Ledger.Fees.html#1766" class="Function">suc∸≤′</a> <a id="1773" class="Symbol">:</a> <a id="1775" class="Symbol">∀</a> <a id="1777" class="Symbol">{</a><a id="1778" href="Ledger.Fees.html#1778" class="Bound">n</a> <a id="1780" href="Ledger.Fees.html#1780" class="Bound">m</a><a id="1781" class="Symbol">}</a> <a id="1783" class="Symbol">→</a> <a id="1785" href="Ledger.Fees.html#1778" class="Bound">n</a> <a id="1787" href="Data.Nat.Base.html#8006" class="Function Operator">&gt;′</a> <a id="1790" class="Number">0</a> <a id="1792" class="Symbol">→</a> <a id="1794" href="Ledger.Fees.html#1780" class="Bound">m</a> <a id="1796" href="Data.Nat.Base.html#8006" class="Function Operator">&gt;′</a> <a id="1799" class="Number">0</a> <a id="1801" class="Symbol">→</a> <a id="1803" href="Ledger.Fees.html#1778" class="Bound">n</a> <a id="1805" href="Data.Nat.Base.html#4456" class="Primitive Operator">∸</a> <a id="1807" href="Ledger.Fees.html#1780" class="Bound">m</a> <a id="1809" href="Data.Nat.Base.html#7825" class="Function Operator">&lt;′</a> <a id="1812" href="Ledger.Fees.html#1778" class="Bound">n</a>
        <a id="1822" href="Ledger.Fees.html#1766" class="Function">suc∸≤′</a> <a id="1829" class="Symbol">{</a><a id="1830" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="1834" class="DottedPattern Symbol">.</a><a id="1835" class="DottedPattern Number">0</a><a id="1836" class="Symbol">}</a> <a id="1838" class="Symbol">{</a><a id="1839" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="1843" href="Agda.Builtin.Nat.html#221" class="InductiveConstructor">zero</a><a id="1847" class="Symbol">}</a> <a id="1849" href="Data.Nat.Base.html#7901" class="InductiveConstructor">&lt;′-base</a> <a id="1857" href="Ledger.Fees.html#1857" class="Bound">x</a> <a id="1859" class="Symbol">=</a> <a id="1861" href="Ledger.Fees.html#1857" class="Bound">x</a>
        <a id="1871" href="Ledger.Fees.html#1766" class="Function">suc∸≤′</a> <a id="1878" class="Symbol">{</a><a id="1879" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="1883" class="DottedPattern Symbol">.</a><a id="1884" class="DottedPattern Number">0</a><a id="1885" class="Symbol">}</a> <a id="1887" class="Symbol">{</a><a id="1888" href="Data.Nat.Base.html#1095" class="InductiveConstructor">2+</a> <a id="1891" href="Ledger.Fees.html#1891" class="Bound">m</a><a id="1892" class="Symbol">}</a> <a id="1894" href="Data.Nat.Base.html#7901" class="InductiveConstructor">&lt;′-base</a> <a id="1902" class="Symbol">_</a> <a id="1904" class="Symbol">=</a> <a id="1906" href="Data.Nat.Base.html#7901" class="InductiveConstructor">&lt;′-base</a>
        <a id="1922" href="Ledger.Fees.html#1766" class="Function">suc∸≤′</a> <a id="1929" class="Symbol">{</a><a id="1930" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="1934" class="Symbol">_}</a> <a id="1937" class="Symbol">{</a><a id="1938" href="Agda.Builtin.Nat.html#234" class="InductiveConstructor">suc</a> <a id="1942" class="DottedPattern Symbol">.</a><a id="1943" class="DottedPattern Number">0</a><a id="1944" class="Symbol">}</a> <a id="1946" class="Symbol">(</a><a id="1947" href="Data.Nat.Base.html#7779" class="InductiveConstructor">≤′-step</a> <a id="1955" class="Symbol">_)</a> <a id="1958" href="Data.Nat.Base.html#7901" class="InductiveConstructor">&lt;′-base</a> <a id="1966" class="Symbol">=</a> <a id="1968" href="Data.Nat.Base.html#7901" class="InductiveConstructor">&lt;′-base</a>
        <a id="1984" href="Ledger.Fees.html#1766" class="CatchallClause Function">suc∸≤′</a><a id="1990" class="CatchallClause"> </a><a id="1991" class="CatchallClause Symbol">{</a><a id="1992" href="Agda.Builtin.Nat.html#234" class="CatchallClause InductiveConstructor">suc</a><a id="1995" class="CatchallClause"> </a><a id="1996" class="CatchallClause Symbol">_}</a><a id="1998" class="CatchallClause"> </a><a id="1999" class="CatchallClause Symbol">{</a><a id="2000" href="Agda.Builtin.Nat.html#234" class="CatchallClause InductiveConstructor">suc</a><a id="2003" class="CatchallClause"> </a><a id="2004" class="CatchallClause Symbol">_}</a><a id="2006" class="CatchallClause"> </a><a id="2007" class="CatchallClause Symbol">(</a><a id="2008" href="Data.Nat.Base.html#7779" class="CatchallClause InductiveConstructor">≤′-step</a><a id="2015" class="CatchallClause"> </a><a id="2016" href="Ledger.Fees.html#2016" class="CatchallClause Bound">x</a><a id="2017" class="CatchallClause Symbol">)</a><a id="2018" class="CatchallClause"> </a><a id="2019" class="CatchallClause Symbol">(</a><a id="2020" href="Data.Nat.Base.html#7779" class="CatchallClause InductiveConstructor">≤′-step</a><a id="2027" class="CatchallClause"> </a><a id="2028" href="Ledger.Fees.html#2028" class="CatchallClause Bound">y</a><a id="2029" class="CatchallClause Symbol">)</a> <a id="2031" class="Symbol">=</a> <a id="2033" href="Data.Nat.Base.html#7779" class="InductiveConstructor">≤′-step</a> <a id="2041" class="Symbol">(</a><a id="2042" href="Ledger.Fees.html#1766" class="Function">suc∸≤′</a> <a id="2049" href="Ledger.Fees.html#2016" class="Bound">x</a> <a id="2051" href="Ledger.Fees.html#2028" class="Bound">y</a><a id="2052" class="Symbol">)</a>

</pre></body></html>