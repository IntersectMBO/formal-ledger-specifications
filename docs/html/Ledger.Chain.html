<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Ledger.Chain</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda"><a id="1" class="Background">\section{Blockchain Layer}

</a><a id="29" class="Markup">\begin{code}[hide]</a>
<a id="48" class="Symbol">{-#</a> <a id="52" class="Keyword">OPTIONS</a> <a id="60" class="Pragma">--safe</a> <a id="67" class="Symbol">#-}</a>

<a id="72" class="Keyword">open</a> <a id="77" class="Keyword">import</a> <a id="84" href="Algebra.html" class="Module">Algebra</a>
<a id="92" class="Keyword">open</a> <a id="97" class="Keyword">import</a> <a id="104" href="Data.Nat.Properties.html" class="Module">Data.Nat.Properties</a> <a id="124" class="Keyword">using</a> <a id="130" class="Symbol">(</a><a id="131" href="Data.Nat.Properties.html#16493" class="Function">+-0-monoid</a><a id="141" class="Symbol">)</a>

<a id="144" class="Keyword">open</a> <a id="149" class="Keyword">import</a> <a id="156" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a><a id="170" class="Symbol">;</a> <a id="172" class="Keyword">open</a> <a id="177" href="Function.Bundles.html#4752" class="Module">Equivalence</a>
<a id="189" class="Keyword">open</a> <a id="194" class="Keyword">import</a> <a id="201" href="Ledger.Transaction.html" class="Module">Ledger.Transaction</a>
<a id="220" class="Keyword">open</a> <a id="225" class="Keyword">import</a> <a id="232" href="Ledger.Abstract.html" class="Module">Ledger.Abstract</a>

<a id="249" class="Keyword">module</a> <a id="256" href="Ledger.Chain.html" class="Module">Ledger.Chain</a>
  <a id="271" class="Symbol">(</a><a id="272" href="Ledger.Chain.html#272" class="Bound">txs</a> <a id="276" class="Symbol">:</a> <a id="278" class="Symbol">_)</a> <a id="281" class="Symbol">(</a><a id="282" class="Keyword">open</a> <a id="287" href="Ledger.Transaction.html#933" class="Module">TransactionStructure</a> <a id="308" href="Ledger.Chain.html#272" class="Bound">txs</a><a id="311" class="Symbol">)</a>
  <a id="315" class="Symbol">(</a><a id="316" href="Ledger.Chain.html#316" class="Bound">abs</a> <a id="320" class="Symbol">:</a> <a id="322" href="Ledger.Abstract.html#540" class="Record">AbstractFunctions</a> <a id="340" href="Ledger.Chain.html#272" class="Bound">txs</a><a id="343" class="Symbol">)</a> <a id="345" class="Symbol">(</a><a id="346" class="Keyword">open</a> <a id="351" href="Ledger.Abstract.html#540" class="Module">AbstractFunctions</a> <a id="369" href="Ledger.Chain.html#316" class="Bound">abs</a><a id="372" class="Symbol">)</a>
  <a id="376" class="Keyword">where</a>

<a id="383" class="Keyword">open</a> <a id="388" class="Keyword">import</a> <a id="395" href="Ledger.Enact.html" class="Module">Ledger.Enact</a> <a id="408" href="Ledger.Transaction.html#3279" class="Function">govStructure</a>
<a id="421" class="Keyword">open</a> <a id="426" class="Keyword">import</a> <a id="433" href="Ledger.Ledger.html" class="Module">Ledger.Ledger</a> <a id="447" href="Ledger.Chain.html#272" class="Bound">txs</a> <a id="451" href="Ledger.Chain.html#316" class="Bound">abs</a>
<a id="455" class="Keyword">open</a> <a id="460" class="Keyword">import</a> <a id="467" href="Ledger.Ratify.html" class="Module">Ledger.Ratify</a> <a id="481" href="Ledger.Chain.html#272" class="Bound">txs</a>
<a id="485" class="Keyword">open</a> <a id="490" class="Keyword">import</a> <a id="497" href="Ledger.Utxo.html" class="Module">Ledger.Utxo</a> <a id="509" href="Ledger.Chain.html#272" class="Bound">txs</a> <a id="513" href="Ledger.Chain.html#316" class="Bound">abs</a>
<a id="517" class="Keyword">open</a> <a id="522" class="Keyword">import</a> <a id="529" href="Ledger.Epoch.html" class="Module">Ledger.Epoch</a> <a id="542" href="Ledger.Chain.html#272" class="Bound">txs</a> <a id="546" href="Ledger.Chain.html#316" class="Bound">abs</a>
<a id="550" class="Markup">\end{code}</a><a id="560" class="Background">
\begin{figure*}[h]
\begin{AgdaMultiCode}
</a><a id="602" class="Markup">\begin{code}</a>
<a id="615" class="Keyword">record</a> <a id="ChainState"></a><a id="622" href="Ledger.Chain.html#622" class="Record">ChainState</a> <a id="633" class="Symbol">:</a> <a id="635" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="640" class="Keyword">where</a>
<a id="646" class="Markup">\end{code}</a><a id="656" class="Background">
</a><a id="657" class="Markup">\begin{code}[hide]</a>
  <a id="678" class="Keyword">field</a>
<a id="684" class="Markup">\end{code}</a><a id="694" class="Background">
</a><a id="695" class="Markup">\begin{code}</a>
    <a id="ChainState.newEpochState"></a><a id="712" href="Ledger.Chain.html#712" class="Field">newEpochState</a>  <a id="727" class="Symbol">:</a> <a id="729" href="Ledger.Epoch.html#1698" class="Record">NewEpochState</a>

<a id="744" class="Keyword">record</a> <a id="Block"></a><a id="751" href="Ledger.Chain.html#751" class="Record">Block</a> <a id="757" class="Symbol">:</a> <a id="759" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="764" class="Keyword">where</a>
<a id="770" class="Markup">\end{code}</a><a id="780" class="Background">
</a><a id="781" class="Markup">\begin{code}[hide]</a>
  <a id="802" class="Keyword">field</a>
<a id="808" class="Markup">\end{code}</a><a id="818" class="Background">
</a><a id="819" class="Markup">\begin{code}</a>
    <a id="Block.ts"></a><a id="836" href="Ledger.Chain.html#836" class="Field">ts</a>    <a id="842" class="Symbol">:</a> <a id="844" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="849" href="Ledger.Transaction.html#5227" class="Record">Tx</a>
    <a id="Block.slot"></a><a id="856" href="Ledger.Chain.html#856" class="Field">slot</a>  <a id="862" class="Symbol">:</a> <a id="864" href="Ledger.Types.Epoch.html#382" class="Function">Slot</a>
<a id="869" class="Markup">\end{code}</a><a id="879" class="Background">
\end{AgdaMultiCode}
\caption{Definitions CHAIN transition system}
\end{figure*}
</a><a id="960" class="Markup">\begin{code}[hide]</a>
<a id="979" class="Keyword">private</a> <a id="987" class="Keyword">variable</a>
  <a id="998" href="Ledger.Chain.html#998" class="Generalizable">s</a> <a id="1000" class="Symbol">:</a> <a id="1002" href="Ledger.Chain.html#622" class="Record">ChainState</a>
  <a id="1015" href="Ledger.Chain.html#1015" class="Generalizable">b</a> <a id="1017" class="Symbol">:</a> <a id="1019" href="Ledger.Chain.html#751" class="Record">Block</a>
  <a id="1027" href="Ledger.Chain.html#1027" class="Generalizable">ls&#39;</a> <a id="1031" class="Symbol">:</a> <a id="1033" href="Ledger.Ledger.html#980" class="Record">LState</a>
  <a id="1042" href="Ledger.Chain.html#1042" class="Generalizable">nes</a> <a id="1046" class="Symbol">:</a> <a id="1048" href="Ledger.Epoch.html#1698" class="Record">NewEpochState</a>

<a id="1063" class="Keyword">instance</a> <a id="1072" href="Ledger.Chain.html#1072" class="Function">_</a> <a id="1074" class="Symbol">=</a> <a id="1076" href="Data.Nat.Properties.html#16493" class="Function">+-0-monoid</a>

<a id="1088" class="Comment">-- TODO: do we still need this for anything?</a>
<a id="maybePurpose"></a><a id="1133" href="Ledger.Chain.html#1133" class="Function">maybePurpose</a> <a id="1146" class="Symbol">:</a> <a id="1148" href="Ledger.Certs.html#349" class="Datatype">DepositPurpose</a> <a id="1163" class="Symbol">→</a> <a id="1165" class="Symbol">(</a><a id="1166" href="Ledger.Certs.html#349" class="Datatype">DepositPurpose</a> <a id="1181" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="1183" href="Ledger.Address.html#764" class="Datatype">Credential</a><a id="1193" class="Symbol">)</a> <a id="1195" class="Symbol">→</a> <a id="1197" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="1202" class="Symbol">→</a> <a id="1204" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="1210" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="1215" href="Ledger.Chain.html#1133" class="Function">maybePurpose</a> <a id="1228" href="Ledger.Chain.html#1228" class="Bound">prps</a> <a id="1233" class="Symbol">(</a><a id="1234" href="Ledger.Chain.html#1234" class="Bound">prps&#39;</a> <a id="1240" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1242" class="Symbol">_)</a> <a id="1245" href="Ledger.Chain.html#1245" class="Bound">c</a> <a id="1247" class="Keyword">with</a> <a id="1252" href="Ledger.Chain.html#1228" class="Bound">prps</a> <a id="1257" href="Class.DecEq.Core.html#159" class="Field Operator">≟</a> <a id="1259" href="Ledger.Chain.html#1234" class="Bound">prps&#39;</a>
<a id="1265" class="Symbol">...</a> <a id="1269" class="Symbol">|</a> <a id="1271" href="Relation.Nullary.Decidable.Core.html#1618" class="InductiveConstructor">yes</a> <a id="1275" class="Symbol">_</a> <a id="1277" class="Symbol">=</a> <a id="1279" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="1284" class="Bound">c</a>
<a id="1286" class="Symbol">...</a> <a id="1290" class="Symbol">|</a> <a id="1292" href="Relation.Nullary.Decidable.Core.html#1655" class="InductiveConstructor">no</a> <a id="1295" class="Symbol">_</a> <a id="1297" class="Symbol">=</a> <a id="1299" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a>

<a id="maybePurpose-prop"></a><a id="1308" href="Ledger.Chain.html#1308" class="Function">maybePurpose-prop</a> <a id="1326" class="Symbol">:</a> <a id="1328" class="Symbol">∀</a> <a id="1330" class="Symbol">{</a><a id="1331" href="Ledger.Chain.html#1331" class="Bound">prps</a><a id="1335" class="Symbol">}</a> <a id="1337" class="Symbol">{</a><a id="1338" href="Ledger.Chain.html#1338" class="Bound">x</a><a id="1339" class="Symbol">}</a> <a id="1341" class="Symbol">{</a><a id="1342" href="Ledger.Chain.html#1342" class="Bound">y</a><a id="1343" class="Symbol">}</a>
  <a id="1347" class="Symbol">→</a> <a id="1349" class="Symbol">(</a><a id="1350" href="Ledger.Chain.html#1350" class="Bound">m</a> <a id="1352" class="Symbol">:</a> <a id="1354" class="Symbol">(</a><a id="1355" href="Ledger.Certs.html#349" class="Datatype">DepositPurpose</a> <a id="1370" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="1372" href="Ledger.Address.html#764" class="Datatype">Credential</a><a id="1382" class="Symbol">)</a> <a id="1384" href="Ledger.Set.Theory.html#1515" class="Function Operator">⇀</a> <a id="1386" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a><a id="1390" class="Symbol">)</a>
  <a id="1394" class="Symbol">→</a> <a id="1396" class="Symbol">(</a><a id="1397" href="Ledger.Chain.html#1338" class="Bound">x</a> <a id="1399" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1401" href="Ledger.Chain.html#1342" class="Bound">y</a><a id="1402" class="Symbol">)</a> <a id="1404" href="Interface.IsSet.html#476" class="Function Operator">∈</a> <a id="1406" href="Interface.IsSet.html#934" class="Function">dom</a> <a id="1410" class="Symbol">((</a><a id="1412" href="Axiom.Set.Map.html#9742" class="Function">mapMaybeWithKeyᵐ</a> <a id="1429" class="Symbol">(</a><a id="1430" href="Ledger.Chain.html#1133" class="Function">maybePurpose</a> <a id="1443" href="Ledger.Chain.html#1331" class="Bound">prps</a><a id="1447" class="Symbol">)</a> <a id="1449" href="Ledger.Chain.html#1350" class="Bound">m</a><a id="1450" class="Symbol">)</a> <a id="1452" href="Axiom.Set.Map.html#2282" class="Function Operator">ˢ</a><a id="1453" class="Symbol">)</a>
  <a id="1457" class="Symbol">→</a> <a id="1459" href="Ledger.Chain.html#1338" class="Bound">x</a> <a id="1461" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="1463" href="Ledger.Chain.html#1331" class="Bound">prps</a>
<a id="1468" href="Ledger.Chain.html#1308" class="Function">maybePurpose-prop</a> <a id="1486" class="Symbol">{</a><a id="1487" class="Argument">prps</a> <a id="1492" class="Symbol">=</a> <a id="1494" href="Ledger.Chain.html#1494" class="Bound">prps</a><a id="1498" class="Symbol">}</a> <a id="1500" class="Symbol">{</a><a id="1501" href="Ledger.Chain.html#1501" class="Bound">x</a><a id="1502" class="Symbol">}</a> <a id="1504" class="Symbol">{</a><a id="1505" href="Ledger.Chain.html#1505" class="Bound">y</a><a id="1506" class="Symbol">}</a> <a id="1508" class="Symbol">_</a> <a id="1510" href="Ledger.Chain.html#1510" class="Bound">xy∈dom</a> <a id="1517" class="Keyword">with</a> <a id="1522" href="Function.Bundles.html#4834" class="Field">from</a> <a id="1527" href="Axiom.Set.Rel.html#2622" class="Function">dom∈</a> <a id="1532" href="Ledger.Chain.html#1510" class="Bound">xy∈dom</a>
<a id="1539" class="Symbol">...</a> <a id="1543" class="Symbol">|</a> <a id="1545" href="Ledger.Chain.html#1545" class="Bound">z</a> <a id="1547" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="1549" href="Ledger.Chain.html#1549" class="Bound">∈mmwk</a> <a id="1555" class="Keyword">with</a> <a id="1560" class="Bound">prps</a> <a id="1565" href="Class.DecEq.Core.html#159" class="Field Operator">≟</a> <a id="1567" class="Bound">x</a> <a id="1569" class="Symbol">|</a> <a id="1571" href="Axiom.Set.Rel.html#5711" class="Function">∈-mapMaybeWithKey</a> <a id="1589" class="Symbol">{</a><a id="1590" class="Argument">f</a> <a id="1592" class="Symbol">=</a> <a id="1594" href="Ledger.Chain.html#1133" class="Function">maybePurpose</a> <a id="1607" class="Bound">prps</a><a id="1611" class="Symbol">}</a> <a id="1613" href="Ledger.Chain.html#1549" class="Bound">∈mmwk</a>
<a id="1619" class="Symbol">...</a> <a id="1623" class="Symbol">|</a> <a id="1625" href="Relation.Nullary.Decidable.Core.html#1618" class="InductiveConstructor">yes</a> <a id="1629" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a> <a id="1634" class="Symbol">|</a> <a id="1636" class="Symbol">_</a> <a id="1638" class="Symbol">=</a> <a id="1640" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a>

<a id="filterPurpose"></a><a id="1646" href="Ledger.Chain.html#1646" class="Function">filterPurpose</a> <a id="1660" class="Symbol">:</a> <a id="1662" href="Ledger.Certs.html#349" class="Datatype">DepositPurpose</a> <a id="1677" class="Symbol">→</a> <a id="1679" class="Symbol">(</a><a id="1680" href="Ledger.Certs.html#349" class="Datatype">DepositPurpose</a> <a id="1695" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="1697" href="Ledger.Address.html#764" class="Datatype">Credential</a><a id="1707" class="Symbol">)</a> <a id="1709" href="Ledger.Set.Theory.html#1515" class="Function Operator">⇀</a> <a id="1711" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a> <a id="1716" class="Symbol">→</a> <a id="1718" href="Ledger.Address.html#764" class="Datatype">Credential</a> <a id="1729" href="Ledger.Set.Theory.html#1515" class="Function Operator">⇀</a> <a id="1731" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="1736" href="Ledger.Chain.html#1646" class="Function">filterPurpose</a> <a id="1750" href="Ledger.Chain.html#1750" class="Bound">prps</a> <a id="1755" href="Ledger.Chain.html#1755" class="Bound">m</a> <a id="1757" class="Symbol">=</a> <a id="1759" href="Axiom.Set.Map.html#5966" class="Function">mapKeys</a> <a id="1767" href="Data.Product.Base.html#650" class="Field">proj₂</a> <a id="1773" class="Symbol">(</a><a id="1774" href="Axiom.Set.Map.html#9742" class="Function">mapMaybeWithKeyᵐ</a> <a id="1791" class="Symbol">(</a><a id="1792" href="Ledger.Chain.html#1133" class="Function">maybePurpose</a> <a id="1805" href="Ledger.Chain.html#1750" class="Bound">prps</a><a id="1809" class="Symbol">)</a> <a id="1811" href="Ledger.Chain.html#1755" class="Bound">m</a><a id="1812" class="Symbol">)</a>
  <a id="1816" class="Symbol">{λ</a> <a id="1819" class="Keyword">where</a> <a id="1825" href="Ledger.Chain.html#1825" class="Bound">x∈dom</a> <a id="1831" href="Ledger.Chain.html#1831" class="Bound">y∈dom</a> <a id="1837" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a> <a id="1842" class="Symbol">→</a> <a id="1844" href="Relation.Binary.PropositionalEquality.Core.html#1158" class="Function">cong</a> <a id="1849" class="Symbol">(</a><a id="1850" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">_,</a> <a id="1853" class="Symbol">_)</a>
                            <a id="1884" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="1886" href="Relation.Binary.PropositionalEquality.Core.html#1757" class="Function">trans</a> <a id="1892" class="Symbol">(</a><a id="1893" href="Ledger.Chain.html#1308" class="Function">maybePurpose-prop</a> <a id="1911" class="Symbol">{</a><a id="1912" class="Argument">prps</a> <a id="1917" class="Symbol">=</a> <a id="1919" href="Ledger.Chain.html#1750" class="Bound">prps</a><a id="1923" class="Symbol">}</a> <a id="1925" href="Ledger.Chain.html#1755" class="Bound">m</a> <a id="1927" href="Ledger.Chain.html#1825" class="Bound">x∈dom</a><a id="1932" class="Symbol">)</a>
                            <a id="1962" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="1964" href="Relation.Binary.PropositionalEquality.Core.html#1712" class="Function">sym</a>   <a id="1970" class="Symbol">(</a><a id="1971" href="Ledger.Chain.html#1308" class="Function">maybePurpose-prop</a> <a id="1989" class="Symbol">{</a><a id="1990" class="Argument">prps</a> <a id="1995" class="Symbol">=</a> <a id="1997" href="Ledger.Chain.html#1750" class="Bound">prps</a><a id="2001" class="Symbol">}</a> <a id="2003" href="Ledger.Chain.html#1755" class="Bound">m</a> <a id="2005" href="Ledger.Chain.html#1831" class="Bound">y∈dom</a><a id="2010" class="Symbol">)}</a>

<a id="govActionDeposits"></a><a id="2014" href="Ledger.Chain.html#2014" class="Function">govActionDeposits</a> <a id="2032" class="Symbol">:</a> <a id="2034" href="Ledger.Ledger.html#980" class="Record">LState</a> <a id="2041" class="Symbol">→</a> <a id="2043" href="Ledger.GovernanceActions.html#1215" class="Datatype">VDeleg</a> <a id="2050" href="Ledger.Set.Theory.html#1515" class="Function Operator">⇀</a> <a id="2052" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="2057" href="Ledger.Chain.html#2014" class="Function">govActionDeposits</a> <a id="2075" href="Ledger.Chain.html#2075" class="Bound">ls</a> <a id="2078" class="Symbol">=</a>
  <a id="2082" class="Keyword">let</a> <a id="2086" class="Keyword">open</a> <a id="2091" href="Ledger.Ledger.html#980" class="Module">LState</a> <a id="2098" href="Ledger.Chain.html#2075" class="Bound">ls</a><a id="2100" class="Symbol">;</a> <a id="2102" class="Keyword">open</a> <a id="2107" href="Ledger.Certs.html#2829" class="Module">CertState</a> <a id="2117" href="Ledger.Ledger.html#1142" class="Field">certState</a><a id="2126" class="Symbol">;</a> <a id="2128" class="Keyword">open</a> <a id="2133" href="Ledger.Certs.html#2416" class="Module">PState</a> <a id="2140" href="Ledger.Certs.html#2962" class="Function">pState</a>
      <a id="2153" class="Keyword">open</a> <a id="2158" href="Ledger.Utxo.html#5208" class="Module">UTxOState</a> <a id="2168" href="Ledger.Ledger.html#1089" class="Field">utxoSt</a><a id="2174" class="Symbol">;</a> <a id="2176" class="Keyword">open</a> <a id="2181" href="Ledger.Certs.html#2146" class="Module">DState</a> <a id="2188" href="Ledger.Certs.html#2942" class="Function">dState</a>
   <a id="2198" class="Keyword">in</a> <a id="2201" href="Data.List.Base.html#4437" class="Function">foldl</a> <a id="2207" href="Axiom.Set.Map.Dec.html#1956" class="Function Operator">_∪⁺_</a> <a id="2212" href="Interface.HasEmptySet.html#150" class="Field">∅</a> <a id="2214" href="Function.Base.html#1974" class="Function Operator">$</a> <a id="2216" href="Ledger.Set.Theory.html#1217" class="Function">setToList</a> <a id="2226" href="Function.Base.html#1974" class="Function Operator">$</a>
    <a id="2232" href="Axiom.Set.html#7518" class="Function">mapPartial</a>
      <a id="2249" class="Symbol">(λ</a> <a id="2252" class="Keyword">where</a> <a id="2258" class="Symbol">(</a><a id="2259" href="Ledger.Chain.html#2259" class="Bound">gaid</a> <a id="2264" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="2266" class="Keyword">record</a> <a id="2273" class="Symbol">{</a> <a id="2275" href="Ledger.GovernanceActions.html#8879" class="Field">returnAddr</a> <a id="2286" class="Symbol">=</a> <a id="2288" class="Keyword">record</a> <a id="2295" class="Symbol">{</a><a id="2296" href="Ledger.Address.html#1637" class="Field">stake</a> <a id="2302" class="Symbol">=</a> <a id="2304" href="Ledger.Chain.html#2304" class="Bound">c</a><a id="2305" class="Symbol">}</a> <a id="2307" class="Symbol">})</a> <a id="2310" class="Symbol">→</a> <a id="2312" class="Keyword">do</a>
        <a id="2323" href="Ledger.Chain.html#2323" class="Bound">vd</a> <a id="2326" href="Class.Monad.Core.html#290" class="Field Operator">←</a> <a id="2328" href="Axiom.Set.Map.html#12605" class="Function">lookupᵐ?</a> <a id="2337" href="Ledger.Certs.html#2255" class="Function">voteDelegs</a> <a id="2348" href="Ledger.Chain.html#2304" class="Bound">c</a>
        <a id="2358" href="Ledger.Chain.html#2358" class="Bound">dep</a> <a id="2362" href="Class.Monad.Core.html#290" class="Field Operator">←</a> <a id="2364" href="Axiom.Set.Map.html#12605" class="Function">lookupᵐ?</a> <a id="2373" href="Ledger.Utxo.html#5366" class="Function">deposits</a> <a id="2382" class="Symbol">(</a><a id="2383" href="Ledger.Certs.html#538" class="InductiveConstructor">GovActionDeposit</a> <a id="2400" href="Ledger.Chain.html#2259" class="Bound">gaid</a><a id="2404" class="Symbol">)</a>
        <a id="2414" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="2419" href="Interface.HasSingleton.html#348" class="Field Operator">❴</a> <a id="2421" href="Ledger.Chain.html#2323" class="Bound">vd</a> <a id="2424" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="2426" href="Ledger.Chain.html#2358" class="Bound">dep</a> <a id="2430" href="Interface.HasSingleton.html#348" class="Field Operator">❵</a> <a id="2432" class="Symbol">)</a>
      <a id="2440" class="Symbol">(</a><a id="2441" href="Axiom.Set.html#5431" class="Function">fromList</a> <a id="2450" href="Ledger.Ledger.html#1116" class="Field">govSt</a><a id="2455" class="Symbol">)</a>

<a id="calculateStakeDistrs"></a><a id="2458" href="Ledger.Chain.html#2458" class="Function">calculateStakeDistrs</a> <a id="2479" class="Symbol">:</a> <a id="2481" href="Ledger.Ledger.html#980" class="Record">LState</a> <a id="2488" class="Symbol">→</a> <a id="2490" href="Ledger.Ratify.html#7183" class="Record">StakeDistrs</a>
<a id="2502" href="Ledger.Chain.html#2458" class="Function">calculateStakeDistrs</a> <a id="2523" href="Ledger.Chain.html#2523" class="Bound">ls</a> <a id="2526" class="Symbol">=</a>
  <a id="2530" class="Keyword">let</a> <a id="2534" class="Keyword">open</a> <a id="2539" href="Ledger.Ledger.html#980" class="Module">LState</a> <a id="2546" href="Ledger.Chain.html#2523" class="Bound">ls</a><a id="2548" class="Symbol">;</a> <a id="2550" class="Keyword">open</a> <a id="2555" href="Ledger.Certs.html#2829" class="Module">CertState</a> <a id="2565" href="Ledger.Ledger.html#1142" class="Field">certState</a><a id="2574" class="Symbol">;</a> <a id="2576" class="Keyword">open</a> <a id="2581" href="Ledger.Certs.html#2416" class="Module">PState</a> <a id="2588" href="Ledger.Certs.html#2962" class="Function">pState</a>
      <a id="2601" class="Keyword">open</a> <a id="2606" href="Ledger.Utxo.html#5208" class="Module">UTxOState</a> <a id="2616" href="Ledger.Ledger.html#1089" class="Field">utxoSt</a><a id="2622" class="Symbol">;</a> <a id="2624" class="Keyword">open</a> <a id="2629" href="Ledger.Certs.html#2146" class="Module">DState</a> <a id="2636" href="Ledger.Certs.html#2942" class="Function">dState</a>
      <a id="2649" href="Ledger.Chain.html#2649" class="Bound">spoDelegs</a> <a id="2659" class="Symbol">=</a> <a id="2661" href="Interface.HasEmptySet.html#150" class="Field">∅</a> <a id="2663" class="Comment">-- TODO</a>
      <a id="2677" href="Ledger.Chain.html#2677" class="Bound">drepDelegs</a> <a id="2688" class="Symbol">=</a> <a id="2690" href="Interface.HasEmptySet.html#150" class="Field">∅</a> <a id="2692" class="Comment">-- TODO</a>
  <a id="2702" class="Keyword">in</a>
  <a id="2707" class="Keyword">record</a>
    <a id="2718" class="Symbol">{</a> <a id="2720" href="Ledger.Ratify.html#7274" class="Field">stakeDistr</a> <a id="2731" class="Symbol">=</a> <a id="2733" href="Ledger.Chain.html#2014" class="Function">govActionDeposits</a> <a id="2751" href="Ledger.Chain.html#2523" class="Bound">ls</a>
    <a id="2758" class="Symbol">}</a>


<a id="2762" class="Keyword">data</a>
<a id="2767" class="Markup">\end{code}</a><a id="2777" class="Background">
\begin{figure*}[h]
\begin{AgdaSuppressSpace}
</a><a id="2823" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,CHAIN⦈_"></a><a id="2838" href="Ledger.Chain.html#2838" class="Datatype Operator">_⊢_⇀⦇_,CHAIN⦈_</a> <a id="2853" class="Symbol">:</a> <a id="2855" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a> <a id="2857" class="Symbol">→</a> <a id="2859" href="Ledger.Chain.html#622" class="Record">ChainState</a> <a id="2870" class="Symbol">→</a> <a id="2872" href="Ledger.Chain.html#751" class="Record">Block</a> <a id="2878" class="Symbol">→</a> <a id="2880" href="Ledger.Chain.html#622" class="Record">ChainState</a> <a id="2891" class="Symbol">→</a> <a id="2893" href="Agda.Primitive.html#388" class="Primitive">Type</a>
<a id="2898" class="Markup">\end{code}</a><a id="2908" class="Background">
\end{AgdaSuppressSpace}
\caption{Type of the CHAIN transition system}
\end{figure*}
</a><a id="2993" class="Markup">\begin{code}[hide]</a>
  <a id="3014" class="Keyword">where</a>
<a id="3020" class="Markup">\end{code}</a><a id="3030" class="Background">
\begin{figure*}[h]
\begin{AgdaSuppressSpace}
</a><a id="3076" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,CHAIN⦈_.CHAIN"></a><a id="3091" href="Ledger.Chain.html#3091" class="InductiveConstructor">CHAIN</a> <a id="3097" class="Symbol">:</a>
    <a id="3103" class="Keyword">let</a> <a id="3107" class="Keyword">open</a> <a id="3112" href="Ledger.Chain.html#622" class="Module">ChainState</a> <a id="3123" href="Ledger.Chain.html#998" class="Generalizable">s</a><a id="3124" class="Symbol">;</a> <a id="3126" class="Keyword">open</a> <a id="3131" href="Ledger.Chain.html#751" class="Module">Block</a> <a id="3137" href="Ledger.Chain.html#1015" class="Generalizable">b</a><a id="3138" class="Symbol">;</a> <a id="3140" class="Keyword">open</a> <a id="3145" href="Ledger.Epoch.html#1698" class="Module">NewEpochState</a> <a id="3159" href="Ledger.Chain.html#1042" class="Generalizable">nes</a>
        <a id="3171" class="Keyword">open</a> <a id="3176" href="Ledger.Epoch.html#1405" class="Module">EpochState</a> <a id="3187" href="Ledger.Epoch.html#1839" class="Function">epochState</a><a id="3197" class="Symbol">;</a> <a id="3199" class="Keyword">open</a> <a id="3204" href="Ledger.Enact.html#1446" class="Module">EnactState</a> <a id="3215" href="Ledger.Epoch.html#1596" class="Function">es</a>
    <a id="3222" class="Keyword">in</a>
       <a id="3232" class="Symbol">_</a> <a id="3234" href="Ledger.Epoch.html#7862" class="Datatype Operator">⊢</a> <a id="3236" href="Ledger.Chain.html#712" class="Function">newEpochState</a> <a id="3250" href="Ledger.Epoch.html#7862" class="Datatype Operator">⇀⦇</a> <a id="3253" href="Ledger.Types.Epoch.html#518" class="Function">epoch</a> <a id="3259" href="Ledger.Chain.html#856" class="Function">slot</a> <a id="3264" href="Ledger.Epoch.html#7862" class="Datatype Operator">,NEWEPOCH⦈</a> <a id="3275" href="Ledger.Chain.html#1042" class="Generalizable">nes</a>
    <a id="3283" class="Symbol">→</a>  <a id="3286" href="Ledger.Ledger.html#790" class="InductiveConstructor Operator">⟦</a> <a id="3288" href="Ledger.Chain.html#856" class="Function">slot</a> <a id="3293" href="Ledger.Ledger.html#790" class="InductiveConstructor Operator">,</a> <a id="3295" href="Ledger.Enact.html#1605" class="Function">constitution</a> <a id="3308" class="Symbol">.</a><a id="3309" href="Data.Product.Base.html#636" class="Field">proj₁</a> <a id="3315" class="Symbol">.</a><a id="3316" href="Data.Product.Base.html#650" class="Field">proj₂</a> <a id="3322" href="Ledger.Ledger.html#790" class="InductiveConstructor Operator">,</a> <a id="3324" href="Ledger.Enact.html#1710" class="Function">pparams</a> <a id="3332" class="Symbol">.</a><a id="3333" href="Data.Product.Base.html#636" class="Field">proj₁</a> <a id="3339" href="Ledger.Ledger.html#790" class="InductiveConstructor Operator">,</a> <a id="3341" href="Ledger.Epoch.html#1596" class="Function">es</a> <a id="3344" href="Ledger.Ledger.html#790" class="InductiveConstructor Operator">,</a> <a id="3346" href="Ledger.PParams.html#1266" class="Field">Acnt.treasury</a> <a id="3360" href="Ledger.Epoch.html#1523" class="Function">acnt</a>
       <a id="3372" href="Ledger.Ledger.html#790" class="InductiveConstructor Operator">⟧ˡᵉ</a> <a id="3376" href="Ledger.Ledger.html#2897" class="Function Operator">⊢</a> <a id="3378" href="Ledger.Epoch.html#1572" class="Function">ls</a> <a id="3381" href="Ledger.Ledger.html#2897" class="Function Operator">⇀⦇</a> <a id="3384" href="Ledger.Chain.html#836" class="Function">ts</a> <a id="3387" href="Ledger.Ledger.html#2897" class="Function Operator">,LEDGERS⦈</a> <a id="3397" href="Ledger.Chain.html#1027" class="Generalizable">ls&#39;</a>
    <a id="3405" href="Interface.STS.html#350" class="Function Operator">────────────────────────────────</a>
    <a id="3442" class="Symbol">_</a> <a id="3444" href="Ledger.Chain.html#2838" class="Datatype Operator">⊢</a> <a id="3446" href="Ledger.Chain.html#998" class="Generalizable">s</a> <a id="3448" href="Ledger.Chain.html#2838" class="Datatype Operator">⇀⦇</a> <a id="3451" href="Ledger.Chain.html#1015" class="Generalizable">b</a> <a id="3453" href="Ledger.Chain.html#2838" class="Datatype Operator">,CHAIN⦈</a>
        <a id="3469" class="Keyword">record</a> <a id="3476" href="Ledger.Chain.html#998" class="Generalizable">s</a> <a id="3478" class="Symbol">{</a> <a id="3480" href="Ledger.Chain.html#712" class="Field">newEpochState</a> <a id="3494" class="Symbol">=</a> <a id="3496" class="Keyword">record</a> <a id="3503" href="Ledger.Chain.html#1042" class="Generalizable">nes</a> <a id="3507" class="Symbol">{</a> <a id="3509" href="Ledger.Epoch.html#1839" class="Field">epochState</a> <a id="3520" class="Symbol">=</a> <a id="3522" class="Keyword">record</a> <a id="3529" href="Ledger.Epoch.html#1839" class="Function">epochState</a> <a id="3540" class="Symbol">{</a> <a id="3542" href="Ledger.Epoch.html#1572" class="Field">ls</a> <a id="3545" class="Symbol">=</a> <a id="3547" href="Ledger.Chain.html#1027" class="Generalizable">ls&#39;</a><a id="3550" class="Symbol">}</a> <a id="3552" class="Symbol">}</a> <a id="3554" class="Symbol">}</a>
<a id="3556" class="Markup">\end{code}</a><a id="3566" class="Background">
\end{AgdaSuppressSpace}
\caption{CHAIN transition system}
\end{figure*}
</a></pre></body></html>