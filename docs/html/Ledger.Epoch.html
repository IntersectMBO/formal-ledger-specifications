<!DOCTYPE HTML>
<html><head><meta charset="utf-8"><title>Ledger.Epoch</title><link rel="stylesheet" href="Agda.css"></head><body><pre class="Agda"><a id="1" class="Background">\section{Epoch Boundary}

</a><a id="27" class="Markup">\begin{code}[hide]</a>
<a id="46" class="Symbol">{-#</a> <a id="50" class="Keyword">OPTIONS</a> <a id="58" class="Pragma">--safe</a> <a id="65" class="Symbol">#-}</a>

<a id="70" class="Keyword">open</a> <a id="75" class="Keyword">import</a> <a id="82" href="Data.Nat.Properties.html" class="Module">Data.Nat.Properties</a> <a id="102" class="Keyword">using</a> <a id="108" class="Symbol">(</a><a id="109" href="Data.Nat.Properties.html#16493" class="Function">+-0-monoid</a><a id="119" class="Symbol">;</a> <a id="121" href="Data.Nat.Properties.html#16572" class="Function">+-0-commutativeMonoid</a><a id="142" class="Symbol">)</a>
<a id="144" class="Keyword">open</a> <a id="149" class="Keyword">import</a> <a id="156" href="Data.List.html" class="Module">Data.List</a> <a id="166" class="Keyword">using</a> <a id="172" class="Symbol">(</a><a id="173" href="Data.List.Base.html#10878" class="Function">filter</a><a id="179" class="Symbol">)</a>
<a id="181" class="Keyword">import</a> <a id="188" href="Data.Integer.html" class="Module">Data.Integer</a> <a id="201" class="Symbol">as</a> <a id="204" class="Module">ℤ</a>
<a id="206" class="Keyword">open</a> <a id="211" class="Keyword">import</a> <a id="218" href="Data.Integer.Ext.html" class="Module">Data.Integer.Ext</a>

<a id="236" class="Keyword">open</a> <a id="241" class="Keyword">import</a> <a id="248" href="Agda.Builtin.FromNat.html" class="Module">Agda.Builtin.FromNat</a>

<a id="270" class="Keyword">open</a> <a id="275" class="Keyword">import</a> <a id="282" href="Ledger.Prelude.html" class="Module">Ledger.Prelude</a>
<a id="297" class="Keyword">open</a> <a id="302" class="Keyword">import</a> <a id="309" href="Ledger.Abstract.html" class="Module">Ledger.Abstract</a>
<a id="325" class="Keyword">open</a> <a id="330" class="Keyword">import</a> <a id="337" href="Ledger.Transaction.html" class="Module">Ledger.Transaction</a>

<a id="357" class="Keyword">module</a> <a id="364" href="Ledger.Epoch.html" class="Module">Ledger.Epoch</a>
  <a id="379" class="Symbol">(</a><a id="380" href="Ledger.Epoch.html#380" class="Bound">txs</a> <a id="384" class="Symbol">:</a> <a id="386" class="Symbol">_)</a> <a id="389" class="Symbol">(</a><a id="390" class="Keyword">open</a> <a id="395" href="Ledger.Transaction.html#933" class="Module">TransactionStructure</a> <a id="416" href="Ledger.Epoch.html#380" class="Bound">txs</a><a id="419" class="Symbol">)</a>
  <a id="423" class="Symbol">(</a><a id="424" href="Ledger.Epoch.html#424" class="Bound">abs</a> <a id="428" class="Symbol">:</a> <a id="430" href="Ledger.Abstract.html#540" class="Record">AbstractFunctions</a> <a id="448" href="Ledger.Epoch.html#380" class="Bound">txs</a><a id="451" class="Symbol">)</a> <a id="453" class="Symbol">(</a><a id="454" class="Keyword">open</a> <a id="459" href="Ledger.Abstract.html#540" class="Module">AbstractFunctions</a> <a id="477" href="Ledger.Epoch.html#424" class="Bound">abs</a><a id="480" class="Symbol">)</a>
  <a id="484" class="Keyword">where</a>

<a id="491" class="Keyword">open</a> <a id="496" class="Keyword">import</a> <a id="503" href="Ledger.Gov.html" class="Module">Ledger.Gov</a> <a id="514" href="Ledger.Epoch.html#380" class="Bound">txs</a>
<a id="518" class="Keyword">open</a> <a id="523" class="Keyword">import</a> <a id="530" href="Ledger.Enact.html" class="Module">Ledger.Enact</a> <a id="543" href="Ledger.Transaction.html#3310" class="Function">govStructure</a>
<a id="556" class="Keyword">open</a> <a id="561" class="Keyword">import</a> <a id="568" href="Ledger.Ledger.html" class="Module">Ledger.Ledger</a> <a id="582" href="Ledger.Epoch.html#380" class="Bound">txs</a> <a id="586" href="Ledger.Epoch.html#424" class="Bound">abs</a>
<a id="590" class="Keyword">open</a> <a id="595" class="Keyword">import</a> <a id="602" href="Ledger.Ratify.html" class="Module">Ledger.Ratify</a> <a id="616" href="Ledger.Epoch.html#380" class="Bound">txs</a>
<a id="620" class="Keyword">open</a> <a id="625" class="Keyword">import</a> <a id="632" href="Ledger.Utxo.html" class="Module">Ledger.Utxo</a> <a id="644" href="Ledger.Epoch.html#380" class="Bound">txs</a> <a id="648" href="Ledger.Epoch.html#424" class="Bound">abs</a>
<a id="652" class="Markup">\end{code}</a><a id="662" class="Background">
\begin{NoConway}
\begin{figure*}[h]
</a><a id="699" class="Markup">\begin{code}</a>
<a id="712" class="Keyword">record</a> <a id="RewardUpdate"></a><a id="719" href="Ledger.Epoch.html#719" class="Record">RewardUpdate</a> <a id="732" class="Symbol">:</a> <a id="734" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="738" class="Keyword">where</a>
  <a id="746" class="Keyword">constructor</a> <a id="⟦_,_,_,_⟧ʳᵘ"></a><a id="758" href="Ledger.Epoch.html#758" class="InductiveConstructor Operator">⟦_,_,_,_⟧ʳᵘ</a>
  <a id="772" class="Keyword">field</a>
    <a id="RewardUpdate.Δt"></a><a id="782" href="Ledger.Epoch.html#782" class="Field">Δt</a> <a id="RewardUpdate.Δr"></a><a id="785" href="Ledger.Epoch.html#785" class="Field">Δr</a> <a id="RewardUpdate.Δf"></a><a id="788" href="Ledger.Epoch.html#788" class="Field">Δf</a> <a id="791" class="Symbol">:</a> <a id="793" href="Agda.Builtin.Int.html#245" class="Datatype">ℤ</a>
    <a id="RewardUpdate.rs"></a><a id="799" href="Ledger.Epoch.html#799" class="Field">rs</a> <a id="802" class="Symbol">:</a> <a id="804" href="Ledger.Address.html#764" class="Datatype">Credential</a> <a id="815" href="Ledger.Set.Theory.html#1515" class="Function Operator">⇀</a> <a id="817" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="822" class="Markup">\end{code}</a><a id="832" class="Background">
</a><a id="833" class="Markup">\begin{code}[hide]</a>
    <a id="856" class="Comment">-- more convient here than doing checks</a>
    <a id="900" class="Symbol">{</a><a id="RewardUpdate.zeroSum"></a><a id="901" href="Ledger.Epoch.html#901" class="Field">zeroSum</a><a id="908" class="Symbol">}</a> <a id="910" class="Symbol">:</a> <a id="912" href="Ledger.Epoch.html#782" class="Field">Δt</a> <a id="915" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="917" href="Ledger.Epoch.html#785" class="Field">Δr</a> <a id="920" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="922" href="Ledger.Epoch.html#788" class="Field">Δf</a> <a id="925" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="927" href="Agda.Builtin.Int.html#263" class="InductiveConstructor Operator">ℤ.+</a> <a id="931" href="Ledger.Set.Theory.html#3127" class="Function">∑[</a> <a id="934" href="Ledger.Epoch.html#934" class="Bound">x</a> <a id="936" href="Ledger.Set.Theory.html#3127" class="Function">←</a> <a id="938" href="Ledger.Epoch.html#799" class="Field">rs</a> <a id="941" href="Ledger.Set.Theory.html#3127" class="Function">]</a> <a id="943" href="Ledger.Epoch.html#934" class="Bound">x</a> <a id="945" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="947" href="Data.Integer.Base.html#1545" class="Function">ℤ.0ℤ</a>
<a id="952" class="Markup">\end{code}</a><a id="962" class="Background">
\end{figure*}
\end{NoConway}

\begin{figure*}[h]
\begin{AgdaMultiCode}
\begin{NoConway}
</a><a id="1051" class="Markup">\begin{code}</a>
<a id="1064" class="Keyword">record</a> <a id="Snapshot"></a><a id="1071" href="Ledger.Epoch.html#1071" class="Record">Snapshot</a> <a id="1080" class="Symbol">:</a> <a id="1082" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="1086" class="Keyword">where</a>
  <a id="1094" class="Keyword">constructor</a> <a id="⟦_,_⟧ˢ"></a><a id="1106" href="Ledger.Epoch.html#1106" class="InductiveConstructor Operator">⟦_,_⟧ˢ</a>
  <a id="1115" class="Keyword">field</a>
    <a id="Snapshot.stake"></a><a id="1125" href="Ledger.Epoch.html#1125" class="Field">stake</a>        <a id="1138" class="Symbol">:</a> <a id="1140" href="Ledger.Address.html#764" class="Datatype">Credential</a> <a id="1151" href="Ledger.Set.Theory.html#1515" class="Function Operator">⇀</a> <a id="1153" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
    <a id="Snapshot.delegations"></a><a id="1162" href="Ledger.Epoch.html#1162" class="Field">delegations</a>  <a id="1175" class="Symbol">:</a> <a id="1177" href="Ledger.Address.html#764" class="Datatype">Credential</a> <a id="1188" href="Ledger.Set.Theory.html#1515" class="Function Operator">⇀</a> <a id="1190" href="Ledger.Crypto.html#1629" class="Function">KeyHash</a>
    <a id="1202" class="Comment">-- poolParameters : KeyHash ⇀ PoolParam</a>

<a id="1243" class="Keyword">record</a> <a id="Snapshots"></a><a id="1250" href="Ledger.Epoch.html#1250" class="Record">Snapshots</a> <a id="1260" class="Symbol">:</a> <a id="1262" href="Agda.Primitive.html#388" class="Primitive">Set</a> <a id="1266" class="Keyword">where</a>
  <a id="1274" class="Keyword">constructor</a> <a id="⟦_,_,_,_⟧ˢˢ"></a><a id="1286" href="Ledger.Epoch.html#1286" class="InductiveConstructor Operator">⟦_,_,_,_⟧ˢˢ</a>
  <a id="1300" class="Keyword">field</a>
    <a id="Snapshots.mark"></a><a id="1310" href="Ledger.Epoch.html#1310" class="Field">mark</a> <a id="Snapshots.set"></a><a id="1315" href="Ledger.Epoch.html#1315" class="Field">set</a> <a id="Snapshots.go"></a><a id="1319" href="Ledger.Epoch.html#1319" class="Field">go</a>  <a id="1323" class="Symbol">:</a> <a id="1325" href="Ledger.Epoch.html#1071" class="Record">Snapshot</a>
    <a id="Snapshots.feeSS"></a><a id="1338" href="Ledger.Epoch.html#1338" class="Field">feeSS</a>        <a id="1351" class="Symbol">:</a> <a id="1353" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>

<a id="1359" class="Markup">\end{code}</a><a id="1369" class="Background">
\end{NoConway}
</a><a id="1385" class="Markup">\begin{code}</a>
<a id="1398" class="Keyword">record</a> <a id="EpochState"></a><a id="1405" href="Ledger.Epoch.html#1405" class="Record">EpochState</a> <a id="1416" class="Symbol">:</a> <a id="1418" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="1423" class="Keyword">where</a>
<a id="1429" class="Markup">\end{code}</a><a id="1439" class="Background">
</a><a id="1440" class="Markup">\begin{code}[hide]</a>
  <a id="1461" class="Keyword">constructor</a> <a id="⟦_,_,_,_,_⟧ᵉ&#39;"></a><a id="1473" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">⟦_,_,_,_,_⟧ᵉ&#39;</a>
  <a id="1489" class="Keyword">field</a>
<a id="1495" class="Markup">\end{code}</a><a id="1505" class="Background">
</a><a id="1506" class="Markup">\begin{code}</a>
    <a id="EpochState.acnt"></a><a id="1523" href="Ledger.Epoch.html#1523" class="Field">acnt</a>       <a id="1534" class="Symbol">:</a> <a id="1536" href="Ledger.PParams.html#1161" class="Record">Acnt</a>
    <a id="EpochState.ss"></a><a id="1545" href="Ledger.Epoch.html#1545" class="Field">ss</a>         <a id="1556" class="Symbol">:</a> <a id="1558" href="Ledger.Epoch.html#1250" class="Record">Snapshots</a>
    <a id="EpochState.ls"></a><a id="1572" href="Ledger.Epoch.html#1572" class="Field">ls</a>         <a id="1583" class="Symbol">:</a> <a id="1585" href="Ledger.Ledger.html#980" class="Record">LState</a>
    <a id="EpochState.es"></a><a id="1596" href="Ledger.Epoch.html#1596" class="Field">es</a>         <a id="1607" class="Symbol">:</a> <a id="1609" href="Ledger.Enact.html#1446" class="Record">EnactState</a>
    <a id="EpochState.fut"></a><a id="1624" href="Ledger.Epoch.html#1624" class="Field">fut</a>        <a id="1635" class="Symbol">:</a> <a id="1637" href="Ledger.Ratify.html#7575" class="Record">RatifyState</a>

<a id="1650" class="Markup">\end{code}</a><a id="1660" class="Background">
\begin{NoConway}
</a><a id="1678" class="Markup">\begin{code}</a>
<a id="1691" class="Keyword">record</a> <a id="NewEpochState"></a><a id="1698" href="Ledger.Epoch.html#1698" class="Record">NewEpochState</a> <a id="1712" class="Symbol">:</a> <a id="1714" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="1719" class="Keyword">where</a>
<a id="1725" class="Markup">\end{code}</a><a id="1735" class="Background">
</a><a id="1736" class="Markup">\begin{code}[hide]</a>
  <a id="1757" class="Keyword">constructor</a> <a id="⟦_,_,_⟧ⁿᵉ"></a><a id="1769" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">⟦_,_,_⟧ⁿᵉ</a>
  <a id="1781" class="Keyword">field</a>
<a id="1787" class="Markup">\end{code}</a><a id="1797" class="Background">
</a><a id="1798" class="Markup">\begin{code}</a>
    <a id="NewEpochState.lastEpoch"></a><a id="1815" href="Ledger.Epoch.html#1815" class="Field">lastEpoch</a>   <a id="1827" class="Symbol">:</a> <a id="1829" href="Ledger.Types.Epoch.html#335" class="Function">Epoch</a>
    <a id="NewEpochState.epochState"></a><a id="1839" href="Ledger.Epoch.html#1839" class="Field">epochState</a>  <a id="1851" class="Symbol">:</a> <a id="1853" href="Ledger.Epoch.html#1405" class="Record">EpochState</a>
    <a id="NewEpochState.ru"></a><a id="1868" href="Ledger.Epoch.html#1868" class="Field">ru</a>          <a id="1880" class="Symbol">:</a> <a id="1882" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="1888" href="Ledger.Epoch.html#719" class="Record">RewardUpdate</a>
<a id="1901" class="Markup">\end{code}</a><a id="1911" class="Background">
\end{NoConway}
\end{AgdaMultiCode}
\caption{Definitions for the EPOCH and NEWEPOCH transition systems}
\end{figure*}
</a><a id="2029" class="Markup">\begin{code}[hide]</a>
<a id="2048" class="Keyword">private</a> <a id="2056" class="Keyword">variable</a>
  <a id="2067" href="Ledger.Epoch.html#2067" class="Generalizable">nes</a> <a id="2071" href="Ledger.Epoch.html#2071" class="Generalizable">nes&#39;</a> <a id="2076" class="Symbol">:</a> <a id="2078" href="Ledger.Epoch.html#1698" class="Record">NewEpochState</a>
  <a id="2094" href="Ledger.Epoch.html#2094" class="Generalizable">e</a> <a id="2096" href="Ledger.Epoch.html#2096" class="Generalizable">lastEpoch</a> <a id="2106" class="Symbol">:</a> <a id="2108" href="Ledger.Types.Epoch.html#335" class="Function">Epoch</a>
  <a id="2116" href="Ledger.Epoch.html#2116" class="Generalizable">fut</a> <a id="2120" href="Ledger.Epoch.html#2120" class="Generalizable">fut&#39;</a> <a id="2125" class="Symbol">:</a> <a id="2127" href="Ledger.Ratify.html#7575" class="Record">RatifyState</a>
  <a id="2141" href="Ledger.Epoch.html#2141" class="Generalizable">eps</a> <a id="2145" href="Ledger.Epoch.html#2145" class="Generalizable">eps&#39;</a> <a id="2150" href="Ledger.Epoch.html#2150" class="Generalizable">eps&#39;&#39;</a> <a id="2156" class="Symbol">:</a> <a id="2158" href="Ledger.Epoch.html#1405" class="Record">EpochState</a>
  <a id="2171" href="Ledger.Epoch.html#2171" class="Generalizable">ls</a> <a id="2174" class="Symbol">:</a> <a id="2176" href="Ledger.Ledger.html#980" class="Record">LState</a>
  <a id="2185" href="Ledger.Epoch.html#2185" class="Generalizable">acnt</a> <a id="2190" class="Symbol">:</a> <a id="2192" href="Ledger.PParams.html#1161" class="Record">Acnt</a>
  <a id="2199" href="Ledger.Epoch.html#2199" class="Generalizable">es₀</a> <a id="2203" class="Symbol">:</a> <a id="2205" href="Ledger.Enact.html#1446" class="Record">EnactState</a>
  <a id="2218" href="Ledger.Epoch.html#2218" class="Generalizable">mark</a> <a id="2223" href="Ledger.Epoch.html#2223" class="Generalizable">set</a> <a id="2227" href="Ledger.Epoch.html#2227" class="Generalizable">go</a> <a id="2230" class="Symbol">:</a> <a id="2232" href="Ledger.Epoch.html#1071" class="Record">Snapshot</a>
  <a id="2243" href="Ledger.Epoch.html#2243" class="Generalizable">feeSS</a> <a id="2249" class="Symbol">:</a> <a id="2251" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
  <a id="2258" href="Ledger.Epoch.html#2258" class="Generalizable">lstate</a> <a id="2265" class="Symbol">:</a> <a id="2267" href="Ledger.Ledger.html#980" class="Record">LState</a>
  <a id="2276" href="Ledger.Epoch.html#2276" class="Generalizable">ss</a> <a id="2279" href="Ledger.Epoch.html#2279" class="Generalizable">ss&#39;</a> <a id="2283" class="Symbol">:</a> <a id="2285" href="Ledger.Epoch.html#1250" class="Record">Snapshots</a>
  <a id="2297" href="Ledger.Epoch.html#2297" class="Generalizable">ru</a> <a id="2300" class="Symbol">:</a> <a id="2302" href="Ledger.Epoch.html#719" class="Record">RewardUpdate</a>
  <a id="2317" href="Ledger.Epoch.html#2317" class="Generalizable">mru</a> <a id="2321" class="Symbol">:</a> <a id="2323" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="2329" href="Ledger.Epoch.html#719" class="Record">RewardUpdate</a>

<a id="2343" class="Keyword">instance</a> <a id="2352" href="Ledger.Epoch.html#2352" class="Function">_</a> <a id="2354" class="Symbol">=</a> <a id="2356" href="Data.Nat.Properties.html#16493" class="Function">+-0-monoid</a><a id="2366" class="Symbol">;</a> <a id="2368" href="Ledger.Epoch.html#2368" class="Function">_</a> <a id="2370" class="Symbol">=</a> <a id="2372" href="Data.Nat.Properties.html#16572" class="Function">+-0-commutativeMonoid</a>

<a id="toRwdAddr"></a><a id="2395" href="Ledger.Epoch.html#2395" class="Function">toRwdAddr</a> <a id="2405" class="Symbol">:</a> <a id="2407" href="Ledger.Address.html#764" class="Datatype">Credential</a> <a id="2418" class="Symbol">→</a> <a id="2420" href="Ledger.Address.html#1583" class="Record">RwdAddr</a>
<a id="2428" href="Ledger.Epoch.html#2395" class="Function">toRwdAddr</a> <a id="2438" href="Ledger.Epoch.html#2438" class="Bound">x</a> <a id="2440" class="Symbol">=</a> <a id="2442" class="Keyword">record</a> <a id="2449" class="Symbol">{</a> <a id="2451" href="Ledger.Address.html#1612" class="Field">net</a> <a id="2455" class="Symbol">=</a> <a id="2457" href="Ledger.Types.Epoch.html#1892" class="Function">NetworkId</a> <a id="2467" class="Symbol">;</a> <a id="2469" href="Ledger.Address.html#1637" class="Field">stake</a> <a id="2475" class="Symbol">=</a> <a id="2477" href="Ledger.Epoch.html#2438" class="Bound">x</a> <a id="2479" class="Symbol">}</a>

<a id="getStakeCred"></a><a id="2482" href="Ledger.Epoch.html#2482" class="Function">getStakeCred</a> <a id="2495" class="Symbol">:</a> <a id="2497" href="Ledger.Transaction.html#3845" class="Function">TxOut</a> <a id="2503" class="Symbol">→</a> <a id="2505" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="2511" href="Ledger.Address.html#764" class="Datatype">Credential</a>
<a id="2522" href="Ledger.Epoch.html#2482" class="Function">getStakeCred</a> <a id="2535" class="Symbol">(</a><a id="2536" href="Ledger.Epoch.html#2536" class="Bound">a</a> <a id="2538" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="2540" class="Symbol">_</a> <a id="2542" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="2544" class="Symbol">_</a> <a id="2546" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="2548" class="Symbol">_)</a> <a id="2551" class="Symbol">=</a> <a id="2553" href="Ledger.Address.html#2336" class="Function">stakeCred</a> <a id="2563" href="Ledger.Epoch.html#2536" class="Bound">a</a>

<a id="2566" class="Keyword">open</a> <a id="2571" href="Ledger.Address.html#1583" class="Module">RwdAddr</a> <a id="2579" class="Keyword">using</a> <a id="2585" class="Symbol">(</a><a id="2586" href="Ledger.Address.html#1637" class="Field">stake</a><a id="2591" class="Symbol">)</a>
<a id="2593" class="Keyword">open</a> <a id="2598" href="Ledger.GovernanceActions.html#8754" class="Module">GovActionState</a> <a id="2613" class="Keyword">using</a> <a id="2619" class="Symbol">(</a><a id="2620" href="Ledger.GovernanceActions.html#8879" class="Field">returnAddr</a><a id="2630" class="Symbol">)</a>

<a id="applyRUpd"></a><a id="2633" href="Ledger.Epoch.html#2633" class="Function">applyRUpd</a> <a id="2643" class="Symbol">:</a> <a id="2645" href="Ledger.Epoch.html#719" class="Record">RewardUpdate</a> <a id="2658" class="Symbol">→</a> <a id="2660" href="Ledger.Epoch.html#1405" class="Record">EpochState</a> <a id="2671" class="Symbol">→</a> <a id="2673" href="Ledger.Epoch.html#1405" class="Record">EpochState</a>
<a id="2684" href="Ledger.Epoch.html#2633" class="Function">applyRUpd</a> <a id="2694" href="Ledger.Epoch.html#758" class="InductiveConstructor Operator">⟦</a> <a id="2696" href="Ledger.Epoch.html#2696" class="Bound">Δt</a> <a id="2699" href="Ledger.Epoch.html#758" class="InductiveConstructor Operator">,</a> <a id="2701" href="Ledger.Epoch.html#2701" class="Bound">Δr</a> <a id="2704" href="Ledger.Epoch.html#758" class="InductiveConstructor Operator">,</a> <a id="2706" href="Ledger.Epoch.html#2706" class="Bound">Δf</a> <a id="2709" href="Ledger.Epoch.html#758" class="InductiveConstructor Operator">,</a> <a id="2711" href="Ledger.Epoch.html#2711" class="Bound">rs</a> <a id="2714" href="Ledger.Epoch.html#758" class="InductiveConstructor Operator">⟧ʳᵘ</a>
  <a id="2720" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">⟦</a> <a id="2722" href="Ledger.PParams.html#1223" class="InductiveConstructor Operator">⟦</a> <a id="2724" href="Ledger.Epoch.html#2724" class="Bound">treasury</a> <a id="2733" href="Ledger.PParams.html#1223" class="InductiveConstructor Operator">,</a> <a id="2735" href="Ledger.Epoch.html#2735" class="Bound">reserves</a> <a id="2744" href="Ledger.PParams.html#1223" class="InductiveConstructor Operator">⟧ᵃ</a>
  <a id="2749" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="2751" href="Ledger.Epoch.html#2751" class="Bound">ss</a>
  <a id="2756" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="2758" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">⟦</a> <a id="2760" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">⟦</a> <a id="2762" href="Ledger.Epoch.html#2762" class="Bound">utxo</a> <a id="2767" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">,</a> <a id="2769" href="Ledger.Epoch.html#2769" class="Bound">fees</a> <a id="2774" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">,</a> <a id="2776" href="Ledger.Epoch.html#2776" class="Bound">deposits</a> <a id="2785" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">,</a> <a id="2787" href="Ledger.Epoch.html#2787" class="Bound">donations</a> <a id="2797" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">⟧ᵘ</a>
    <a id="2804" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">,</a> <a id="2806" href="Ledger.Epoch.html#2806" class="Bound">govSt</a>
    <a id="2816" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">,</a> <a id="2818" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">⟦</a> <a id="2820" href="Ledger.Certs.html#2210" class="InductiveConstructor Operator">⟦</a> <a id="2822" href="Ledger.Epoch.html#2822" class="Bound">voteDelegs</a> <a id="2833" href="Ledger.Certs.html#2210" class="InductiveConstructor Operator">,</a> <a id="2835" href="Ledger.Epoch.html#2835" class="Bound">stakeDelegs</a> <a id="2847" href="Ledger.Certs.html#2210" class="InductiveConstructor Operator">,</a> <a id="2849" href="Ledger.Epoch.html#2849" class="Bound">rewards</a> <a id="2857" href="Ledger.Certs.html#2210" class="InductiveConstructor Operator">⟧ᵈ</a> <a id="2860" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">,</a> <a id="2862" href="Ledger.Epoch.html#2862" class="Bound">pState</a> <a id="2869" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">,</a> <a id="2871" href="Ledger.Epoch.html#2871" class="Bound">gState</a> <a id="2878" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">⟧ᶜˢ</a> <a id="2882" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">⟧ˡ</a>
  <a id="2887" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="2889" href="Ledger.Epoch.html#2889" class="Bound">es</a>
  <a id="2894" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="2896" href="Ledger.Epoch.html#2896" class="Bound">fut</a>
  <a id="2902" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">⟧ᵉ&#39;</a> <a id="2906" class="Symbol">=</a>
  <a id="2910" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">⟦</a> <a id="2912" href="Ledger.PParams.html#1223" class="InductiveConstructor Operator">⟦</a> <a id="2914" href="Data.Integer.Ext.html#349" class="Function">posPart</a> <a id="2922" class="Symbol">(</a><a id="2923" href="Agda.Builtin.Int.html#263" class="InductiveConstructor Operator">ℤ.+</a> <a id="2927" href="Ledger.Epoch.html#2724" class="Bound">treasury</a> <a id="2936" href="Data.Integer.Base.html#5064" class="Function Operator">ℤ.+</a> <a id="2940" href="Ledger.Epoch.html#2696" class="Bound">Δt</a> <a id="2943" href="Data.Integer.Base.html#5064" class="Function Operator">ℤ.+</a> <a id="2947" href="Agda.Builtin.Int.html#263" class="InductiveConstructor Operator">ℤ.+</a> <a id="2951" href="Ledger.Epoch.html#3267" class="Function">unregRU&#39;</a><a id="2959" class="Symbol">)</a>
    <a id="2965" href="Ledger.PParams.html#1223" class="InductiveConstructor Operator">,</a> <a id="2967" href="Data.Integer.Ext.html#349" class="Function">posPart</a> <a id="2975" class="Symbol">(</a><a id="2976" href="Agda.Builtin.Int.html#263" class="InductiveConstructor Operator">ℤ.+</a> <a id="2980" href="Ledger.Epoch.html#2735" class="Bound">reserves</a> <a id="2989" href="Data.Integer.Base.html#5064" class="Function Operator">ℤ.+</a> <a id="2993" href="Ledger.Epoch.html#2701" class="Bound">Δr</a><a id="2995" class="Symbol">)</a> <a id="2997" href="Ledger.PParams.html#1223" class="InductiveConstructor Operator">⟧ᵃ</a>
  <a id="3002" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="3004" href="Ledger.Epoch.html#2751" class="Bound">ss</a>
  <a id="3009" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="3011" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">⟦</a> <a id="3013" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">⟦</a> <a id="3015" href="Ledger.Epoch.html#2762" class="Bound">utxo</a> <a id="3020" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">,</a> <a id="3022" href="Data.Integer.Ext.html#349" class="Function">posPart</a> <a id="3030" class="Symbol">(</a><a id="3031" href="Agda.Builtin.Int.html#263" class="InductiveConstructor Operator">ℤ.+</a> <a id="3035" href="Ledger.Epoch.html#2769" class="Bound">fees</a> <a id="3040" href="Data.Integer.Base.html#5064" class="Function Operator">ℤ.+</a> <a id="3044" href="Ledger.Epoch.html#2706" class="Bound">Δf</a><a id="3046" class="Symbol">)</a> <a id="3048" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">,</a> <a id="3050" href="Ledger.Epoch.html#2776" class="Bound">deposits</a> <a id="3059" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">,</a> <a id="3061" href="Ledger.Epoch.html#2787" class="Bound">donations</a> <a id="3071" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">⟧ᵘ</a>
    <a id="3078" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">,</a> <a id="3080" href="Ledger.Epoch.html#2806" class="Bound">govSt</a>
    <a id="3090" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">,</a> <a id="3092" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">⟦</a> <a id="3094" href="Ledger.Certs.html#2210" class="InductiveConstructor Operator">⟦</a> <a id="3096" href="Ledger.Epoch.html#2822" class="Bound">voteDelegs</a> <a id="3107" href="Ledger.Certs.html#2210" class="InductiveConstructor Operator">,</a> <a id="3109" href="Ledger.Epoch.html#2835" class="Bound">stakeDelegs</a> <a id="3121" href="Ledger.Certs.html#2210" class="InductiveConstructor Operator">,</a> <a id="3123" href="Ledger.Epoch.html#2849" class="Bound">rewards</a> <a id="3131" href="Axiom.Set.Map.Dec.html#1956" class="Function Operator">∪⁺</a> <a id="3134" href="Ledger.Epoch.html#3199" class="Function">regRU</a> <a id="3140" href="Ledger.Certs.html#2210" class="InductiveConstructor Operator">⟧ᵈ</a> <a id="3143" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">,</a> <a id="3145" href="Ledger.Epoch.html#2862" class="Bound">pState</a> <a id="3152" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">,</a> <a id="3154" href="Ledger.Epoch.html#2871" class="Bound">gState</a> <a id="3161" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">⟧ᶜˢ</a> <a id="3165" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">⟧ˡ</a>
  <a id="3170" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="3172" href="Ledger.Epoch.html#2889" class="Bound">es</a>
  <a id="3177" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="3179" href="Ledger.Epoch.html#2896" class="Bound">fut</a> <a id="3183" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">⟧ᵉ&#39;</a>
  <a id="3189" class="Keyword">where</a>
    <a id="3199" href="Ledger.Epoch.html#3199" class="Function">regRU</a>     <a id="3209" class="Symbol">=</a> <a id="3211" href="Ledger.Epoch.html#2711" class="Bound">rs</a> <a id="3214" href="Axiom.Set.Map.html#10107" class="Function Operator">∣</a> <a id="3216" href="Interface.IsSet.html#934" class="Function">dom</a> <a id="3220" href="Ledger.Epoch.html#2849" class="Bound">rewards</a>
    <a id="3232" href="Ledger.Epoch.html#3232" class="Function">unregRU</a>   <a id="3242" class="Symbol">=</a> <a id="3244" href="Ledger.Epoch.html#2711" class="Bound">rs</a> <a id="3247" href="Axiom.Set.Map.html#10177" class="Function Operator">∣</a> <a id="3249" href="Interface.IsSet.html#934" class="Function">dom</a> <a id="3253" href="Ledger.Epoch.html#2849" class="Bound">rewards</a> <a id="3261" href="Axiom.Set.Map.html#10177" class="Function Operator">ᶜ</a>
    <a id="3267" href="Ledger.Epoch.html#3267" class="Function">unregRU&#39;</a>  <a id="3277" class="Symbol">=</a> <a id="3279" href="Ledger.Set.Theory.html#3127" class="Function">∑[</a> <a id="3282" href="Ledger.Epoch.html#3282" class="Bound">x</a> <a id="3284" href="Ledger.Set.Theory.html#3127" class="Function">←</a> <a id="3286" href="Ledger.Epoch.html#3232" class="Function">unregRU</a> <a id="3294" href="Ledger.Set.Theory.html#3127" class="Function">]</a> <a id="3296" href="Ledger.Epoch.html#3282" class="Bound">x</a>
<a id="3298" class="Markup">\end{code}</a><a id="3308" class="Background">

\begin{figure*}[h]
\begin{AgdaSuppressSpace}
</a><a id="3355" class="Markup">\begin{code}</a>
<a id="stakeDistr"></a><a id="3368" href="Ledger.Epoch.html#3368" class="Function">stakeDistr</a> <a id="3379" class="Symbol">:</a> <a id="3381" href="Ledger.Transaction.html#3913" class="Function">UTxO</a> <a id="3386" class="Symbol">→</a> <a id="3388" href="Ledger.Certs.html#2146" class="Record">DState</a> <a id="3395" class="Symbol">→</a> <a id="3397" href="Ledger.Certs.html#2416" class="Record">PState</a> <a id="3404" class="Symbol">→</a> <a id="3406" href="Ledger.Epoch.html#1071" class="Record">Snapshot</a>
<a id="3415" href="Ledger.Epoch.html#3368" class="Function">stakeDistr</a> <a id="3426" href="Ledger.Epoch.html#3426" class="Bound">utxo</a> <a id="3431" href="Ledger.Certs.html#2210" class="InductiveConstructor Operator">⟦</a> <a id="3433" class="Symbol">_</a> <a id="3435" href="Ledger.Certs.html#2210" class="InductiveConstructor Operator">,</a> <a id="3437" href="Ledger.Epoch.html#3437" class="Bound">stakeDelegs</a> <a id="3449" href="Ledger.Certs.html#2210" class="InductiveConstructor Operator">,</a> <a id="3451" href="Ledger.Epoch.html#3451" class="Bound">rewards</a> <a id="3459" href="Ledger.Certs.html#2210" class="InductiveConstructor Operator">⟧ᵈ</a> <a id="3462" href="Ledger.Epoch.html#3462" class="Bound">pState</a> <a id="3469" class="Symbol">=</a> <a id="3471" href="Ledger.Epoch.html#1106" class="InductiveConstructor Operator">⟦</a> <a id="3473" href="Axiom.Set.Map.Dec.html#2034" class="Function">aggregate₊</a> <a id="3484" class="Symbol">(</a><a id="3485" href="Ledger.Epoch.html#3623" class="Function">stakeRelation</a> <a id="3499" href="Ledger.Set.Theory.html#2685" class="Function Operator">ᶠˢ</a><a id="3501" class="Symbol">)</a> <a id="3503" href="Ledger.Epoch.html#1106" class="InductiveConstructor Operator">,</a> <a id="3505" href="Ledger.Epoch.html#3437" class="Bound">stakeDelegs</a> <a id="3517" href="Ledger.Epoch.html#1106" class="InductiveConstructor Operator">⟧ˢ</a>
  <a id="3522" class="Keyword">where</a>
    <a id="3532" href="Ledger.Epoch.html#3532" class="Function">m</a> <a id="3534" class="Symbol">=</a> <a id="3536" href="Ledger.Set.Theory.html#413" class="Function">mapˢ</a> <a id="3541" class="Symbol">(λ</a> <a id="3544" href="Ledger.Epoch.html#3544" class="Bound">a</a> <a id="3546" class="Symbol">→</a> <a id="3548" class="Symbol">(</a><a id="3549" href="Ledger.Epoch.html#3544" class="Bound">a</a> <a id="3551" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3553" href="Ledger.Utxo.html#6061" class="Function">cbalance</a> <a id="3562" class="Symbol">(</a><a id="3563" href="Ledger.Epoch.html#3426" class="Bound">utxo</a> <a id="3568" href="Ledger.Set.Theory.html#3006" class="Function Operator">∣^&#39;</a> <a id="3572" class="Symbol">λ</a> <a id="3574" href="Ledger.Epoch.html#3574" class="Bound">i</a> <a id="3576" class="Symbol">→</a> <a id="3578" href="Ledger.Epoch.html#2482" class="Function">getStakeCred</a> <a id="3591" href="Ledger.Epoch.html#3574" class="Bound">i</a> <a id="3593" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="3595" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="3600" href="Ledger.Epoch.html#3544" class="Bound">a</a><a id="3601" class="Symbol">)))</a> <a id="3605" class="Symbol">(</a><a id="3606" href="Interface.IsSet.html#934" class="Function">dom</a> <a id="3610" href="Ledger.Epoch.html#3451" class="Bound">rewards</a><a id="3617" class="Symbol">)</a>
    <a id="3623" href="Ledger.Epoch.html#3623" class="Function">stakeRelation</a> <a id="3637" class="Symbol">=</a> <a id="3639" href="Ledger.Epoch.html#3532" class="Function">m</a> <a id="3641" href="Axiom.Set.html#8665" class="Function Operator">∪</a> <a id="3643" href="Data.Product.Base.html#636" class="Field">proj₁</a> <a id="3649" href="Ledger.Epoch.html#3451" class="Bound">rewards</a>

<a id="gaDepositStake"></a><a id="3658" href="Ledger.Epoch.html#3658" class="Function">gaDepositStake</a> <a id="3673" class="Symbol">:</a> <a id="3675" href="Ledger.Gov.html#1410" class="Function">GovState</a> <a id="3684" class="Symbol">→</a> <a id="3686" href="Ledger.Certs.html#590" class="Function">Deposits</a> <a id="3695" class="Symbol">→</a> <a id="3697" href="Ledger.Address.html#764" class="Datatype">Credential</a> <a id="3708" href="Ledger.Set.Theory.html#1515" class="Function Operator">⇀</a> <a id="3710" href="Ledger.Prelude.Base.html#81" class="Function">Coin</a>
<a id="3715" href="Ledger.Epoch.html#3658" class="Function">gaDepositStake</a> <a id="3730" href="Ledger.Epoch.html#3730" class="Bound">govSt</a> <a id="3736" href="Ledger.Epoch.html#3736" class="Bound">ds</a> <a id="3739" class="Symbol">=</a> <a id="3741" href="Ledger.Set.Theory.html#3652" class="Function">aggregateBy</a>
  <a id="3755" class="Symbol">(</a><a id="3756" href="Ledger.Set.Theory.html#413" class="Function">mapˢ</a> <a id="3761" class="Symbol">(λ</a> <a id="3764" class="Symbol">(</a><a id="3765" href="Ledger.Epoch.html#3765" class="Bound">gaid</a> <a id="3770" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3772" href="Ledger.Epoch.html#3772" class="Bound">addr</a><a id="3776" class="Symbol">)</a> <a id="3778" class="Symbol">→</a> <a id="3780" class="Symbol">(</a><a id="3781" href="Ledger.Epoch.html#3765" class="Bound">gaid</a> <a id="3786" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3788" href="Ledger.Epoch.html#3772" class="Bound">addr</a><a id="3792" class="Symbol">)</a> <a id="3794" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3796" href="Ledger.Address.html#1637" class="Field">stake</a> <a id="3802" href="Ledger.Epoch.html#3772" class="Bound">addr</a><a id="3806" class="Symbol">)</a> <a id="3808" href="Ledger.Epoch.html#3906" class="Function">govSt&#39;</a><a id="3814" class="Symbol">)</a>
  <a id="3818" class="Symbol">(</a><a id="3819" href="Axiom.Set.Map.html#9889" class="Function">mapFromPartialFun</a> <a id="3837" class="Symbol">(λ</a> <a id="3840" class="Symbol">(</a><a id="3841" href="Ledger.Epoch.html#3841" class="Bound">gaid</a> <a id="3846" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3848" class="Symbol">_)</a> <a id="3851" class="Symbol">→</a> <a id="3853" href="Axiom.Set.Map.html#12605" class="Function">lookupᵐ?</a> <a id="3862" href="Ledger.Epoch.html#3736" class="Bound">ds</a> <a id="3865" class="Symbol">(</a><a id="3866" href="Ledger.Certs.html#538" class="InductiveConstructor">GovActionDeposit</a> <a id="3883" href="Ledger.Epoch.html#3841" class="Bound">gaid</a><a id="3887" class="Symbol">))</a> <a id="3890" href="Ledger.Epoch.html#3906" class="Function">govSt&#39;</a><a id="3896" class="Symbol">)</a>
  <a id="3900" class="Keyword">where</a> <a id="3906" href="Ledger.Epoch.html#3906" class="Function">govSt&#39;</a> <a id="3913" class="Symbol">=</a> <a id="3915" href="Ledger.Set.Theory.html#413" class="Function">mapˢ</a> <a id="3920" class="Symbol">(</a><a id="3921" href="Class.Bifunctor.html#1143" class="Function">map₂</a> <a id="3926" href="Ledger.GovernanceActions.html#8879" class="Field">returnAddr</a><a id="3936" class="Symbol">)</a> <a id="3938" class="Symbol">(</a><a id="3939" href="Axiom.Set.html#5431" class="Function">fromList</a> <a id="3948" href="Ledger.Epoch.html#3730" class="Bound">govSt</a><a id="3953" class="Symbol">)</a>

<a id="3956" class="Markup">\end{code}</a><a id="3966" class="Background">
</a><a id="3967" class="Markup">\begin{code}[hide]</a>
<a id="3986" class="Keyword">opaque</a>
<a id="3993" class="Markup">\end{code}</a><a id="4003" class="Background">
</a><a id="4004" class="Markup">\begin{code}</a>
  <a id="mkStakeDistrs"></a><a id="4019" href="Ledger.Epoch.html#4019" class="Function">mkStakeDistrs</a> <a id="4033" class="Symbol">:</a> <a id="4035" href="Ledger.Epoch.html#1071" class="Record">Snapshot</a> <a id="4044" class="Symbol">→</a> <a id="4046" href="Ledger.Gov.html#1410" class="Function">GovState</a> <a id="4055" class="Symbol">→</a> <a id="4057" href="Ledger.Certs.html#590" class="Function">Deposits</a> <a id="4066" class="Symbol">→</a> <a id="4068" class="Symbol">(</a><a id="4069" href="Ledger.Address.html#764" class="Datatype">Credential</a> <a id="4080" href="Ledger.Set.Theory.html#1515" class="Function Operator">⇀</a> <a id="4082" href="Ledger.GovernanceActions.html#1215" class="Datatype">VDeleg</a><a id="4088" class="Symbol">)</a> <a id="4090" class="Symbol">→</a> <a id="4092" href="Ledger.Ratify.html#7183" class="Record">StakeDistrs</a>
  <a id="4106" href="Ledger.Epoch.html#4019" class="Function">mkStakeDistrs</a> <a id="4120" href="Ledger.Epoch.html#1106" class="InductiveConstructor Operator">⟦</a> <a id="4122" href="Ledger.Epoch.html#4122" class="Bound">stake</a> <a id="4128" href="Ledger.Epoch.html#1106" class="InductiveConstructor Operator">,</a> <a id="4130" class="Symbol">_</a> <a id="4132" href="Ledger.Epoch.html#1106" class="InductiveConstructor Operator">⟧ˢ</a> <a id="4135" href="Ledger.Epoch.html#4135" class="Bound">govSt</a> <a id="4141" href="Ledger.Epoch.html#4141" class="Bound">ds</a> <a id="4144" href="Ledger.Epoch.html#4144" class="Bound">delegations</a> <a id="4156" class="Symbol">.</a><a id="4157" href="Ledger.Ratify.html#7274" class="Field">StakeDistrs.stakeDistr</a> <a id="4180" class="Symbol">=</a>
    <a id="4186" href="Ledger.Set.Theory.html#3652" class="Function">aggregateBy</a> <a id="4198" class="Symbol">(</a><a id="4199" href="Data.Product.Base.html#636" class="Field">proj₁</a> <a id="4205" href="Ledger.Epoch.html#4144" class="Bound">delegations</a><a id="4216" class="Symbol">)</a> <a id="4218" class="Symbol">(</a><a id="4219" href="Ledger.Epoch.html#4122" class="Bound">stake</a> <a id="4225" href="Axiom.Set.Map.Dec.html#1956" class="Function Operator">∪⁺</a> <a id="4228" href="Ledger.Epoch.html#3658" class="Function">gaDepositStake</a> <a id="4243" href="Ledger.Epoch.html#4135" class="Bound">govSt</a> <a id="4249" href="Ledger.Epoch.html#4141" class="Bound">ds</a><a id="4251" class="Symbol">)</a>
<a id="4253" class="Markup">\end{code}</a><a id="4263" class="Background">
\end{AgdaSuppressSpace}
\caption{Functions for computing stake distributions}
\end{figure*}

\begin{NoConway}
</a><a id="4374" class="Markup">\begin{code}</a>
<a id="4387" class="Keyword">data</a> <a id="_⊢_⇀⦇_,SNAP⦈_"></a><a id="4392" href="Ledger.Epoch.html#4392" class="Datatype Operator">_⊢_⇀⦇_,SNAP⦈_</a> <a id="4406" class="Symbol">:</a> <a id="4408" href="Ledger.Ledger.html#980" class="Record">LState</a> <a id="4415" class="Symbol">→</a> <a id="4417" href="Ledger.Epoch.html#1250" class="Record">Snapshots</a> <a id="4427" class="Symbol">→</a> <a id="4429" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a> <a id="4431" class="Symbol">→</a> <a id="4433" href="Ledger.Epoch.html#1250" class="Record">Snapshots</a> <a id="4443" class="Symbol">→</a> <a id="4445" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="4450" class="Keyword">where</a>
  <a id="_⊢_⇀⦇_,SNAP⦈_.SNAP"></a><a id="4458" href="Ledger.Epoch.html#4458" class="InductiveConstructor">SNAP</a> <a id="4463" class="Symbol">:</a> <a id="4465" class="Keyword">let</a> <a id="4469" class="Keyword">open</a> <a id="4474" href="Ledger.Ledger.html#980" class="Module">LState</a> <a id="4481" href="Ledger.Epoch.html#2258" class="Generalizable">lstate</a><a id="4487" class="Symbol">;</a> <a id="4489" class="Keyword">open</a> <a id="4494" href="Ledger.Utxo.html#5240" class="Module">UTxOState</a> <a id="4504" href="Ledger.Ledger.html#1089" class="Function">utxoSt</a><a id="4510" class="Symbol">;</a> <a id="4512" class="Keyword">open</a> <a id="4517" href="Ledger.Certs.html#2829" class="Module">CertState</a> <a id="4527" href="Ledger.Ledger.html#1142" class="Function">certState</a>
             <a id="4550" href="Ledger.Epoch.html#4550" class="Bound">stake</a> <a id="4556" class="Symbol">=</a> <a id="4558" href="Ledger.Epoch.html#3368" class="Function">stakeDistr</a> <a id="4569" href="Ledger.Utxo.html#5354" class="Function">utxo</a> <a id="4574" href="Ledger.Certs.html#2942" class="Function">dState</a> <a id="4581" href="Ledger.Certs.html#2962" class="Function">pState</a>
    <a id="4592" class="Keyword">in</a>
    <a id="4599" href="Ledger.Epoch.html#2258" class="Generalizable">lstate</a> <a id="4606" href="Ledger.Epoch.html#4392" class="Datatype Operator">⊢</a> <a id="4608" href="Ledger.Epoch.html#1286" class="InductiveConstructor Operator">⟦</a> <a id="4610" href="Ledger.Epoch.html#2218" class="Generalizable">mark</a> <a id="4615" href="Ledger.Epoch.html#1286" class="InductiveConstructor Operator">,</a> <a id="4617" href="Ledger.Epoch.html#2223" class="Generalizable">set</a> <a id="4621" href="Ledger.Epoch.html#1286" class="InductiveConstructor Operator">,</a> <a id="4623" href="Ledger.Epoch.html#2227" class="Generalizable">go</a> <a id="4626" href="Ledger.Epoch.html#1286" class="InductiveConstructor Operator">,</a> <a id="4628" href="Ledger.Epoch.html#2243" class="Generalizable">feeSS</a> <a id="4634" href="Ledger.Epoch.html#1286" class="InductiveConstructor Operator">⟧ˢˢ</a> <a id="4638" href="Ledger.Epoch.html#4392" class="Datatype Operator">⇀⦇</a> <a id="4641" href="Agda.Builtin.Unit.html#212" class="InductiveConstructor">tt</a> <a id="4644" href="Ledger.Epoch.html#4392" class="Datatype Operator">,SNAP⦈</a> <a id="4651" href="Ledger.Epoch.html#1286" class="InductiveConstructor Operator">⟦</a> <a id="4653" href="Ledger.Epoch.html#4550" class="Bound">stake</a> <a id="4659" href="Ledger.Epoch.html#1286" class="InductiveConstructor Operator">,</a> <a id="4661" href="Ledger.Epoch.html#2218" class="Generalizable">mark</a> <a id="4666" href="Ledger.Epoch.html#1286" class="InductiveConstructor Operator">,</a> <a id="4668" href="Ledger.Epoch.html#2223" class="Generalizable">set</a> <a id="4672" href="Ledger.Epoch.html#1286" class="InductiveConstructor Operator">,</a> <a id="4674" href="Ledger.Utxo.html#5376" class="Function">fees</a> <a id="4679" href="Ledger.Epoch.html#1286" class="InductiveConstructor Operator">⟧ˢˢ</a>

<a id="4684" class="Keyword">data</a> <a id="_⊢_⇀⦇_,EPOCH⦈_"></a><a id="4689" href="Ledger.Epoch.html#4689" class="Datatype Operator">_⊢_⇀⦇_,EPOCH⦈_</a> <a id="4704" class="Symbol">:</a> <a id="4706" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a> <a id="4708" class="Symbol">→</a> <a id="4710" href="Ledger.Epoch.html#1405" class="Record">EpochState</a> <a id="4721" class="Symbol">→</a> <a id="4723" href="Ledger.Types.Epoch.html#335" class="Function">Epoch</a> <a id="4729" class="Symbol">→</a> <a id="4731" href="Ledger.Epoch.html#1405" class="Record">EpochState</a> <a id="4742" class="Symbol">→</a> <a id="4744" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="4749" class="Keyword">where</a>
<a id="4755" class="Markup">\end{code}</a><a id="4765" class="Background">
\end{NoConway}

Figure~\ref{fig:epoch:sts} defines the rule for the EPOCH transition
system. Currently, this contains some logic that is handled by
POOLREAP in the Shelley specification, since POOLREAP is not implemented here.

The EPOCH rule now also needs to invoke RATIFY and properly deal with
its results by carrying out each of the following tasks.
\begin{itemize}
\item Pay out all the enacted treasury withdrawals.
\item Remove expired and enacted governance actions \&amp; refund deposits.
\item If \AgdaBound{govSt&#39;} is empty, increment the activity counter for DReps.
\item Remove all hot keys from the constitutional committee delegation map that
  do not belong to currently elected members.
\item Apply the resulting enact state from the previous epoch boundary \AgdaBound{fut} and
  store the resulting enact state \AgdaBound{fut&#39;}.
\end{itemize}

\begin{figure*}[h]
\begin{AgdaMultiCode}
</a><a id="5666" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,EPOCH⦈_.EPOCH"></a><a id="5681" href="Ledger.Epoch.html#5681" class="InductiveConstructor">EPOCH</a> <a id="5687" class="Symbol">:</a> <a id="5689" class="Keyword">let</a>
      <a id="5699" href="Ledger.Ratify.html#7644" class="InductiveConstructor Operator">⟦</a> <a id="5701" href="Ledger.Epoch.html#5701" class="Bound">esW</a> <a id="5705" href="Ledger.Ratify.html#7644" class="InductiveConstructor Operator">,</a> <a id="5707" href="Ledger.Epoch.html#5707" class="Bound">removed</a> <a id="5715" href="Ledger.Ratify.html#7644" class="InductiveConstructor Operator">,</a> <a id="5717" class="Symbol">_</a> <a id="5719" href="Ledger.Ratify.html#7644" class="InductiveConstructor Operator">⟧ʳ</a> <a id="5722" class="Symbol">=</a> <a id="5724" href="Ledger.Epoch.html#2116" class="Generalizable">fut</a>
      <a id="5734" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">⟦</a> <a id="5736" href="Ledger.Epoch.html#5736" class="Bound">utxoSt</a> <a id="5743" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">,</a> <a id="5745" href="Ledger.Epoch.html#5745" class="Bound">govSt</a> <a id="5751" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">,</a> <a id="5753" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">⟦</a> <a id="5755" href="Ledger.Epoch.html#5755" class="Bound">dState</a> <a id="5762" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">,</a> <a id="5764" href="Ledger.Epoch.html#5764" class="Bound">pState</a> <a id="5771" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">,</a> <a id="5773" href="Ledger.Epoch.html#5773" class="Bound">gState</a> <a id="5780" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">⟧ᶜˢ</a> <a id="5784" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">⟧ˡ</a> <a id="5787" class="Symbol">=</a> <a id="5789" href="Ledger.Epoch.html#2171" class="Generalizable">ls</a>
<a id="5792" class="Markup">\end{code}</a><a id="5802" class="Background">
</a><a id="5803" class="Markup">\begin{code}[hide]</a>
      <a id="5828" class="Keyword">open</a> <a id="5833" href="Ledger.Utxo.html#5240" class="Module">UTxOState</a>
      <a id="5849" class="Keyword">open</a> <a id="5854" href="Ledger.Certs.html#2416" class="Module">PState</a><a id="5860" class="Symbol">;</a> <a id="5862" class="Keyword">open</a> <a id="5867" href="Ledger.Certs.html#2146" class="Module">DState</a><a id="5873" class="Symbol">;</a> <a id="5875" class="Keyword">open</a> <a id="5880" href="Ledger.Certs.html#2635" class="Module">GState</a>
      <a id="5893" class="Keyword">open</a> <a id="5898" href="Ledger.PParams.html#1161" class="Module">Acnt</a><a id="5902" class="Symbol">;</a> <a id="5904" class="Keyword">open</a> <a id="5909" href="Ledger.Enact.html#1446" class="Module">EnactState</a><a id="5919" class="Symbol">;</a> <a id="5921" class="Keyword">open</a> <a id="5926" href="Ledger.GovernanceActions.html#8754" class="Module">GovActionState</a>
<a id="5941" class="Markup">\end{code}</a><a id="5951" class="Background">
</a><a id="5952" class="Markup">\begin{code}</a>

      <a id="5972" href="Ledger.Epoch.html#5972" class="Bound">removedGovActions</a> <a id="5990" class="Symbol">=</a> <a id="5992" href="Function.Base.html#1638" class="Function">flip</a> <a id="5997" href="Axiom.Set.html#6735" class="Function">concatMapˢ</a> <a id="6008" href="Ledger.Epoch.html#5707" class="Bound">removed</a> <a id="6016" class="Symbol">λ</a> <a id="6018" class="Symbol">(</a><a id="6019" href="Ledger.Epoch.html#6019" class="Bound">gaid</a> <a id="6024" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6026" href="Ledger.Epoch.html#6026" class="Bound">gaSt</a><a id="6030" class="Symbol">)</a> <a id="6032" class="Symbol">→</a>
        <a id="6042" href="Ledger.Set.Theory.html#413" class="Function">mapˢ</a> <a id="6047" class="Symbol">(</a><a id="6048" href="Ledger.GovernanceActions.html#8879" class="Field">returnAddr</a> <a id="6059" href="Ledger.Epoch.html#6026" class="Bound">gaSt</a> <a id="6064" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,_</a><a id="6066" class="Symbol">)</a> <a id="6068" class="Symbol">((</a><a id="6070" href="Ledger.Epoch.html#5736" class="Bound">utxoSt</a> <a id="6077" class="Symbol">.</a><a id="6078" href="Ledger.Utxo.html#5398" class="Field">deposits</a> <a id="6087" href="Axiom.Set.Map.html#10107" class="Function Operator">∣</a> <a id="6089" href="Interface.HasSingleton.html#348" class="Field Operator">❴</a> <a id="6091" href="Ledger.Certs.html#538" class="InductiveConstructor">GovActionDeposit</a> <a id="6108" href="Ledger.Epoch.html#6019" class="Bound">gaid</a> <a id="6113" href="Interface.HasSingleton.html#348" class="Field Operator">❵</a><a id="6114" class="Symbol">)</a> <a id="6116" href="Axiom.Set.Map.html#2282" class="Function Operator">ˢ</a><a id="6117" class="Symbol">)</a>
      <a id="6125" href="Ledger.Epoch.html#6125" class="Bound">govActionReturns</a> <a id="6142" class="Symbol">=</a> <a id="6144" href="Axiom.Set.Map.Dec.html#2034" class="Function">aggregate₊</a> <a id="6155" class="Symbol">(</a><a id="6156" href="Ledger.Set.Theory.html#413" class="Function">mapˢ</a> <a id="6161" class="Symbol">(λ</a> <a id="6164" class="Symbol">(</a><a id="6165" href="Ledger.Epoch.html#6165" class="Bound">a</a> <a id="6167" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6169" class="Symbol">_</a> <a id="6171" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6173" href="Ledger.Epoch.html#6173" class="Bound">d</a><a id="6174" class="Symbol">)</a> <a id="6176" class="Symbol">→</a> <a id="6178" href="Ledger.Epoch.html#6165" class="Bound">a</a> <a id="6180" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6182" href="Ledger.Epoch.html#6173" class="Bound">d</a><a id="6183" class="Symbol">)</a> <a id="6185" href="Ledger.Epoch.html#5972" class="Bound">removedGovActions</a> <a id="6203" href="Ledger.Set.Theory.html#2685" class="Function Operator">ᶠˢ</a><a id="6205" class="Symbol">)</a>

      <a id="6214" href="Ledger.Epoch.html#6214" class="Bound">trWithdrawals</a>   <a id="6230" class="Symbol">=</a> <a id="6232" href="Ledger.Epoch.html#5701" class="Bound">esW</a> <a id="6236" class="Symbol">.</a><a id="6237" href="Ledger.Enact.html#1752" class="Field">withdrawals</a>
      <a id="6255" href="Ledger.Epoch.html#6255" class="Bound">totWithdrawals</a>  <a id="6271" class="Symbol">=</a> <a id="6273" href="Ledger.Set.Theory.html#3127" class="Function">∑[</a> <a id="6276" href="Ledger.Epoch.html#6276" class="Bound">x</a> <a id="6278" href="Ledger.Set.Theory.html#3127" class="Function">←</a> <a id="6280" href="Ledger.Epoch.html#6214" class="Bound">trWithdrawals</a> <a id="6294" href="Ledger.Set.Theory.html#3127" class="Function">]</a> <a id="6296" href="Ledger.Epoch.html#6276" class="Bound">x</a>

      <a id="6305" href="Ledger.Epoch.html#6305" class="Bound">es</a>         <a id="6316" class="Symbol">=</a> <a id="6318" class="Keyword">record</a> <a id="6325" href="Ledger.Epoch.html#5701" class="Bound">esW</a> <a id="6329" class="Symbol">{</a> <a id="6331" href="Ledger.Enact.html#1752" class="Field">withdrawals</a> <a id="6343" class="Symbol">=</a> <a id="6345" href="Interface.HasEmptySet.html#150" class="Field">∅</a> <a id="6347" class="Symbol">}</a>
      <a id="6355" href="Ledger.Epoch.html#6355" class="Bound">retired</a>    <a id="6366" class="Symbol">=</a> <a id="6368" class="Symbol">(</a><a id="6369" href="Ledger.Epoch.html#5764" class="Bound">pState</a> <a id="6376" class="Symbol">.</a><a id="6377" href="Ledger.Certs.html#2560" class="Field">retiring</a><a id="6385" class="Symbol">)</a> <a id="6387" href="Axiom.Set.Map.html#13165" class="Function Operator">⁻¹</a> <a id="6390" href="Ledger.Epoch.html#2094" class="Generalizable">e</a>
      <a id="6398" href="Ledger.Epoch.html#6398" class="Bound">payout</a>     <a id="6409" class="Symbol">=</a> <a id="6411" href="Ledger.Epoch.html#6125" class="Bound">govActionReturns</a> <a id="6428" href="Axiom.Set.Map.Dec.html#1956" class="Function Operator">∪⁺</a> <a id="6431" href="Ledger.Epoch.html#6214" class="Bound">trWithdrawals</a>
      <a id="6451" href="Ledger.Epoch.html#6451" class="Bound">refunds</a>    <a id="6462" class="Symbol">=</a> <a id="6464" href="Axiom.Set.Map.html#12726" class="Function">pullbackMap</a> <a id="6476" href="Ledger.Epoch.html#6398" class="Bound">payout</a> <a id="6483" href="Ledger.Epoch.html#2395" class="Function">toRwdAddr</a> <a id="6493" class="Symbol">(</a><a id="6494" href="Interface.IsSet.html#934" class="Function">dom</a> <a id="6498" class="Symbol">(</a><a id="6499" href="Ledger.Epoch.html#5755" class="Bound">dState</a> <a id="6506" class="Symbol">.</a><a id="6507" href="Ledger.Certs.html#2334" class="Field">rewards</a><a id="6514" class="Symbol">))</a>
      <a id="6523" href="Ledger.Epoch.html#6523" class="Bound">unclaimed</a>  <a id="6534" class="Symbol">=</a> <a id="6536" href="Ledger.Interface.HasCoin.html#172" class="Field">getCoin</a> <a id="6544" href="Ledger.Epoch.html#6398" class="Bound">payout</a> <a id="6551" href="Interface.HasSubtract.html#209" class="Field Operator">-</a> <a id="6553" href="Ledger.Interface.HasCoin.html#172" class="Field">getCoin</a> <a id="6561" href="Ledger.Epoch.html#6451" class="Bound">refunds</a>

      <a id="6576" href="Ledger.Epoch.html#6576" class="Bound">govSt&#39;</a> <a id="6583" class="Symbol">=</a> <a id="6585" href="Data.List.Base.html#10878" class="Function">filter</a> <a id="6592" class="Symbol">(λ</a> <a id="6595" href="Ledger.Epoch.html#6595" class="Bound">x</a> <a id="6597" class="Symbol">→</a> <a id="6599" href="Class.Decidable.Core.html#461" class="Function Operator">¿</a> <a id="6601" href="Data.Product.Base.html#636" class="Field">proj₁</a> <a id="6607" href="Ledger.Epoch.html#6595" class="Bound">x</a> <a id="6609" href="Interface.IsSet.html#480" class="Function Operator">∉</a> <a id="6611" href="Ledger.Set.Theory.html#413" class="Function">mapˢ</a> <a id="6616" href="Data.Product.Base.html#636" class="Field">proj₁</a> <a id="6622" href="Ledger.Epoch.html#5707" class="Bound">removed</a> <a id="6630" href="Class.Decidable.Core.html#461" class="Function Operator">¿</a><a id="6631" class="Symbol">)</a> <a id="6633" href="Ledger.Epoch.html#5745" class="Bound">govSt</a>

      <a id="6646" href="Ledger.Epoch.html#6646" class="Bound">certState&#39;</a> <a id="6657" class="Symbol">=</a>
        <a id="6667" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">⟦</a> <a id="6669" class="Keyword">record</a> <a id="6676" href="Ledger.Epoch.html#5755" class="Bound">dState</a> <a id="6683" class="Symbol">{</a> <a id="6685" href="Ledger.Certs.html#2334" class="Field">rewards</a> <a id="6693" class="Symbol">=</a> <a id="6695" href="Ledger.Epoch.html#5755" class="Bound">dState</a> <a id="6702" class="Symbol">.</a><a id="6703" href="Ledger.Certs.html#2334" class="Field">rewards</a> <a id="6711" href="Axiom.Set.Map.Dec.html#1956" class="Function Operator">∪⁺</a> <a id="6714" href="Ledger.Epoch.html#6451" class="Bound">refunds</a> <a id="6722" class="Symbol">}</a>
        <a id="6732" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">,</a> <a id="6734" href="Ledger.Certs.html#2480" class="InductiveConstructor Operator">⟦</a> <a id="6736" class="Symbol">(</a><a id="6737" href="Ledger.Epoch.html#5764" class="Bound">pState</a> <a id="6744" class="Symbol">.</a><a id="6745" href="Ledger.Certs.html#2523" class="Field">pools</a><a id="6750" class="Symbol">)</a> <a id="6752" href="Axiom.Set.Map.html#10177" class="Function Operator">∣</a> <a id="6754" href="Ledger.Epoch.html#6355" class="Bound">retired</a> <a id="6762" href="Axiom.Set.Map.html#10177" class="Function Operator">ᶜ</a> <a id="6764" href="Ledger.Certs.html#2480" class="InductiveConstructor Operator">,</a> <a id="6766" class="Symbol">(</a><a id="6767" href="Ledger.Epoch.html#5764" class="Bound">pState</a> <a id="6774" class="Symbol">.</a><a id="6775" href="Ledger.Certs.html#2560" class="Field">retiring</a><a id="6783" class="Symbol">)</a> <a id="6785" href="Axiom.Set.Map.html#10177" class="Function Operator">∣</a> <a id="6787" href="Ledger.Epoch.html#6355" class="Bound">retired</a> <a id="6795" href="Axiom.Set.Map.html#10177" class="Function Operator">ᶜ</a> <a id="6797" href="Ledger.Certs.html#2480" class="InductiveConstructor Operator">⟧ᵖ</a>
        <a id="6808" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">,</a> <a id="6810" href="Ledger.Certs.html#2699" class="InductiveConstructor Operator">⟦</a> <a id="6812" href="Interface.ToBool.html#287" class="Function Operator">if</a> <a id="6815" href="Data.List.Base.html#4742" class="Function">null</a> <a id="6820" href="Ledger.Epoch.html#6576" class="Bound">govSt&#39;</a> <a id="6827" href="Interface.ToBool.html#287" class="Function Operator">then</a> <a id="6832" href="Axiom.Set.Map.html#6138" class="Function">mapValues</a> <a id="6842" class="Symbol">(</a><a id="6843" class="Number">1</a> <a id="6845" href="Interface.HasAdd.html#135" class="Field Operator">+_</a><a id="6847" class="Symbol">)</a> <a id="6849" class="Symbol">(</a><a id="6850" href="Ledger.Epoch.html#5773" class="Bound">gState</a> <a id="6857" class="Symbol">.</a><a id="6858" href="Ledger.Certs.html#2742" class="Field">dreps</a><a id="6863" class="Symbol">)</a> <a id="6865" href="Interface.ToBool.html#287" class="Function Operator">else</a> <a id="6870" class="Symbol">(</a><a id="6871" href="Ledger.Epoch.html#5773" class="Bound">gState</a> <a id="6878" class="Symbol">.</a><a id="6879" href="Ledger.Certs.html#2742" class="Field">dreps</a><a id="6884" class="Symbol">)</a>
          <a id="6896" href="Ledger.Certs.html#2699" class="InductiveConstructor Operator">,</a> <a id="6898" class="Symbol">(</a><a id="6899" href="Ledger.Epoch.html#5773" class="Bound">gState</a> <a id="6906" class="Symbol">.</a><a id="6907" href="Ledger.Certs.html#2778" class="Field">ccHotKeys</a><a id="6916" class="Symbol">)</a> <a id="6918" href="Axiom.Set.Map.html#10107" class="Function Operator">∣</a> <a id="6920" href="Ledger.Enact.html#1784" class="Function">ccCreds</a> <a id="6928" class="Symbol">(</a><a id="6929" href="Ledger.Epoch.html#6305" class="Bound">es</a> <a id="6932" class="Symbol">.</a><a id="6933" href="Ledger.Enact.html#1536" class="Field">cc</a><a id="6935" class="Symbol">)</a> <a id="6937" href="Ledger.Certs.html#2699" class="InductiveConstructor Operator">⟧ᵛ</a> <a id="6940" href="Ledger.Certs.html#2896" class="InductiveConstructor Operator">⟧ᶜˢ</a>

      <a id="6951" href="Ledger.Epoch.html#6951" class="Bound">utxoSt&#39;</a> <a id="6959" class="Symbol">=</a> <a id="6961" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">⟦</a> <a id="6963" href="Ledger.Epoch.html#5736" class="Bound">utxoSt</a> <a id="6970" class="Symbol">.</a><a id="6971" href="Ledger.Utxo.html#5354" class="Field">utxo</a> <a id="6976" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">,</a> <a id="6978" href="Ledger.Epoch.html#5736" class="Bound">utxoSt</a> <a id="6985" class="Symbol">.</a><a id="6986" href="Ledger.Utxo.html#5376" class="Field">fees</a> <a id="6991" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">,</a> <a id="6993" href="Ledger.Epoch.html#5736" class="Bound">utxoSt</a> <a id="7000" class="Symbol">.</a><a id="7001" href="Ledger.Utxo.html#5398" class="Field">deposits</a> <a id="7010" href="Axiom.Set.Map.html#10177" class="Function Operator">∣</a> <a id="7012" href="Ledger.Set.Theory.html#413" class="Function">mapˢ</a> <a id="7017" class="Symbol">(</a><a id="7018" href="Data.Product.Base.html#636" class="Field">proj₁</a> <a id="7024" href="Function.Base.html#1115" class="Function Operator">∘</a> <a id="7026" href="Data.Product.Base.html#650" class="Field">proj₂</a><a id="7031" class="Symbol">)</a> <a id="7033" href="Ledger.Epoch.html#5972" class="Bound">removedGovActions</a> <a id="7051" href="Axiom.Set.Map.html#10177" class="Function Operator">ᶜ</a> <a id="7053" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">,</a> <a id="7055" class="Number">0</a> <a id="7057" href="Ledger.Utxo.html#5307" class="InductiveConstructor Operator">⟧ᵘ</a>

      <a id="7067" href="Ledger.Epoch.html#7067" class="Bound">acnt&#39;</a> <a id="7073" class="Symbol">=</a> <a id="7075" class="Keyword">record</a> <a id="7082" href="Ledger.Epoch.html#2185" class="Generalizable">acnt</a>
        <a id="7095" class="Symbol">{</a> <a id="7097" href="Ledger.PParams.html#1266" class="Field">treasury</a>  <a id="7107" class="Symbol">=</a> <a id="7109" href="Ledger.Epoch.html#2185" class="Generalizable">acnt</a> <a id="7114" class="Symbol">.</a><a id="7115" href="Ledger.PParams.html#1266" class="Field">treasury</a> <a id="7124" href="Data.Nat.Base.html#4456" class="Primitive Operator">∸</a> <a id="7126" href="Ledger.Epoch.html#6255" class="Bound">totWithdrawals</a> <a id="7141" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="7143" href="Ledger.Epoch.html#5736" class="Bound">utxoSt</a> <a id="7150" class="Symbol">.</a><a id="7151" href="Ledger.Utxo.html#5424" class="Field">donations</a> <a id="7161" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="7163" href="Ledger.Epoch.html#6523" class="Bound">unclaimed</a> <a id="7173" class="Symbol">}</a>
    <a id="7179" class="Keyword">in</a>
    <a id="7186" class="Keyword">record</a> <a id="7193" class="Symbol">{</a> <a id="7195" href="Ledger.Ratify.html#7431" class="Field">currentEpoch</a> <a id="7208" class="Symbol">=</a> <a id="7210" href="Ledger.Epoch.html#2094" class="Generalizable">e</a>
           <a id="7223" class="Symbol">;</a> <a id="7225" href="Ledger.Ratify.html#7399" class="Field">stakeDistrs</a> <a id="7237" class="Symbol">=</a> <a id="7239" href="Ledger.Epoch.html#4019" class="Function">mkStakeDistrs</a>  <a id="7254" class="Symbol">(</a><a id="7255" href="Ledger.Epoch.html#1310" class="Field">Snapshots.mark</a> <a id="7270" href="Ledger.Epoch.html#2279" class="Generalizable">ss&#39;</a><a id="7273" class="Symbol">)</a> <a id="7275" href="Ledger.Epoch.html#6576" class="Bound">govSt&#39;</a>
                                          <a id="7324" class="Symbol">(</a><a id="7325" href="Ledger.Epoch.html#6951" class="Bound">utxoSt&#39;</a> <a id="7333" class="Symbol">.</a><a id="7334" href="Ledger.Utxo.html#5398" class="Field">deposits</a><a id="7342" class="Symbol">)</a> <a id="7344" class="Symbol">(</a><a id="7345" href="Ledger.Certs.html#2255" class="Field">voteDelegs</a> <a id="7356" href="Ledger.Epoch.html#5755" class="Bound">dState</a><a id="7362" class="Symbol">)</a>
           <a id="7375" class="Symbol">;</a> <a id="7377" href="Ledger.Ratify.html#7546" class="Field">treasury</a> <a id="7386" class="Symbol">=</a> <a id="7388" href="Ledger.Epoch.html#2185" class="Generalizable">acnt</a> <a id="7393" class="Symbol">.</a><a id="7394" href="Ledger.PParams.html#1266" class="Field">treasury</a> <a id="7403" class="Symbol">;</a> <a id="7405" href="Ledger.Epoch.html#7405" class="Module">GState</a> <a id="7412" href="Ledger.Epoch.html#5773" class="Bound">gState</a> <a id="7419" class="Symbol">}</a>
        <a id="7429" href="Ledger.Ratify.html#22902" class="Function Operator">⊢</a> <a id="7431" href="Ledger.Ratify.html#7644" class="InductiveConstructor Operator">⟦</a> <a id="7433" href="Ledger.Epoch.html#6305" class="Bound">es</a> <a id="7436" href="Ledger.Ratify.html#7644" class="InductiveConstructor Operator">,</a> <a id="7438" href="Interface.HasEmptySet.html#150" class="Field">∅</a> <a id="7440" href="Ledger.Ratify.html#7644" class="InductiveConstructor Operator">,</a> <a id="7442" href="Agda.Builtin.Bool.html#192" class="InductiveConstructor">false</a> <a id="7448" href="Ledger.Ratify.html#7644" class="InductiveConstructor Operator">⟧ʳ</a> <a id="7451" href="Ledger.Ratify.html#22902" class="Function Operator">⇀⦇</a> <a id="7454" href="Ledger.Epoch.html#6576" class="Bound">govSt&#39;</a> <a id="7461" href="Ledger.Ratify.html#22902" class="Function Operator">,RATIFY⦈</a> <a id="7470" href="Ledger.Epoch.html#2120" class="Generalizable">fut&#39;</a>
      <a id="7481" class="Symbol">→</a> <a id="7483" href="Ledger.Epoch.html#2171" class="Generalizable">ls</a> <a id="7486" href="Ledger.Epoch.html#4392" class="Datatype Operator">⊢</a> <a id="7488" href="Ledger.Epoch.html#2276" class="Generalizable">ss</a> <a id="7491" href="Ledger.Epoch.html#4392" class="Datatype Operator">⇀⦇</a> <a id="7494" href="Agda.Builtin.Unit.html#212" class="InductiveConstructor">tt</a> <a id="7497" href="Ledger.Epoch.html#4392" class="Datatype Operator">,SNAP⦈</a> <a id="7504" href="Ledger.Epoch.html#2279" class="Generalizable">ss&#39;</a>
    <a id="7512" href="Interface.STS.html#350" class="Function Operator">────────────────────────────────</a>
    <a id="7549" class="Symbol">_</a> <a id="7551" href="Ledger.Epoch.html#4689" class="Datatype Operator">⊢</a> <a id="7553" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">⟦</a> <a id="7555" href="Ledger.Epoch.html#2185" class="Generalizable">acnt</a> <a id="7560" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="7562" href="Ledger.Epoch.html#2276" class="Generalizable">ss</a> <a id="7565" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="7567" href="Ledger.Epoch.html#2171" class="Generalizable">ls</a> <a id="7570" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="7572" href="Ledger.Epoch.html#2199" class="Generalizable">es₀</a> <a id="7576" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="7578" href="Ledger.Epoch.html#2116" class="Generalizable">fut</a> <a id="7582" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">⟧ᵉ&#39;</a> <a id="7586" href="Ledger.Epoch.html#4689" class="Datatype Operator">⇀⦇</a> <a id="7589" href="Ledger.Epoch.html#2094" class="Generalizable">e</a> <a id="7591" href="Ledger.Epoch.html#4689" class="Datatype Operator">,EPOCH⦈</a>
        <a id="7607" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">⟦</a> <a id="7609" href="Ledger.Epoch.html#7067" class="Bound">acnt&#39;</a> <a id="7615" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="7617" href="Ledger.Epoch.html#2279" class="Generalizable">ss&#39;</a> <a id="7621" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="7623" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">⟦</a> <a id="7625" href="Ledger.Epoch.html#6951" class="Bound">utxoSt&#39;</a> <a id="7633" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">,</a> <a id="7635" href="Ledger.Epoch.html#6576" class="Bound">govSt&#39;</a> <a id="7642" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">,</a> <a id="7644" href="Ledger.Epoch.html#6646" class="Bound">certState&#39;</a> <a id="7655" href="Ledger.Ledger.html#1044" class="InductiveConstructor Operator">⟧ˡ</a> <a id="7658" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="7660" href="Ledger.Epoch.html#6305" class="Bound">es</a> <a id="7663" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">,</a> <a id="7665" href="Ledger.Epoch.html#2120" class="Generalizable">fut&#39;</a> <a id="7670" href="Ledger.Epoch.html#1473" class="InductiveConstructor Operator">⟧ᵉ&#39;</a>
<a id="7674" class="Markup">\end{code}</a><a id="7684" class="Background">
\end{AgdaMultiCode}
\caption{EPOCH transition system}
\label{fig:epoch:sts}
\end{figure*}

\begin{NoConway}
\begin{figure*}[h]
</a><a id="7812" class="Markup">\begin{code}[hide]</a>
<a id="7831" class="Keyword">data</a>
<a id="7836" class="Markup">\end{code}</a><a id="7846" class="Background">
</a><a id="7847" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,NEWEPOCH⦈_"></a><a id="7862" href="Ledger.Epoch.html#7862" class="Datatype Operator">_⊢_⇀⦇_,NEWEPOCH⦈_</a> <a id="7880" class="Symbol">:</a> <a id="7882" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a> <a id="7884" class="Symbol">→</a> <a id="7886" href="Ledger.Epoch.html#1698" class="Record">NewEpochState</a> <a id="7900" class="Symbol">→</a> <a id="7902" href="Ledger.Types.Epoch.html#335" class="Function">Epoch</a> <a id="7908" class="Symbol">→</a> <a id="7910" href="Ledger.Epoch.html#1698" class="Record">NewEpochState</a> <a id="7924" class="Symbol">→</a> <a id="7926" href="Agda.Primitive.html#388" class="Primitive">Type</a>
<a id="7931" class="Markup">\end{code}</a><a id="7941" class="Background">
</a><a id="7942" class="Markup">\begin{code}[hide]</a>
  <a id="7963" class="Keyword">where</a>
<a id="7969" class="Markup">\end{code}</a><a id="7979" class="Background">
</a><a id="7980" class="Markup">\begin{code}</a>
  <a id="_⊢_⇀⦇_,NEWEPOCH⦈_.NEWEPOCH-New"></a><a id="7995" href="Ledger.Epoch.html#7995" class="InductiveConstructor">NEWEPOCH-New</a> <a id="8008" class="Symbol">:</a> <a id="8010" class="Keyword">let</a>
      <a id="8020" href="Ledger.Epoch.html#8020" class="Bound">eps&#39;</a> <a id="8025" class="Symbol">=</a> <a id="8027" href="Ledger.Epoch.html#2633" class="Function">applyRUpd</a> <a id="8037" href="Ledger.Epoch.html#2297" class="Generalizable">ru</a> <a id="8040" href="Ledger.Epoch.html#2141" class="Generalizable">eps</a>
    <a id="8048" class="Keyword">in</a>
    <a id="8055" href="Interface.STS.html#105" class="Function Operator">∙</a> <a id="8057" href="Ledger.Epoch.html#2094" class="Generalizable">e</a> <a id="8059" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="8061" href="Ledger.Epoch.html#2096" class="Generalizable">lastEpoch</a> <a id="8071" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="8073" class="Number">1</a>
    <a id="8079" href="Interface.STS.html#131" class="Function Operator">∙</a> <a id="8081" class="Symbol">_</a> <a id="8083" href="Ledger.Epoch.html#4689" class="Datatype Operator">⊢</a> <a id="8085" href="Ledger.Epoch.html#8020" class="Bound">eps&#39;</a> <a id="8090" href="Ledger.Epoch.html#4689" class="Datatype Operator">⇀⦇</a> <a id="8093" href="Ledger.Epoch.html#2094" class="Generalizable">e</a> <a id="8095" href="Ledger.Epoch.html#4689" class="Datatype Operator">,EPOCH⦈</a> <a id="8103" href="Ledger.Epoch.html#2150" class="Generalizable">eps&#39;&#39;</a>
      <a id="8115" href="Interface.STS.html#350" class="Function Operator">────────────────────────────────</a>
      <a id="8154" class="Symbol">_</a> <a id="8156" href="Ledger.Epoch.html#7862" class="Datatype Operator">⊢</a> <a id="8158" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">⟦</a> <a id="8160" href="Ledger.Epoch.html#2096" class="Generalizable">lastEpoch</a> <a id="8170" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">,</a> <a id="8172" href="Ledger.Epoch.html#2141" class="Generalizable">eps</a> <a id="8176" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">,</a> <a id="8178" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="8183" href="Ledger.Epoch.html#2297" class="Generalizable">ru</a> <a id="8186" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">⟧ⁿᵉ</a> <a id="8190" href="Ledger.Epoch.html#7862" class="Datatype Operator">⇀⦇</a> <a id="8193" href="Ledger.Epoch.html#2094" class="Generalizable">e</a> <a id="8195" href="Ledger.Epoch.html#7862" class="Datatype Operator">,NEWEPOCH⦈</a> <a id="8206" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">⟦</a> <a id="8208" href="Ledger.Epoch.html#2094" class="Generalizable">e</a> <a id="8210" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">,</a> <a id="8212" href="Ledger.Epoch.html#2150" class="Generalizable">eps&#39;&#39;</a> <a id="8218" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">,</a> <a id="8220" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a> <a id="8228" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">⟧ⁿᵉ</a>

  <a id="_⊢_⇀⦇_,NEWEPOCH⦈_.NEWEPOCH-Not-New"></a><a id="8235" href="Ledger.Epoch.html#8235" class="InductiveConstructor">NEWEPOCH-Not-New</a> <a id="8252" class="Symbol">:</a>
    <a id="8258" href="Interface.STS.html#105" class="Function Operator">∙</a> <a id="8260" href="Ledger.Epoch.html#2094" class="Generalizable">e</a> <a id="8262" href="Relation.Binary.PropositionalEquality.Core.html#858" class="Function Operator">≢</a> <a id="8264" href="Ledger.Epoch.html#2096" class="Generalizable">lastEpoch</a> <a id="8274" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="8276" class="Number">1</a>
      <a id="8284" href="Interface.STS.html#350" class="Function Operator">────────────────────────────────</a>
      <a id="8323" class="Symbol">_</a> <a id="8325" href="Ledger.Epoch.html#7862" class="Datatype Operator">⊢</a> <a id="8327" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">⟦</a> <a id="8329" href="Ledger.Epoch.html#2096" class="Generalizable">lastEpoch</a> <a id="8339" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">,</a> <a id="8341" href="Ledger.Epoch.html#2141" class="Generalizable">eps</a> <a id="8345" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">,</a> <a id="8347" href="Ledger.Epoch.html#2317" class="Generalizable">mru</a> <a id="8351" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">⟧ⁿᵉ</a> <a id="8355" href="Ledger.Epoch.html#7862" class="Datatype Operator">⇀⦇</a> <a id="8358" href="Ledger.Epoch.html#2094" class="Generalizable">e</a> <a id="8360" href="Ledger.Epoch.html#7862" class="Datatype Operator">,NEWEPOCH⦈</a> <a id="8371" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">⟦</a> <a id="8373" href="Ledger.Epoch.html#2096" class="Generalizable">lastEpoch</a> <a id="8383" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">,</a> <a id="8385" href="Ledger.Epoch.html#2141" class="Generalizable">eps</a> <a id="8389" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">,</a> <a id="8391" href="Ledger.Epoch.html#2317" class="Generalizable">mru</a> <a id="8395" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">⟧ⁿᵉ</a>

  <a id="_⊢_⇀⦇_,NEWEPOCH⦈_.NEWEPOCH-No-Reward-Update"></a><a id="8402" href="Ledger.Epoch.html#8402" class="InductiveConstructor">NEWEPOCH-No-Reward-Update</a> <a id="8428" class="Symbol">:</a>
    <a id="8434" href="Interface.STS.html#105" class="Function Operator">∙</a> <a id="8436" href="Ledger.Epoch.html#2094" class="Generalizable">e</a> <a id="8438" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="8440" href="Ledger.Epoch.html#2096" class="Generalizable">lastEpoch</a> <a id="8450" href="Interface.HasAdd.html#135" class="Field Operator">+</a> <a id="8452" class="Number">1</a>
    <a id="8458" href="Interface.STS.html#131" class="Function Operator">∙</a> <a id="8460" class="Symbol">_</a> <a id="8462" href="Ledger.Epoch.html#4689" class="Datatype Operator">⊢</a> <a id="8464" href="Ledger.Epoch.html#2141" class="Generalizable">eps</a> <a id="8468" href="Ledger.Epoch.html#4689" class="Datatype Operator">⇀⦇</a> <a id="8471" href="Ledger.Epoch.html#2094" class="Generalizable">e</a> <a id="8473" href="Ledger.Epoch.html#4689" class="Datatype Operator">,EPOCH⦈</a> <a id="8481" href="Ledger.Epoch.html#2145" class="Generalizable">eps&#39;</a>
      <a id="8492" href="Interface.STS.html#350" class="Function Operator">────────────────────────────────</a>
      <a id="8531" class="Symbol">_</a> <a id="8533" href="Ledger.Epoch.html#7862" class="Datatype Operator">⊢</a> <a id="8535" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">⟦</a> <a id="8537" href="Ledger.Epoch.html#2096" class="Generalizable">lastEpoch</a> <a id="8547" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">,</a> <a id="8549" href="Ledger.Epoch.html#2141" class="Generalizable">eps</a> <a id="8553" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">,</a> <a id="8555" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a> <a id="8563" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">⟧ⁿᵉ</a> <a id="8567" href="Ledger.Epoch.html#7862" class="Datatype Operator">⇀⦇</a> <a id="8570" href="Ledger.Epoch.html#2094" class="Generalizable">e</a> <a id="8572" href="Ledger.Epoch.html#7862" class="Datatype Operator">,NEWEPOCH⦈</a> <a id="8583" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">⟦</a> <a id="8585" href="Ledger.Epoch.html#2094" class="Generalizable">e</a> <a id="8587" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">,</a> <a id="8589" href="Ledger.Epoch.html#2145" class="Generalizable">eps&#39;</a> <a id="8594" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">,</a> <a id="8596" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a> <a id="8604" href="Ledger.Epoch.html#1769" class="InductiveConstructor Operator">⟧ⁿᵉ</a>
<a id="8608" class="Markup">\end{code}</a><a id="8618" class="Background">
\caption{NEWEPOCH transition system}
\end{figure*}
\end{NoConway}
</a></pre></body></html>