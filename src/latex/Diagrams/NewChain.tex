\begin{figure}
  \centering
  \begin{tikzpicture} [
    conway/.style = {draw, fill=white, minimum size=1cm, align=right, fill=\ConwayColor},
    shelley/.style = {draw, fill=white, minimum size=1cm, align=right, fill=\ShelleyColor},
    babbage/.style = {draw, minimum size=1cm, align=right, fill=\BabbageColor},
    dcs/.style = {double copy shadow, shadow xshift=2pt, shadow yshift=-2pt},
    every edge/.style={draw, ->, >=Latex, semithick},
    dotted edge/.style={draw, ->, >=Latex, dotted, semithick}
    ]

  %%% CHAIN %%%
  \node[shelley] (chain) {\small CHAIN};
    % text labels
    %% \node  [above right =-4mm and 1mm of chain] {\footnotesize ()};
    %% \node  [right =1mm of chain] {\footnotesize NewEpochState};
    %% \node  [below right =-4mm and 1mm of chain] {\footnotesize EpochNo};

  %%% ApplyBlock (TOP) %%%
  %% \node (applyblock) [above =5mm of chain] {\small ApplyBlock.applyChainOpts};

  %%% NEWEPOCH %%%
  \node[conway] (newepoch) [below left =5mm and 2cm of chain]   {\small NEWEPOCH}; % {\textcolor{white}
    % text labels
    %% \node  [above right =-4mm and 1mm of newepoch] {\footnotesize ()};
    %% \node  [right =1mm of newepoch] {\footnotesize NewEpochState};
    %% \node  [below right =-4mm and 1mm of newepoch] {\footnotesize EpochNo};

  %%% RUPD %%%
  \node[shelley] (rupd)     [below = of chain]  {\small RUPD};
  %% \node[shelley] (rupd)     [below right =1cm and 1cm of chain]  {\small RUPD};
    % text labels
    %% \node  [above right =-4mm and 1mm of rupd] {\footnotesize RupdEnv};
    %% \node  [right =1mm of rupd] {\footnotesize Maybe (PulsingRewardUpdate)};
    %% \node  [below right =-4mm and 1mm of rupd] {\footnotesize SlotNo};

  %%% EPOCH %%%
  \node[conway] (epoch)    [below = of newepoch]    {\small EPOCH};
    % text labels
    %% \node  [above right =-4mm and 1mm of epoch] {\footnotesize ()};
    %% \node  [right =1mm of epoch] {\footnotesize EpochState};
    %% \node  [below right =-4mm and 1mm of epoch] {\footnotesize EpochNo};

  %%% SNAP %%%
  \node[shelley] (snap)     [below right = of epoch]  {\small SNAP};
    % text labels
    %% \node  [above right =-4mm and 1mm of snap] {\footnotesize SnapShots};
    %% \node  [right =1mm of snap] {\footnotesize SnapEnv};
    %% \node  [below right =-4mm and 1mm of snap] {\footnotesize ()};

  %%% POOLREAP %%%
  \node[shelley] (poolreap) [below = of epoch]       {\small POOLREAP};
    % text labels
    %% \node  [above right =-4mm and 1mm of poolreap] {\footnotesize Pparams};
    %% \node  [right =1mm of poolreap] {\footnotesize ShelleyPoolreapState};
    %% \node  [below right =-4mm and 1mm of poolreap] {\footnotesize EpochNo};

  %%% RATIFY %%%
  \node[conway] (ratify)   [below left = of epoch] {\small RATIFY};
    % text labels
    %% \node  [above right =-4mm and 1mm of ratify] {\footnotesize RatifyEnv};
    %% \node  [right =1mm of ratify] {\footnotesize RatifyState};
    %% \node  [below right =-4mm and 1mm of ratify] {\footnotesize RatifySignal};

  %%% ENACT %%%
  \node[conway] (enact)    [below = of ratify]      {\small ENACT};
    % text labels
    %% \node  [above right =-4mm and 1mm of enact] {\footnotesize ()};
    %% \node  [right =1mm of enact] {\footnotesize EnactState};
    %% \node  [below right =-4mm and 1mm of enact] {\footnotesize GovAction};

  \draw
  (chain)       edge             (newepoch)
  (chain)       edge             (rupd)
  %% (applyblock) edge             (chain)
  %% (newepoch)   edge [bend left] (chain)
  (newepoch)   edge             (epoch)
  %% (rupd)       edge [bend left] (chain)
  (epoch)      edge             (snap)
  (epoch)      edge             (poolreap)
  (epoch)      edge             (ratify)
  (ratify)     edge             (enact);

  \draw [dotted edge]
  (epoch)      edge [bend left] (newepoch)
  (snap)       edge [bend right] (epoch)
  (poolreap)   edge [bend left] (epoch)
  (ratify)     edge [bend left] (epoch)
  (enact)      edge [bend left] (ratify);

  % LEVEL 1 (TOP)
  \node[conway] (ledgers) [below right =5mm and 2cm of chain] {\small LEDGERS};
  %% \node (applytx) [above =5mm of ledger] {\small ApplyTx};

  % LEVEL 0 (TOP)
  \node[conway, dcs] (ledger) [below =of ledgers] {\small LEDGER};
  %% \node (applytx) [above =5mm of ledger] {\small ApplyTx};

  % LEVEL -1
  \node[conway] (certs) [below left =of ledger] {\small CERTS};
  \node[conway] (gov) [below      =of ledger] {\small GOV};
  \node[conway] (utxow) [below right=of ledger] {\small UTXOW};

  % LEVEL -2
  \node[conway, dcs] (cert) [below =of certs] {\small CERT};
  \node[babbage]     (utxo) [below =of utxow] {\small UTXO};

  % LEVEL -3 %1cm and 0mm
  \node[conway]  (deleg)   [below left =5mm and 5mm of cert] {\small DELEG};
  \node[shelley] (pool)    [below      =15mm        of cert] {\small POOL};
  \node[conway]  (govcert) [below right=5mm and 5mm of cert] {\small GOVCERT};
  \node[conway]  (utxos)   [below      =            of utxo] {\small UTXOS};

  % Edges
  \draw
  (chain)   edge              (ledgers)
  (ledgers) edge              (ledger)
  (ledger)  edge              (certs)
  %% (ledger)  edge [bend right] (gov)
  (ledger)  edge              (gov)
  (ledger)  edge              (utxow)
  %% (certs)   edge [bend right] (cert)
  (certs)   edge              (cert)
  (cert)    edge              (deleg)
  %% (cert)    edge [bend right] (pool)
  (cert)    edge              (pool)
  (cert)    edge              (govcert)
  %% (utxow)   edge [bend right] (utxo)
  (utxow)   edge              (utxo)
  %% (utxo)    edge [bend right] (utxos);
  (utxo)    edge              (utxos);


  \draw [dotted edge]
  (certs)   edge [bend left]  (ledger)
  (gov)     edge [bend right] (ledger)
  (utxow)   edge [bend right] (ledger)

  (cert)    edge [bend right] (certs)
  (utxo)    edge [bend right] (utxow)

  (deleg)   edge [bend left]  (cert)
  (pool)    edge [bend right] (cert)
  (govcert) edge [bend right] (cert)
  (utxos)   edge [bend right] (utxo);

  %% \draw[semithick,->, -Stealth] (cert) to [looseness=8, out=50,in=15] (cert);

  \end{tikzpicture}
  \caption{State transition systems of the latest blockchain ledger version.
  Each node represents a transition rule, with \textbf{solid arrows} indicating
  sub-rule inclusion (i.e., the source rule applies the target rule as part of its
  definition); \textbf{dotted arrows} represent dependencies where the target rule's
  output is used in the source ruleâ€™s input, state, or environment. Recursive rules
  such as LEDGERS and CERTS apply their sub-rules repeatedly over lists of transactions
  or certificates
    (\legendbox{\ShelleyColor}~Shelley,
     \legendbox{\ConwayColor}~Conway,
     \legendbox{\BabbageColor}~Babbage)}
  \label{fig:new-chain-diagram}

\end{figure}
